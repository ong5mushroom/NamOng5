import { auth, db, ROOT_PATH } from './config.js';
import { signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { UI } from './ui.js';
import { Logic } from './logic.js';

// State quản lý toàn bộ dữ liệu App
const AppState = {
    user: JSON.parse(localStorage.getItem('n5_modular_user')) || null,
    data: { employees: [], houses: [], harvest: [] } // ... thêm các mảng khác
};

// Khởi động App
async function initApp() {
    // 1. Đăng nhập ẩn danh vào Firebase
    try {
        await signInAnonymously(auth);
        console.log("Connected to Firebase");
        startSync(); // Bắt đầu lắng nghe dữ liệu
    } catch (e) {
        alert("Lỗi kết nối: " + e.message);
    }
}

// Hàm đồng bộ dữ liệu Realtime
function startSync() {
    // Lấy nhân viên
    onSnapshot(collection(db, `${ROOT_PATH}/employees`), (snapshot) => {
        AppState.data.employees = snapshot.docs.map(d => ({...d.data(), _id: d.id}));
        UI.renderEmployeeOptions(AppState.data.employees);
        if (AppState.user) UI.renderHome(AppState.data.houses, AppState.data.harvest, AppState.data.employees);
    });

    // Lấy nhà nấm
    onSnapshot(collection(db, `${ROOT_PATH}/houses`), (s) => {
        AppState.data.houses = s.docs.map(d => ({...d.data(), _id: d.id}));
        if (AppState.user) UI.renderHome(AppState.data.houses, AppState.data.harvest, AppState.data.employees);
    });

    // ... Lấy thêm các collection khác (harvest_logs, tasks...) tương tự
}

// Xử lý sự kiện (Event Listeners)
document.getElementById('login-btn').addEventListener('click', () => {
    const id = document.getElementById('login-user').value;
    const pin = document.getElementById('login-pin').value;
    const emp = AppState.data.employees.find(e => String(e.id) == id && String(e.pin) == pin);
    
    if (emp) {
        AppState.user = emp;
        localStorage.setItem('n5_modular_user', JSON.stringify(emp));
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('head-user').innerText = emp.name;
        document.getElementById('head-role').innerText = emp.role;
        
        // Mặc định vào tab Home
        UI.renderHome(AppState.data.houses, [], AppState.data.employees);
        document.getElementById('view-home').classList.remove('hidden');
    } else {
        UI.showMsg("Sai mã PIN!");
    }
});

// Tab Navigation
document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        if(tab) UI.switchTab(tab, AppState.user.role, AppState.user.team);
    });
});

// Chạy App
window.onload = initApp;