<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fbConfig = { apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", authDomain: "ong5mushroom-vietnam.firebaseapp.com", projectId: "ong5mushroom-vietnam", storageBucket: "ong5mushroom-vietnam.firebasestorage.app", messagingSenderId: "931399604992", appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" };
        const appInstance = initializeApp(fbConfig);
        const db = getFirestore(appInstance);
        const ROOT = "artifacts/namong5_production/public/data";

        window.app = {
            data: { employees: [], houses: [], chat: [], tasks: [], production: [], harvest: [], hr_requests: [], sop: [] }, // Th√™m sop v√†o ƒë√¢y
            user: JSON.parse(localStorage.getItem('n5_v75_user')) || null,
            assignMode: 'ind',

            ui: {
                show: (id) => document.getElementById(id).classList.remove('hidden'),
                hide: (id) => document.getElementById(id).classList.add('hidden'),
                tab: (id) => {
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                    document.getElementById('tab-'+id).classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
                    event.currentTarget.classList.add('nav-active');
                    const backBtn = document.getElementById('back-home-btn');
                    if(id==='chat') { 
                        setTimeout(() => document.getElementById('chat-box').scrollTop = 9999, 200);
                        if(backBtn) backBtn.classList.remove('hidden');
                    } else {
                        if(backBtn) backBtn.classList.add('hidden');
                    }
                },
                setSXMode: (mode) => {
                    document.getElementById('sx-action').value = mode;
                    const btnNhap = document.getElementById('btn-sx-nhap');
                    const btnXuat = document.getElementById('btn-sx-xuat');
                    if(mode === 'NH·∫¨P') {
                        btnNhap.className = "flex-1 py-2 rounded-lg text-xs font-black bg-blue-600 text-white shadow-md transition";
                        btnXuat.className = "flex-1 py-2 rounded-lg text-xs font-black text-slate-400 hover:bg-white transition";
                    } else {
                        btnXuat.className = "flex-1 py-2 rounded-lg text-xs font-black bg-orange-500 text-white shadow-md transition";
                        btnNhap.className = "flex-1 py-2 rounded-lg text-xs font-black text-slate-400 hover:bg-white transition";
                    }
                },
                toggleMode: () => {
                    app.assignMode = document.getElementById('assign-mode').value;
                    document.getElementById('ind-zone').classList.toggle('hidden', app.assignMode !== 'ind');
                    document.getElementById('team-zone').classList.toggle('hidden', app.assignMode !== 'team');
                },
                calcTotal: () => {
                    const ids = ['th-b2','th-a1','th-a2','th-b1','th-d1','th-ht','th-abf','th-b2f','th-b1f'];
                    let sum = 0; let html = '';
                    ids.forEach(id => { const val = Number(document.getElementById(id).value) || 0; sum += val; });
                    if (sum > 0) ids.forEach(id => { const val = Number(document.getElementById(id).value) || 0; if(val>0) html += `<div class="stat-badge">${id.replace('th-','').toUpperCase()}: ${((val/sum)*100).toFixed(0)}%</div>`; });
                    document.getElementById('th-total-display').innerText = sum + ' kg';
                    document.getElementById('th-percent-display').innerHTML = html;
                }
            },

            init: () => {
                const statusDot = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                signInAnonymously(getAuth(appInstance)).then(() => {
                    statusDot.classList.replace('status-loading', 'status-ready'); // S·ª≠a t√™n class cho ƒë√∫ng CSS
                    statusText.innerText = "ƒê√£ k·∫øt n·ªëi";
                    app.sync();
                }).catch(e => {
                     statusDot.classList.replace('status-loading', 'status-error');
                     statusText.innerText = "L·ªói k·∫øt n·ªëi!";
                     statusText.classList.add('text-red-500');
                });
                if(document.getElementById('sx-date')) document.getElementById('sx-date').valueAsDate = new Date();
            },

            sync: () => {
                const sub = (c, k) => onSnapshot(collection(db, `${ROOT}/${c}`), s => { 
                    app.data[k] = s.docs.map(d => ({...d.data(), _id: d.id})); 
                    app.renderDynamic();
                    if(c==='employees') app.renderLoginSelect();
                    if(c==='hr_requests') app.renderHR();
                });
                // ƒê√£ th√™m 'sop' v√†o ƒë√¢y
                ['employees', 'houses', 'tasks', 'production_logs', 'harvest_logs', 'hr_requests', 'sop'].forEach(x => sub(x, x.includes('logs') ? x.split('_')[0] : x));
                
                onSnapshot(query(collection(db, `${ROOT}/chat`), orderBy("time", "asc"), limit(50)), s => {
                    app.data.chat = s.docs.map(d => d.data());
                    app.renderChat();
                });
            },

            renderLoginSelect: () => {
                const s = document.getElementById('user-select');
                const btn = document.getElementById('btn-login');
                const pin = document.getElementById('user-pin');
                if (app.data.employees && app.data.employees.length > 0) {
                    s.innerHTML = '<option value="">-- Ch·ªçn t√™n c·ªßa b·∫°n --</option>' + 
                        app.data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                    s.disabled = false;
                    pin.disabled = false;
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    document.getElementById('status-text').innerText = "S·∫µn s√†ng";
                } else {
                    s.innerHTML = '<option>Kh√¥ng c√≥ d·ªØ li·ªáu</option>';
                }
            },

            doLogin: () => {
                const id = document.getElementById('user-select').value;
                const pin = document.getElementById('user-pin').value.trim();
                if(!id || !pin) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
                
                const emp = app.data.employees.find(e => String(e.id) === String(id) && String(e.pin).trim() === String(pin));
                
                if(emp) {
                    app.user = emp;
                    localStorage.setItem('n5_v75_user', JSON.stringify(emp));
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-body').classList.remove('hidden');
                    app.render();
                } else alert("M√£ PIN kh√¥ng ƒë√∫ng!");
            },

            render: () => {
                if(!app.user) { app.renderLoginSelect(); document.getElementById('login-screen').classList.remove('hidden'); return; }
                
                document.getElementById('ui-user').innerText = app.user.name;
                document.getElementById('ui-role').innerText = app.user.role;
                
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role);
                if(isAdmin) {
                    document.getElementById('btn-export-sx').classList.remove('hidden');
                    document.getElementById('btn-export-th').classList.remove('hidden');
                    document.getElementById('admin-cog').classList.remove('hidden');
                    document.getElementById('admin-form').classList.remove('hidden');
                    document.getElementById('admin-tools-group').classList.remove('hidden');
                    document.getElementById('btn-hr-approve').classList.remove('hidden');
                    app.renderAdminTools();
                }
                app.renderDynamic();
            },
            
            renderDynamic: () => {
                const houseOpts = app.data.houses.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
                const hSelect = document.getElementById('th-area');
                if(hSelect.innerHTML === "") hSelect.innerHTML = houseOpts;
                
                // ƒê√£ x√≥a ph·∫ßn g√°n task-house-id g√¢y l·ªói
                
                const houseMulti = document.getElementById('multi-house-zone');
                if(houseMulti && houseMulti.innerHTML === "") houseMulti.innerHTML = app.data.houses.map(h => `<label class="flex items-center gap-2 text-xs"><input type="checkbox" name="assign-house" value="${h.name}" class="w-4 h-4"> ${h.name}</label>`).join('');
                
                // House Grid
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user?.role);
                document.getElementById('house-grid').innerHTML = app.data.houses.map(h => `
                    <div class="glass-card p-4 flex justify-between items-center border border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-black text-xs">${h.name.substring(0,2)}</div>
                            <div><p class="font-black text-xs">${h.name}</p><p class="text-[9px] text-slate-400 font-bold uppercase mt-0.5">S: ${h.temp?.am||'-'}¬∞ | C: ${h.temp?.pm||'-'}¬∞</p></div>
                        </div>
                        <button onclick="app.actions.openTemp('${h._id}','${h.name}')" class="text-orange-500 bg-orange-50 w-9 h-9 rounded-xl flex items-center justify-center"><i class="fas fa-thermometer-half"></i></button>
                    </div>`).join('');

                // Task List Grouped
                let tasks = (app.data.tasks || []).filter(t => t.status !== 'completed');
                if(!isAdmin) tasks = tasks.filter(t => t.assignee == app.user.id);
                
                const groups = {};
                tasks.forEach(t => { if(!groups[t.assignee]) groups[t.assignee] = []; groups[t.assignee].push(t); });
                
                document.getElementById('task-list').innerHTML = Object.keys(groups).map(k => {
                     const worker = app.data.employees.find(e => String(e.id) === String(k))?.name || k;
                     const items = groups[k].map(t => `<div class="p-2 bg-slate-50 rounded mb-1 text-xs border flex justify-between"><span>${t.title} (${t.houseId})</span>${isAdmin ? `<button onclick="app.actions.deleteTask('${t._id}')" class="text-red-500"><i class="fas fa-trash"></i></button>` : ''}</div>`).join('');
                     return `<div class="glass-card p-4 border-l-4 border-blue-600 mb-3"><p class="text-[10px] text-blue-600 font-bold uppercase mb-2">${worker}</p>${items}</div>`;
                }).join('');
                
                // Logs
                const sxList = app.data.production.sort((a,b) => b.time - a.time).slice(0, 10);
                document.getElementById('sx-list').innerHTML = sxList.map(i => `<div class="bg-white p-3 rounded-xl border border-slate-100 text-xs flex justify-between"><div><span class="font-bold text-blue-600">${i.action}</span> ${i.type}</div><div class="font-black">${i.qty}</div></div>`).join('');
                
                const thList = app.data.harvest.sort((a,b) => b.time - a.time).slice(0, 10);
                document.getElementById('th-list').innerHTML = thList.map(i => `<div class="bg-white p-3 rounded-xl border border-slate-100 text-xs flex justify-between"><div><span class="font-bold text-green-600">${i.area}</span> ${new Date(i.time).toLocaleDateString()}</div><div class="font-black">${i.total} kg</div></div>`).join('');

                // Stats & Leaderboard
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('stat-online').innerText = app.data.employees.filter(e => e.lastLogin === today).length;
                const todayYield = app.data.harvest.filter(h => new Date(h.time).toDateString() === new Date().toDateString()).reduce((a,b) => a + b.total, 0);
                document.getElementById('stat-yield').innerText = todayYield.toLocaleString() + ' kg';
                
                const top = [...app.data.employees].sort((a,b) => (b.score||0) - (a.score||0)).slice(0, 3);
                document.getElementById('leaderboard-list').innerHTML = top.map((p, i) => `<div class="flex justify-between items-center bg-yellow-50 p-2 rounded-lg border border-yellow-100 mb-1"><div class="flex items-center gap-2"><span class="font-black text-[10px] text-yellow-600">#${i+1}</span><span class="text-xs font-bold text-slate-700">${p.name}</span></div><span class="font-black text-yellow-600 text-xs">${p.score || 0}ƒë</span></div>`).join('');
            },
            
            renderChat: () => {
                const c = document.getElementById('chat-box');
                c.innerHTML = app.data.chat.map(m => `
                    <div class="chat-bubble ${m.senderId==app.user.id?'me':'other'}">
                        <p class="font-bold text-[9px] opacity-50 mb-1">${m.senderName||'User'}</p>
                        ${m.text}
                        <div class="flex gap-2 mt-1">
                            <span class="cursor-pointer text-xs">‚ù§Ô∏è</span>
                            <span class="cursor-pointer text-xs">üëç</span>
                        </div>
                    </div>`).join('');
                c.scrollTop = c.scrollHeight;
            },
            
            renderHR: () => {
                 const list = document.getElementById('hr-list');
                 list.innerHTML = app.data.hr_requests.filter(r => r.status === 'pending').map(r => `
                    <div class="bg-slate-50 p-2 rounded border text-xs mb-2">
                        <p class="font-bold text-blue-600">${r.type === 'LEAVE' ? 'Xin Ngh·ªâ' : 'Mua H√†ng'} - ${r.requester}</p>
                        <p class="my-1">${r.content}</p>
                        <div class="flex gap-2"><button onclick="app.actions.approveHR('${r._id}', 'approved')" class="bg-green-100 text-green-700 px-2 py-1 rounded">Duy·ªát</button><button onclick="app.actions.approveHR('${r._id}', 'rejected')" class="bg-red-100 text-red-700 px-2 py-1 rounded">T·ª´ ch·ªëi</button></div>
                    </div>
                 `).join('');
                 if(app.data.hr_requests.filter(r => r.status === 'pending').length === 0) list.innerHTML = '<p class="text-center text-xs text-slate-400">Kh√¥ng c√≥ y√™u c·∫ßu</p>';
            },

            renderAdminTools: () => {
                 const ind = document.getElementById('ind-zone');
                 if(ind && ind.innerHTML === "") ind.innerHTML = app.data.employees.map(e => `<label class="flex items-center gap-2 p-2"><input type="checkbox" name="assign-check" value="${e.id}"> <span class="text-xs font-bold">${e.name}</span></label>`).join('');
                 const dl = document.getElementById('sop-list');
                 if(dl && app.data.sop) dl.innerHTML = app.data.sop.map(s => `<option value="${s.title}">`).join('');
            },

            actions: {
                submitSX: async () => {
                     const action = document.getElementById('sx-action').value; // S·ª≠a l·ªói l·∫•y action t·ª´ input hidden
                    const data = { action, date: document.getElementById('sx-date').value, type: document.getElementById('sx-type').value, qty: Number(document.getElementById('sx-qty').value), batch: document.getElementById('sx-batch').value, destination: document.getElementById('sx-note').value, user: app.user.name, time: Date.now(), bad: Number(document.getElementById('sx-bad').value)||0, reuse: Number(document.getElementById('sx-reuse').value)||0 };
                    await addDoc(collection(db, `${ROOT}/production_logs`), data); alert("ƒê√£ l∆∞u!");
                },
                submitTH: async () => {
                    const details = { B2: Number(document.getElementById('th-b2').value), A1: Number(document.getElementById('th-a1').value), A2: Number(document.getElementById('th-a2').value), B1: Number(document.getElementById('th-b1').value), D1: Number(document.getElementById('th-d1').value), HT: Number(document.getElementById('th-ht').value), ABF: Number(document.getElementById('th-abf').value), B2F: Number(document.getElementById('th-b2f').value), B1F: Number(document.getElementById('th-b1f').value) };
                    const total = Object.values(details).reduce((a,b) => a+b, 0);
                    // ƒê√£ s·ª≠a 'th-note' th√†nh string r·ªóng ho·∫∑c b·∫°n c·∫ßn th√™m input v√†o HTML
                    await addDoc(collection(db, `${ROOT}/harvest_logs`), { area: document.getElementById('th-area').value, details, total, user: app.user.name, time: Date.now(), note: '', note_err: document.getElementById('th-note-err').value, note_snack: document.getElementById('th-note-snack').value }); alert("ƒê√£ l∆∞u!");
                },
                sendChat: async () => {
                    const txt = document.getElementById('chat-input').value;
                    if(!txt) return;
                    await addDoc(collection(db, `${ROOT}/chat`), { text: txt, senderId: app.user.id, senderName: app.user.name, time: Date.now() });
                    document.getElementById('chat-input').value =
