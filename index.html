<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>NẤM ÔNG 5 – V75 FINAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Arial; background:#f5f5f5; padding:10px }
    h2,h3 { margin: 8px 0 }
    input,select,button {
      padding:8px; margin:4px 0; width:100%;
      font-size:16px;
    }
    button { background:#2e7d32; color:white; border:none }
    .box { background:white; padding:12px; margin-bottom:12px; border-radius:6px }
  </style>
</head>
<body>
<div id="root"></div>

<script>
/* ================= FIREBASE CONFIG ================= */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ================= REACT APP ================= */
const { useState, useEffect } = React;

function App() {
  const [user, setUser] = useState(null);

  useEffect(() => {
    auth.onAuthStateChanged(setUser);
  }, []);

  if (!user) {
    return (
      <div className="box">
        <h2>NẤM ÔNG 5</h2>
        <button onclick="firebase.auth().signInAnonymously()">Đăng nhập</button>
      </div>
    );
  }

  return (
    <div>
      <h3>V75 FINAL</h3>
      <Production user={user} />
      <Harvest user={user} />
    </div>
  );
}

/* ================= SẢN XUẤT ================= */
function Production({ user }) {
  const submit = async (e) => {
    e.preventDefault();
    const f = e.target;
    await db.collection("production_logs").add({
      date: f.date.value,
      action: f.action.value,
      material: f.material.value,
      quantity: Number(f.qty.value),
      batch: f.batch.value,
      location: f.loc.value,
      destroy: Number(f.destroy.value || 0),
      reuse: Number(f.reuse.value || 0),
      userId: user.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    f.reset();
    alert("Đã lưu sản xuất");
  };

  return (
    <div className="box">
      <h3>SẢN XUẤT</h3>
      <form onSubmit={submit}>
        <input type="date" name="date" required />
        <select name="action">
          <option value="IN">Nhập kho</option>
          <option value="OUT">Xuất kho</option>
        </select>
        <input name="material" placeholder="Loại phôi" required />
        <input name="qty" type="number" placeholder="Số lượng" required />
        <input name="batch" placeholder="Lô cấy" />
        <input name="loc" placeholder="Nhà" />
        <input name="destroy" placeholder="Số hủy" />
        <input name="reuse" placeholder="Số tận dụng" />
        <button>Lưu</button>
      </form>
    </div>
  );
}

/* ================= THU HOẠCH ================= */
function Harvest({ user }) {
  const FIELDS = [
    "B2","A1","A2","B1","D1","HAU_THU",
    "AB_F","B2_F","B1_F","TRA","LOI",
    "HAO_HUT","XUAT_SAY","HUY_CHAN",
    "NL_SNACK","SNACK_TP"
  ];

  const [data, setData] = useState({});
  const total = Object.values(data).reduce((a,b)=>a+Number(b||0),0);

  const save = async () => {
    await db.collection("harvest_logs").add({
      date: new Date().toISOString().slice(0,10),
      house: "Nhà",
      items: data,
      total,
      userId: user.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    setData({});
    alert("Đã lưu thu hoạch");
  };

  return (
    <div className="box">
      <h3>THU HOẠCH</h3>
      {FIELDS.map(f => (
        <input key={f}
          placeholder={f}
          type="number"
          value={data[f] || ""}
          onChange={e => setData({...data, [f]: e.target.value})}
        />
      ))}
      <b>TỔNG: {total}</b>
      <button onclick={save}>Lưu</button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
