<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <title>N·∫•m √îng 5 V92 - Final Perfect</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --blue: #2563eb; --header: 60px; --nav: 70px; --bg: #f8fafc; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #334155; margin: 0; height: 100vh; overflow: hidden; user-select: none; }
        
        /* Layout */
        #header { height: var(--header); background: white; border-bottom: 1px solid #e2e8f0; position: fixed; top: 0; width: 100%; z-index: 50; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; padding-top: env(safe-area-inset-top); }
        #main { position: fixed; top: var(--header); bottom: var(--nav); left: 0; right: 0; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }
        #nav { height: var(--nav); background: white; border-top: 1px solid #e2e8f0; position: fixed; bottom: 0; width: 100%; z-index: 50; display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        
        /* Components */
        .hidden { display: none !important; }
        .card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .input { width: 100%; background: #f1f5f9; border: 1px solid #cbd5e1; padding: 12px; border-radius: 12px; font-weight: 600; outline: none; font-size: 14px; }
        .btn { width: 100%; padding: 12px; border-radius: 12px; font-weight: 700; text-transform: uppercase; font-size: 12px; text-align: center; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: #16a34a; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .btn-white { background: white; border: 1px solid #e2e8f0; color: #475569; }
        .label { display: block; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
        .nav-item { color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 2px; font-size: 9px; font-weight: 700; }
        .nav-item.active { color: var(--blue); } .nav-item i { font-size: 20px; }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; transition: opacity 0.3s; }
        
        /* Chat */
        #chat-screen { position: fixed; inset: 0; background: #e5ddd5; z-index: 2000; display: none; flex-direction: column; }
        #chat-box { flex: 1; overflow-y: auto; padding: 16px; }
        .chat-msg { max-width: 80%; padding: 10px; border-radius: 12px; margin-bottom: 8px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .me { background: #dcf8c6; align-self: flex-end; }
        .other { background: white; align-self: flex-start; }

        /* Matrix Input */
        .matrix-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 8px; }
        .matrix-grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .input-mini { text-align: center; padding: 8px 2px; font-size: 13px; }
        
        /* Modal */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 16px; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 100%; max-width: 380px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; }
        
        .stat-tag { font-size: 9px; padding: 2px 5px; background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; border-radius: 4px; display: inline-block; margin: 2px; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="w-24 h-24 bg-blue-600 rounded-2xl flex items-center justify-center text-white text-5xl font-bold mb-6 shadow-lg">5</div>
        <h1 class="text-2xl font-black text-slate-800 mb-8">N·∫•m √îng 5 <span class="text-blue-600">V92</span></h1>
        <div id="login-status" class="text-xs font-bold text-slate-400 mb-4 animate-pulse">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</div>
        <div class="w-full max-w-xs space-y-4">
            <select id="login-user" class="input text-center" disabled><option>...</option></select>
            <input id="login-pin" type="tel" placeholder="Nh·∫≠p PIN" class="input text-center text-xl tracking-widest" disabled>
            <button id="login-btn" onclick="app.doLogin()" class="btn btn-blue opacity-50" disabled>ƒêƒÇNG NH·∫¨P</button>
            <button id="rescue-btn" onclick="app.seedAdmin()" class="hidden w-full border border-red-200 text-red-500 py-2 rounded font-bold text-xs mt-4">KH·ªûI T·∫†O ADMIN</button>
        </div>
        <div class="mt-8 text-xs text-slate-400 underline cursor-pointer" onclick="localStorage.clear(); location.reload()">Reset ·ª®ng D·ª•ng</div>
    </div>

    <!-- HEADER -->
    <header id="header">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">5</div>
            <span class="font-bold text-slate-800">Final Perfect</span>
        </div>
        <div class="flex items-center gap-2">
            <span id="u-name" class="text-xs font-bold text-slate-500">...</span>
            <button onclick="app.toggle('settings-modal')" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center"><i class="fas fa-cog text-slate-500"></i></button>
        </div>
    </header>

    <!-- MAIN -->
    <main id="main">
        <!-- TAB HOME -->
        <div id="tab-home">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="card text-center !py-4 !mb-0 border-l-4 border-blue-500">
                    <p class="label">Nh√¢n s·ª±</p><p class="text-2xl font-bold text-blue-600" id="stat-online">0</p>
                </div>
                <div class="card text-center !py-4 !mb-0 border-l-4 border-green-500">
                    <p class="label">T·ªïng H√°i</p><p class="text-2xl font-bold text-green-600" id="stat-yield">0</p>
                </div>
            </div>
            <div class="card !p-3 border border-yellow-100 mb-4">
                <h3 class="text-xs font-bold text-yellow-600 mb-2"><i class="fas fa-crown"></i> B·∫£ng V√†ng</h3>
                <div id="leaderboard" class="space-y-2 text-xs"></div>
            </div>
            <div class="flex justify-between items-center mb-2 px-1">
                <h3 class="text-xs font-bold text-slate-500 uppercase">NH√Ä TR·ªíNG</h3>
            </div>
            <div id="house-list" class="space-y-3"></div>
        </div>

        <!-- TAB VI·ªÜC -->
        <div id="tab-tasks" class="hidden">
            <div id="admin-assign" class="hidden card border border-blue-100">
                <div class="flex justify-between mb-3"><span class="text-xs font-bold text-blue-600 uppercase">GIAO VI·ªÜC M·ªöI</span><select id="assign-mode" onchange="app.toggleAssign()" class="text-[10px] bg-slate-100 p-1 rounded font-bold"><option value="ind">C√° nh√¢n</option><option value="team">T·ªï</option></select></div>
                <div class="space-y-3">
                    <input id="t-title" placeholder="T√™n vi·ªác..." class="input" list="sop-list" onchange="app.fillSOP()">
                    <datalist id="sop-list"></datalist>
                    <div><p class="label">Ch·ªçn Nh√†</p><div id="house-multi" class="grid grid-cols-3 gap-2 bg-slate-50 p-2 rounded border max-h-24 overflow-y-auto"></div></div>
                    <div><p class="label">ƒê·ªãnh m·ª©c</p><input type="number" id="t-target" class="input"></div>
                    <div id="assign-ind" class="max-h-32 overflow-y-auto border p-2 rounded bg-slate-50 grid grid-cols-2 gap-1"></div>
                    <div id="assign-team" class="hidden text-xs font-bold space-y-2 p-2"><label class="flex gap-2"><input type="radio" name="team" value="T·ªï S·∫£n Xu·∫•t" checked> T·ªï SX</label><label class="flex gap-2"><input type="radio" name="team" value="T·ªï Thu Ho·∫°ch"> T·ªï TH</label></div>
                    <button onclick="app.addTask()" class="btn btn-blue">Giao Vi·ªác</button>
                </div>
            </div>
            <div id="task-list" class="space-y-2"></div>
        </div>

        <!-- TAB S·∫¢N XU·∫§T -->
        <div id="tab-sx" class="hidden">
            <div class="flex justify-between items-center px-1 mb-2"><h2 class="font-bold text-slate-800">S·∫£n Xu·∫•t</h2><button onclick="app.export('SX')" class="text-[10px] font-bold text-blue-600 border px-2 py-1 rounded bg-white">Excel</button></div>
            <div class="card border-l-4 border-blue-500">
                <div class="flex bg-slate-100 p-1 rounded-lg mb-3">
                    <button onclick="app.setMode('NH·∫¨P')" id="btn-sx-nhap" class="flex-1 py-2 rounded font-bold bg-blue-600 text-white shadow">NH·∫¨P</button>
                    <button onclick="app.setMode('XU·∫§T')" id="btn-sx-xuat" class="flex-1 py-2 rounded font-bold text-slate-400">XU·∫§T</button>
                </div>
                <input type="hidden" id="sx-act" value="NH·∫¨P">
                <div class="space-y-3">
                    <div class="flex gap-2"><input type="date" id="sx-date" class="input"><input id="sx-batch" class="input text-center" placeholder="L√¥ c·∫•y"></div>
                    <input id="sx-type" class="input" placeholder="Lo·∫°i ph√¥i..." list="phoi-list">
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="sx-qty" class="input text-center font-bold" placeholder="SL">
                        <input type="number" id="sx-bad" class="input text-center text-red-500" placeholder="H·ªßy">
                        <input type="number" id="sx-reuse" class="input text-center text-green-500" placeholder="T.D·ª•ng">
                    </div>
                    <input id="sx-dest" class="input" placeholder="N∆°i Nh·∫≠p/Xu·∫•t">
                    <button onclick="app.submitSX()" class="btn btn-blue">L∆∞u D·ªØ Li·ªáu</button>
                </div>
            </div>
            <div id="sx-logs" class="space-y-2"></div>
        </div>

        <!-- TAB THU HO·∫†CH -->
        <div id="tab-th" class="hidden">
            <div class="flex justify-between items-center px-1 mb-2"><h2 class="font-bold text-slate-800">Thu Ho·∫°ch</h2><button onclick="app.export('TH')" class="text-[10px] font-bold text-green-600 border px-2 py-1 rounded bg-white">Excel</button></div>
            <div class="card border-l-4 border-green-500">
                <div class="space-y-3">
                    <select id="th-area" class="input font-bold text-green-700"></select>
                    <div class="bg-slate-50 p-2 rounded border">
                        <div class="matrix-grid">
                            <input type="number" id="th-b2" class="input input-mini" placeholder="B2" oninput="app.calcTH()">
                            <input type="number" id="th-a1" class="input input-mini" placeholder="A1" oninput="app.calcTH()">
                            <input type="number" id="th-a2" class="input input-mini" placeholder="A2" oninput="app.calcTH()">
                            <input type="number" id="th-b1" class="input input-mini" placeholder="B1" oninput="app.calcTH()">
                        </div>
                        <div class="matrix-grid-5">
                            <input type="number" id="th-d1" class="input input-mini" placeholder="D1" oninput="app.calcTH()">
                            <input type="number" id="th-ht" class="input input-mini" placeholder="HT" oninput="app.calcTH()">
                            <input type="number" id="th-abf" class="input input-mini" placeholder="ABF" oninput="app.calcTH()">
                            <input type="number" id="th-b2f" class="input input-mini" placeholder="B2F" oninput="app.calcTH()">
                            <input type="number" id="th-b1f" class="input input-mini" placeholder="B1F" oninput="app.calcTH()">
                        </div>
                        <div id="th-stats" class="mt-2 pt-2 border-t text-[9px] flex flex-wrap"></div>
                    </div>
                    <div class="flex justify-between items-center bg-green-50 p-2 rounded border border-green-200">
                        <span class="text-xs font-bold text-green-800">T·ªîNG H√ÅI:</span><span id="th-total" class="text-xl font-black text-green-600">0 kg</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <input type="number" id="th-bad" class="input input-mini" placeholder="H·ªßy ch√¢n">
                         <input type="number" id="th-return" class="input input-mini" placeholder="ƒê·ªïi tr·∫£">
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <input type="number" id="th-dry" class="input input-mini" placeholder="Xu·∫•t s·∫•y">
                        <input type="number" id="th-snack-tp" class="input input-mini" placeholder="Snack TP">
                        <input type="number" id="th-snack-nl" class="input input-mini" placeholder="Xu·∫•t Snack">
                    </div>
                    <input id="th-note" class="input" placeholder="Ghi ch√∫ th√™m...">
                    <button onclick="app.submitTH()" class="btn btn-green">C·∫≠p Nh·∫≠t Kho</button>
                </div>
            </div>
            <div id="th-logs" class="space-y-2"></div>
        </div>

        <!-- TAB TEAM -->
        <div id="tab-team" class="hidden">
            <div class="card border border-blue-100">
                <p class="label mb-2">ƒêI·ªÇM DANH</p>
                <div class="grid grid-cols-2 gap-3"><button onclick="app.checkIn('S√°ng')" class="btn bg-yellow-100 text-yellow-700">‚òÄÔ∏è CA S√ÅNG</button><button onclick="app.checkIn('Chi·ªÅu')" class="btn bg-indigo-100 text-indigo-700">üåô CA CHI·ªÄU</button></div>
            </div>
            <div class="card bg-slate-50 border">
                 <p class="label mb-2">H√ÄNH CH√çNH</p>
                 <div class="grid grid-cols-2 gap-3"><button onclick="app.toggle('modal-leave')" class="btn btn-white"><i class="fas fa-calendar"></i> Xin ngh·ªâ</button><button onclick="app.toggle('modal-buy')" class="btn btn-white"><i class="fas fa-shopping-cart"></i> Mua h√†ng</button></div>
            </div>
            <p class="label px-2">NH√ÇN S·ª∞</p>
            <div id="team-list" class="space-y-2 pb-20"></div>
        </div>

    </main>

    <!-- NAV -->
    <nav id="nav">
        <button onclick="app.nav('home')" class="nav-item active" id="btn-home"><i class="fas fa-home"></i><span>HOME</span></button>
        <button onclick="app.nav('tasks')" class="nav-item" id="btn-tasks"><i class="fas fa-tasks"></i><span>VI·ªÜC</span></button>
        <button onclick="app.nav('sx')" class="nav-item" id="btn-sx"><i class="fas fa-industry"></i><span>SX</span></button>
        <button onclick="app.nav('th')" class="nav-item" id="btn-th"><i class="fas fa-box-open"></i><span>TH</span></button>
        <button onclick="app.nav('team')" class="nav-item" id="btn-team"><i class="fas fa-users"></i><span>TEAM</span></button>
        <button onclick="app.openChat()" class="nav-item"><i class="fas fa-comments"></i><span>CHAT</span></button>
    </nav>

    <!-- CHAT SCREEN -->
    <div id="chat-screen">
        <div class="h-[60px] bg-white border-b flex items-center px-4 justify-between flex-shrink-0">
            <button onclick="app.closeChat()" class="w-8 h-8 bg-slate-100 rounded-full"><i class="fas fa-arrow-left"></i></button>
            <span class="font-bold">Th·∫£o lu·∫≠n chung</span>
            <div class="w-8"></div>
        </div>
        <div id="chat-box"></div>
        <div class="bg-white p-3 border-t flex gap-2" style="padding-bottom: calc(12px + env(safe-area-inset-bottom));">
            <input id="chat-input" class="input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeyup="if(event.key==='Enter') app.sendChat()">
            <button onclick="app.sendChat()" class="w-12 bg-blue-600 text-white rounded-lg"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="settings-modal" class="hidden modal-wrap" onclick="if(event.target===this) app.toggle('settings-modal')">
        <div class="modal-box">
            <h3 class="font-bold mb-4">C√†i ƒë·∫∑t</h3>
            <button onclick="alert('Exporting...')" class="btn btn-white mb-3">Xu·∫•t B√°o C√°o</button>
            <div id="admin-tools" class="hidden border-t pt-3 space-y-3">
                <p class="label">Admin</p>
                <div class="flex gap-2"><input id="new-emp-name" placeholder="T√™n" class="input"><input id="new-emp-pin" placeholder="PIN" class="input w-20"></div>
                <button onclick="app.addEmp()" class="btn btn-blue">Th√™m Nh√¢n S·ª±</button>
                <button onclick="app.addHouse()" class="btn btn-white border">Th√™m Nh√† N·∫•m</button>
                <button onclick="app.toggle('modal-approve')" class="btn btn-green">Duy·ªát ƒê∆°n</button>
            </div>
            <button onclick="app.logout()" class="btn btn-red mt-4">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>
    
    <div id="report-modal" class="hidden modal-wrap" onclick="if(event.target===this) app.toggle('report-modal')"><div class="modal-box"><h3 class="font-bold text-center mb-2">B√°o c√°o</h3><input type="hidden" id="rep-id"><input type="number" id="rep-val" class="input text-center text-2xl mb-2" placeholder="SL"><input id="rep-note" class="input mb-2" placeholder="Ghi ch√∫"><div class="grid grid-cols-2 gap-2"><button onclick="app.rep('completed')" class="btn btn-green">Xong</button><button onclick="app.rep('unfinished')" class="btn btn-red">Ch∆∞a</button></div></div></div>
    
    <div id="modal-house" class="hidden modal-wrap" onclick="if(event.target===this) app.toggle('modal-house')"><div class="modal-box"><h3 class="font-bold text-center mb-2">L·ªãch s·ª≠ <span id="h-name"></span></h3><div id="h-logs" class="text-xs space-y-2 max-h-60 overflow-y-auto"></div></div></div>
    
    <div id="modal-leave" class="hidden modal-wrap" onclick="if(event.target===this) app.toggle('modal-leave')"><div class="modal-box"><h3 class="font-bold mb-2">Xin ngh·ªâ</h3><input id="l-date" type="date" class="input mb-2"><select id="l-reason" class="input mb-2"><option>·ªêm</option><option>Vi·ªác ri√™ng</option></select><button onclick="app.hr('LEAVE')" class="btn btn-blue">G·ª≠i</button></div></div>
    
    <div id="modal-buy" class="hidden modal-wrap" onclick="if(event.target===this) app.toggle('modal-buy')"><div class="modal-box"><h3 class="font-bold mb-2">Mua h√†ng</h3><input id="b-item" placeholder="T√™n h√†ng" class="input mb-2"><button onclick="app.hr('BUY')" class="btn btn-green">G·ª≠i</button></div></div>
    
    <div id="modal-approve" class="hidden modal-wrap" onclick="if(event.target===this) app.toggle('modal-approve')"><div class="modal-box"><h3 class="font-bold mb-2">Duy·ªát ƒë∆°n</h3><div id="hr-list" class="space-y-2"></div></div></div>
    
    <div id="modal-temp" class="hidden modal-wrap" onclick="if(event.target===this) app.toggle('modal-temp')"><div class="modal-box text-center"><h3 class="font-bold mb-2">Nhi·ªát ƒë·ªô</h3><input type="hidden" id="temp-hid"><div class="flex gap-2 mb-2"><input id="t-am" placeholder="S√°ng" class="input text-center"><input id="t-pm" placeholder="Chi·ªÅu" class="input text-center"></div><button onclick="app.saveTemp()" class="btn btn-blue">L∆∞u</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fbConfig = { apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", authDomain: "ong5mushroom-vietnam.firebaseapp.com", projectId: "ong5mushroom-vietnam", storageBucket: "ong5mushroom-vietnam.firebasestorage.app", messagingSenderId: "931399604992", appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" };
        const appInstance = initializeApp(fbConfig);
        const db = getFirestore(appInstance);
        const ROOT = "artifacts/namong5_production/public/data";

        window.app = {
            data: { employees: [], houses: [], chat: [], tasks: [], production: [], harvest: [], hr: [] },
            user: JSON.parse(localStorage.getItem('n5_v92_user')) || null,
            
            ui: {
                toggleModal: id => document.getElementById(id).classList.toggle('hidden'),
            },

            init: () => {
                const status = document.getElementById('login-loading');
                setTimeout(() => { if(app.data.employees.length===0) document.getElementById('rescue-btn').classList.remove('hidden'); }, 3000);
                signInAnonymously(getAuth(appInstance)).then(() => { status.innerText = "ƒêang ƒë·ªìng b·ªô..."; app.sync(); });
                document.getElementById('sx-date').valueAsDate = new Date();
            },

            sync: () => {
                const mapData = s => s.docs.map(d => ({...d.data(), _id: d.id}));
                
                onSnapshot(collection(db, `${ROOT}/employees`), s => {
                    app.data.employees = mapData(s);
                    app.renderLogin();
                    if(app.user) app.renderTeam();
                });
                ['houses', 'tasks', 'production_logs', 'harvest_logs', 'hr_requests', 'attendance_logs', 'sop'].forEach(col => {
                    onSnapshot(collection(db, `${ROOT}/${col}`), s => {
                        const k = col.includes('logs') ? col.split('_')[0] : (col==='hr_requests'?'hr':col);
                        app.data[k] = mapData(s);
                        if(app.user) app.render();
                    });
                });
                onSnapshot(query(collection(db, `${ROOT}/chat`), orderBy("time", "asc"), limit(50)), s => {
                    app.data.chat = s.docs.map(d => d.data());
                    if(app.user) app.renderChat();
                });
            },

            renderLogin: () => {
                const s = document.getElementById('login-user');
                if(app.data.employees.length > 0) {
                    s.innerHTML = '<option value="">-- Ch·ªçn t√™n --</option>' + app.data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                    s.disabled = false; document.getElementById('login-pin').disabled = false;
                    document.getElementById('login-btn').disabled = false; document.getElementById('login-btn').classList.remove('opacity-50');
                    document.getElementById('login-loading').innerText = "S·∫µn s√†ng";
                }
                if(app.user) { document.getElementById('login-screen').classList.add('hidden'); app.render(); }
            },

            doLogin: () => {
                const id = document.getElementById('login-user').value;
                const pin = document.getElementById('login-pin').value.trim();
                const emp = app.data.employees.find(e => String(e.id) === String(id) && String(e.pin).trim() === String(pin));
                if(emp) {
                    app.user = emp; localStorage.setItem('n5_v92_user', JSON.stringify(emp));
                    document.getElementById('login-screen').classList.add('hidden'); app.render();
                } else alert("Sai m√£ PIN!");
            },

            render: () => {
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω', 'T·ªï tr∆∞·ªüng'].includes(app.user.role);
                if(isAdmin) {
                    document.getElementById('admin-assign').classList.remove('hidden');
                    document.getElementById('admin-tools').classList.remove('hidden');
                }
                document.getElementById('u-name').innerText = app.user.name;

                // Houses & Logs
                document.getElementById('house-list').innerHTML = app.data.houses.map(h => `
                    <div class="card flex justify-between items-center !p-3 !mb-2 border-l-4 border-blue-500">
                        <div><p class="font-bold text-sm">${h.name}</p><p class="text-[10px] text-slate-400">AM: ${h.temp?.am||'-'} | PM: ${h.temp?.pm||'-'}</p></div>
                        <div class="flex gap-2">
                             <button onclick="app.viewLog('${h.name}')" class="w-8 h-8 bg-blue-100 rounded-full text-xs text-blue-600"><i class="fas fa-file-alt"></i></button>
                             <button onclick="app.openTemp('${h._id}','${h.name}')" class="w-8 h-8 bg-orange-100 rounded-full text-xs text-orange-600"><i class="fas fa-temperature-high"></i></button>
                        </div>
                    </div>`).join('');
                
                // Selects
                const hOpts = app.data.houses.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
                ['th-area'].forEach(id => { const el = document.getElementById(id); if(el.innerHTML==="") el.innerHTML=hOpts; });
                const mh = document.getElementById('house-multi'); if(mh.innerHTML==="") mh.innerHTML=app.data.houses.map(h => `<label class="flex gap-1 text-[10px]"><input type="checkbox" value="${h.name}" name="h-chk"> ${h.name}</label>`).join('');

                // Tasks
                let tasks = app.data.tasks.filter(t => t.status !== 'completed');
                if(!isAdmin) tasks = tasks.filter(t => t.assignee == app.user.id);
                document.getElementById('task-list').innerHTML = tasks.map(t => {
                    const isStarted = t.status === 'in_progress';
                    return `<div class="card !p-3 border-l-4 border-indigo-500 flex justify-between items-center"><div><p class="font-bold text-xs">${t.title} (${t.houseId})</p></div><div class="flex gap-2">${isAdmin?`<button onclick="alert('ƒê√£ nh·∫Øc!')" class="text-yellow-500"><i class="fas fa-bell"></i></button><button onclick="app.delTask('${t._id}')" class="text-red-500"><i class="fas fa-trash"></i></button>`:''}${t.assignee==app.user.id ? (isStarted ? `<button onclick="app.openRep('${t._id}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">B√ÅO C√ÅO</button>`:`<button onclick="app.startTask('${t._id}')" class="bg-green-600 text-white px-2 py-1 rounded text-xs">NH·∫¨N</button>`) : ''}</div></div>`;
                }).join('');
                
                // Assign list
                if(document.getElementById('assign-ind').innerHTML==="") document.getElementById('assign-ind').innerHTML = app.data.employees.map(e=>`<label class="flex gap-2 text-xs p-1"><input type="checkbox" name="u-chk" value="${e.id}"> ${e.name}</label>`).join('');

                // Stats & Logs
                document.getElementById('stat-online').innerText = app.data.employees.filter(e=>e.lastLogin===new Date().toISOString().split('T')[0]).length;
                document.getElementById('sx-logs').innerHTML = app.data.production.slice(0,5).map(l=>`<div class="text-[10px] p-2 border-b flex justify-between"><span>${l.action} ${l.type}</span><span>${l.qty}</span></div>`).join('');
                document.getElementById('th-logs').innerHTML = app.data.harvest.slice(0,5).map(l=>`<div class="text-[10px] p-2 border-b flex justify-between"><span>${l.area}</span><span>${l.total} kg</span></div>`).join('');
                
                // HR
                if(isAdmin) document.getElementById('hr-list').innerHTML = app.data.hr.filter(r=>r.status==='pending').map(r=>`<div class="p-2 border rounded mb-1 text-xs"><p>${r.type} - ${r.requester}</p><button onclick="app.approve('${r._id}')" class="text-green-600 font-bold">Duy·ªát</button></div>`).join('');
            },

            renderTeam: () => {
                 const today = new Date().toISOString().split('T')[0];
                 document.getElementById('team-list').innerHTML = app.data.employees.map(e => `
                    <div class="card flex justify-between items-center !p-3 !mb-2 border-l-4 ${e.lastLogin===today?'border-green-500':'border-slate-200'}">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-xs">${e.name.charAt(0)}</div><p class="text-xs font-bold text-slate-700">${e.name}</p></div>
                        ${e.lastLogin===today ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                    </div>`).join('');
            },

            renderChat: () => {
                document.getElementById('chat-box').innerHTML = app.data.chat.map(m => `<div class="flex flex-col ${m.senderId===app.user.id?'items-end':'items-start'}"><div class="chat-bubble ${m.senderId===app.user.id?'me':'other'}"><p class="text-[9px] font-bold opacity-50 mb-1">${m.senderName}</p>${m.text}</div></div>`).join('');
                document.getElementById('chat-box').scrollTop = 99999;
            },

            // ACTIONS
            seedAdmin: async () => { if(confirm("T·∫°o Admin?")) await addDoc(collection(db, `${ROOT}/employees`), { id: 9999, name: "Admin", pin: "9999", role: "Gi√°m ƒë·ªëc" }); location.reload(); },
            
            nav: (id) => {
                document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
                document.getElementById('tab-'+id).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                const btn = document.querySelector(`button[onclick="app.nav('${id}')"]`);
                if(btn) btn.classList.add('active');
            },
            
            openChat: () => { document.getElementById('chat-screen').style.display = 'flex'; setTimeout(()=>document.getElementById('chat-box').scrollTop=99999,100); },
            closeChat: () => document.getElementById('chat-screen').style.display = 'none',
            toggle: id => document.getElementById(id).classList.toggle('hidden'),

            // SX
            setMode: (m) => {
                document.getElementById('sx-act').value = m;
                document.getElementById('btn-sx-nhap').className = m==='NH·∫¨P'?'flex-1 py-2 rounded font-bold bg-blue-600 text-white':'flex-1 py-2 rounded font-bold text-slate-400';
                document.getElementById('btn-sx-xuat').className = m==='XU·∫§T'?'flex-1 py-2 rounded font-bold bg-orange-500 text-white':'flex-1 py-2 rounded font-bold text-slate-400';
            },
            submitSX: async () => {
                const d = { action: document.getElementById('sx-act').value, date: document.getElementById('sx-date').value, type: document.getElementById('sx-type').value, qty: Number(document.getElementById('sx-qty').value), batch: document.getElementById('sx-batch').value, dest: document.getElementById('sx-dest').value, bad: Number(document.getElementById('sx-bad').value), reuse: Number(document.getElementById('sx-reuse').value), user: app.user.name, time: Date.now() };
                await addDoc(collection(db, `${ROOT}/production_logs`), d); alert("ƒê√£ l∆∞u!");
            },
            
            // TH
            calcTH: () => {
                const f = ['b2','a1','a2','b1','d1','ht','abf','b2f','b1f'];
                let sum = 0; let html = '';
                f.forEach(id => sum += Number(document.getElementById('th-'+id).value)||0);
                if(sum>0) f.forEach(id => { const v=Number(document.getElementById('th-'+id).value)||0; if(v>0) html+=`<span class="stat-tag">${id.toUpperCase()}: ${((v/sum)*100).toFixed(0)}%</span>`; });
                document.getElementById('th-total').innerText = sum + ' kg';
                document.getElementById('th-stats').innerHTML = html;
            },
            submitTH: async () => {
                const det = {}; ['b2','a1','a2','b1','d1','ht','abf','b2f','b1f'].forEach(id => det[id]=Number(document.getElementById('th-'+id).value)||0);
                const total = Object.values(det).reduce((a,b)=>a+b,0);
                await addDoc(collection(db, `${ROOT}/harvest_logs`), { area: document.getElementById('th-area').value, details: det, total, user: app.user.name, time: Date.now(), bad: document.getElementById('th-bad').value, return: document.getElementById('th-return').value, dry: document.getElementById('th-dry').value, snack_tp: document.getElementById('th-snack-tp').value, snack_nl: document.getElementById('th-snack-nl').value, note: document.getElementById('th-note').value });
                alert("ƒê√£ l∆∞u!");
            },

            // TASK
            createTask: async () => {
                const t = document.getElementById('t-title').value;
                const h = Array.from(document.querySelectorAll('input[name="h-chk"]:checked')).map(i=>i.value);
                const u = Array.from(document.querySelectorAll('input[name="u-chk"]:checked')).map(i=>i.value);
                for(let house of h) for(let uid of u) await addDoc(collection(db, `${ROOT}/tasks`), { title: t, houseId: house, assignee: uid, status: 'pending', time: Date.now() });
                alert("ƒê√£ giao!");
            },
            startTask: async (id) => updateDoc(doc(db, `${ROOT}/tasks`, id), { status: 'in_progress', startTime: Date.now() }),
            delTask: async (id) => deleteDoc(doc(db, `${ROOT}/tasks`, id)),
            openRep: (id) => { document.getElementById('rep-id').value = id; app.ui.toggle('report-modal'); },
            rep: async (st) => { await updateDoc(doc(db, `${ROOT}/tasks`, document.getElementById('rep-id').value), { status: st, actual: document.getElementById('rep-val').value, finishTime: Date.now() }); app.ui.toggle('report-modal'); },

            // OTHER
            checkIn: async (s) => { await addDoc(collection(db, `${ROOT}/attendance_logs`), { uid: app.user.id, name: app.user.name, shift: s, date: new Date().toISOString().split('T')[0] }); await updateDoc(doc(db, `${ROOT}/employees`, app.user._id), { lastLogin: new Date().toISOString().split('T')[0] }); alert("ƒê√£ ƒëi·ªÉm danh!"); },
            sendChat: async () => { const i=document.getElementById('chat-input'); if(i.value) { await addDoc(collection(db, `${ROOT}/chat`), { text: i.value, senderId: app.user.id, senderName: app.user.name, time: Date.now() }); i.value=''; } },
            openTemp: (id,n) => { document.getElementById('temp-hid').value=id; document.getElementById('temp-name').innerText=n; app.ui.toggle('modal-temp'); },
            saveTemp: async () => { await updateDoc(doc(db, `${ROOT}/houses`, document.getElementById('temp-hid').value), { 'temp.am':document.getElementById('t-am').value, 'temp.pm':document.getElementById('t-pm').value }); alert("L∆∞u!"); app.ui.toggle('modal-temp'); },
            
            // View Log (FIXED)
            viewLog: (name) => {
                const l = [
                    ...app.data.production.filter(x=>x.dest===name).map(x=>`<span class="text-blue-600 font-bold">[SX]</span> ${x.action} ${x.qty} (${x.type})`),
                    ...app.data.harvest.filter(x=>x.area===name).map(x=>`<span class="text-green-600 font-bold">[TH]</span> H√°i ${x.total}kg`)
                ];
                document.getElementById('h-name').innerText = name;
                document.getElementById('h-logs').innerHTML = l.length ? l.join('<br>') : 'Ch∆∞a c√≥ d·ªØ li·ªáu';
                app.ui.toggle('modal-house');
            },

            addEmp: async () => { await addDoc(collection(db, `${ROOT}/employees`), { id: Number(document.getElementById('new-emp-id').value), name: document.getElementById('new-emp-name').value, pin: document.getElementById('new-emp-pin').value, role: 'Nh√¢n vi√™n', score: 100 }); alert("Xong"); },
            addHouse: async () => { const n=prompt("T√™n:"); if(n) await addDoc(collection(db, `${ROOT}/houses`), { name:n, temp:{am:0,pm:0} }); },
            
            hr: async (t) => { await addDoc(collection(db, `${ROOT}/hr_requests`), { type: t, requester: app.user.name, status: 'pending', content: t==='LEAVE'?document.getElementById('l-date').value:document.getElementById('b-item').value }); alert("G·ª≠i xong!"); },
            approve: async (id) => { await updateDoc(doc(db, `${ROOT}/hr_requests`, id), { status: 'approved' }); alert("Duy·ªát!"); },
            
            toggleAssign: () => {
                const m = document.getElementById('assign-mode').value;
                document.getElementById('assign-ind').classList.toggle('hidden', m!=='ind');
                document.getElementById('assign-team').classList.toggle('hidden', m!=='team');
            },
            fillSOP: () => {
                 const v = document.getElementById('t-title').value;
                 const s = (app.data.sop||[]).find(x=>x.title===v);
                 if(s) document.getElementById('t-target').value = s.sop;
            },
            export: (t) => alert("Export " + t)
        };
        
        window.onload = app.init;
    </script>
</body>
</html>
