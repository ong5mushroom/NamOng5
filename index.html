<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NẤM ÔNG 5 – V75 FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f5f5f5;padding:10px}
input,select,button{width:100%;padding:8px;margin:4px 0}
button{background:#2e7d32;color:#fff;border:none}
.box{background:#fff;padding:12px;border-radius:6px;margin-bottom:10px}
</style>
</head>

<body>
<div id="root"></div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
});
const auth = firebase.auth();
const db = firebase.firestore();

const e = React.createElement;

/* ===== PRODUCTION ===== */
function Production(props){
  function submit(ev){
    ev.preventDefault();
    const f = ev.target;
    db.collection("production_logs").add({
      date:f.date.value,
      action:f.action.value,
      material:f.material.value,
      quantity:Number(f.qty.value),
      batch:f.batch.value,
      location:f.loc.value,
      destroy:Number(f.destroy.value||0),
      reuse:Number(f.reuse.value||0),
      userId:props.user.uid,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
      alert("Đã lưu sản xuất");
      f.reset();
    });
  }

  return e("div",{className:"box"},
    e("h3",null,"SẢN XUẤT"),
    e("form",{onSubmit:submit},
      e("input",{type:"date",name:"date",required:true}),
      e("select",{name:"action"},
        e("option",{value:"IN"},"Nhập"),
        e("option",{value:"OUT"},"Xuất")
      ),
      e("input",{name:"material",placeholder:"Loại phôi",required:true}),
      e("input",{name:"qty",type:"number",placeholder:"Số lượng",required:true}),
      e("input",{name:"batch",placeholder:"Lô cấy"}),
      e("input",{name:"loc",placeholder:"Nhà"}),
      e("input",{name:"destroy",placeholder:"Số hủy"}),
      e("input",{name:"reuse",placeholder:"Số tận dụng"}),
      e("button",{type:"submit"},"Lưu")
    )
  );
}

/* ===== HARVEST ===== */
function Harvest(props){
  const fields=["B2","A1","A2","B1","D1","HAU_THU","AB_F","B2_F","B1_F","TRA","LOI","HAO_HUT","XUAT_SAY","HUY_CHAN","NL_SNACK","SNACK_TP"];
  const [data,setData]=React.useState({});

  const total=Object.values(data).reduce((a,b)=>a+Number(b||0),0);

  function save(){
    db.collection("harvest_logs").add({
      date:new Date().toISOString().slice(0,10),
      house:"Nhà",
      items:data,
      total:total,
      userId:props.user.uid,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
      alert("Đã lưu thu hoạch");
      setData({});
    });
  }

  return e("div",{className:"box"},
    e("h3",null,"THU HOẠCH"),
    fields.map(f =>
      e("input",{
        key:f,
        placeholder:f,
        type:"number",
        value:data[f]||"",
        onChange:ev=>setData(Object.assign({},data,{[f]:ev.target.value}))
      })
    ),
    e("b",null,"TỔNG: "+total),
    e("button",{onClick:save},"Lưu")
  );
}

/* ===== APP ===== */
function App(){
  const [user,setUser]=React.useState(null);

  React.useEffect(()=>{
    auth.onAuthStateChanged(setUser);
  },[]);

  if(!user){
    return e("div",{className:"box"},
      e("h2",null,"NẤM ÔNG 5"),
      e("button",{onClick:()=>auth.signInAnonymously()},"Đăng nhập")
    );
  }

  return e("div",null,
    e("h3",null,"V75 FINAL"),
    e(Production,{user}),
    e(Harvest,{user})
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(e(App));
</script>
</body>
</html>
