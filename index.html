<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>N·∫•m √îng 5 V90 - Enterprise Perfect</title>
    
    <!-- Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- CORE VARIABLES --- */
        :root { 
            --blue: #2563eb; 
            --header-h: 90px; 
            --nav-h: 80px; 
            --bg: #f1f5f9;
        }
        
        /* --- RESET & BASE --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: #1e293b; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- LAYOUT ENGINE --- */
        #app-header {
            height: var(--header-h);
            background: white;
            border-bottom: 1px solid #e2e8f0;
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 50;
            padding-top: env(safe-area-inset-top);
            display: flex; align-items: center; justify-content: space-between;
            padding-left: 16px; padding-right: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        #app-view-container {
            position: fixed;
            top: var(--header-h);
            bottom: var(--nav-h);
            left: 0; right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 40px;
            z-index: 10;
        }

        #app-nav {
            height: var(--nav-h);
            background: white;
            border-top: 1px solid #e2e8f0;
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
            display: flex; justify-content: space-around; align-items: center;
        }

        /* --- COMPONENTS --- */
        .hidden { display: none !important; }
        
        .card { 
            background: white; 
            border-radius: 16px; 
            padding: 16px; 
            margin-bottom: 12px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
        }

        .input-box { 
            width: 100%; 
            background: #f8fafc; 
            border: 1px solid #cbd5e1; 
            padding: 12px; 
            border-radius: 12px; 
            font-weight: 600; 
            outline: none; 
            font-size: 14px; 
            transition: all 0.2s;
        }
        .input-box:focus { border-color: var(--blue); background: white; ring: 2px solid #bfdbfe; }
        .input-mini { padding: 8px 4px; text-align: center; font-size: 13px; }

        .btn { 
            width: 100%; 
            padding: 14px; 
            border-radius: 14px; 
            font-weight: 800; 
            text-transform: uppercase; 
            font-size: 12px; 
            transition: transform 0.1s; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-blue { background: var(--blue); color: white; box-shadow: 0 4px 10px rgba(37,99,235,0.2); }
        .btn-green { background: #16a34a; color: white; box-shadow: 0 4px 10px rgba(22,163,74,0.2); }
        .btn-orange { background: #f97316; color: white; box-shadow: 0 4px 10px rgba(249,115,22,0.2); }
        .btn-red { background: #ef4444; color: white; }

        .label { display: block; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
        
        .nav-btn { color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 9px; font-weight: 700; transition: color 0.2s; }
        .nav-btn i { font-size: 20px; margin-bottom: 2px; }
        .nav-active { color: var(--blue); transform: translateY(-2px); }

        /* --- LOGIN LAYER (Z 9999) --- */
        #login-layer { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; transition: opacity 0.3s; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-wait { background: #eab308; animation: pulse 1s infinite; }
        .status-ok { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        
        /* --- CHAT LAYER (Z 2000) --- */
        #chat-layer { position: fixed; inset: 0; background: #e5ddd5; z-index: 2000; display: none; flex-direction: column; }
        .chat-bg { background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px); background-size: 20px 20px; }
        .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; margin-bottom: 8px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .chat-me { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-other { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }

        /* --- MODAL LAYER (Z 3000) --- */
        .modal-wrap { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 16px; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; max-height: 85vh; overflow-y: auto; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- 1. M√ÄN H√åNH ƒêƒÇNG NH·∫¨P -->
    <div id="login-layer">
        <div class="w-24 h-24 bg-blue-600 rounded-[32px] flex items-center justify-center text-white text-5xl font-black mb-6 shadow-xl">5</div>
        <h1 class="text-3xl font-black text-slate-800 mb-1">N·∫•m √îng 5</h1>
        <p class="text-xs font-bold text-blue-500 mb-10 tracking-widest">‚óè V90 Enterprise</p>
        
        <div class="w-full max-w-sm space-y-4">
            <div id="login-status" class="text-center text-xs font-bold text-slate-400 mb-2 flex items-center justify-center">
                <span class="status-dot status-wait"></span> <span id="status-text">ƒêang k·∫øt n·ªëi...</span>
            </div>
            
            <select id="login-user" class="input-box text-center appearance-none" disabled>
                <option>Vui l√≤ng ƒë·ª£i...</option>
            </select>
            
            <input id="login-pin" type="tel" placeholder="Nh·∫≠p PIN (Vd: 1234)" class="input-box text-center text-xl tracking-widest" disabled maxlength="6">
            
            <button id="login-btn" onclick="app.doLogin()" class="btn btn-blue opacity-50 cursor-not-allowed" disabled>
                ƒêƒÇNG NH·∫¨P
            </button>
            
            <!-- N√∫t C·ª©u H·ªô: Hi·ªán sau 3s n·∫øu l·ªói -->
            <button id="rescue-btn" onclick="app.actions.seedAdmin()" class="hidden w-full border-2 border-red-100 text-red-500 py-3 rounded-xl font-bold text-xs mt-4 hover:bg-red-50">
                <i class="fas fa-shield-alt mr-2"></i> KH·ªûI T·∫†O ADMIN (9999)
            </button>
        </div>
        <button onclick="localStorage.clear(); location.reload()" class="mt-12 text-xs text-slate-400 underline font-bold">X√≥a Cache & T·∫£i l·∫°i</button>
    </div>

    <!-- 2. HEADER -->
    <header id="app-header">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white w-9 h-9 rounded-xl flex items-center justify-center font-black shadow-md text-lg">5</div>
            <div>
                <h1 class="text-xs font-black uppercase text-slate-800 tracking-wide">N·∫•m √îng 5</h1>
                <p class="text-[8px] text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded inline-block mt-0.5">‚óè Online</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="text-right"><p id="head-user" class="font-bold text-xs">...</p><p id="head-role" class="text-[9px] text-blue-500 font-bold uppercase">...</p></div>
            <button onclick="app.ui.openModal('settings-modal')" class="w-9 h-9 bg-slate-50 rounded-full border flex items-center justify-center text-slate-500 active:bg-slate-100"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <!-- 3. MAIN CONTENT CONTAINER -->
    <div id="app-view-container">
        
        <!-- A. HOME TAB -->
        <div id="view-home" class="hidden">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="card border-l-4 border-blue-500 text-center !py-4 !mb-0">
                    <p class="label">Nh√¢n s·ª±</p>
                    <p class="text-2xl font-black text-blue-600" id="stat-online">0</p>
                </div>
                <div class="card border-l-4 border-green-500 text-center !py-4 !mb-0">
                    <p class="label">T·ªïng H√°i (Kg)</p>
                    <p class="text-2xl font-black text-green-600" id="stat-yield">0</p>
                </div>
            </div>
            
            <div class="flex justify-between items-center px-1 mb-2">
                <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">DANH S√ÅCH NH√Ä</h3>
            </div>
            <div id="house-list" class="space-y-3"></div>
        </div>

        <!-- B. TASKS TAB -->
        <div id="view-tasks" class="hidden">
             <!-- Admin Form -->
             <div id="admin-task-form" class="hidden card border-2 border-blue-50 !mb-4">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-black text-blue-600 uppercase">Giao vi·ªác m·ªõi</span>
                    <select id="assign-mode" onchange="app.ui.toggleAssign()" class="text-[10px] font-bold bg-slate-100 p-1 rounded"><option value="ind">C√° nh√¢n</option><option value="team">T·ªï</option></select>
                </div>
                <div class="space-y-3">
                    <input id="task-title" placeholder="T√™n c√¥ng vi·ªác..." class="input-box bg-white" list="sop-list" onchange="app.actions.fillSOP()">
                    <datalist id="sop-list"></datalist>
                    <div>
                        <p class="label">Ch·ªçn Nh√† (ƒêa ch·ªçn)</p>
                        <div id="house-multi-select" class="grid grid-cols-3 gap-2 bg-slate-50 p-2 rounded-xl border max-h-32 overflow-y-auto"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2"><div><p class="label">ƒê·ªãnh m·ª©c</p><input type="number" id="task-target" class="input-box bg-white text-center h-20"></div></div>
                    
                    <div id="assign-ind-zone" class="bg-slate-50 p-2 rounded-xl border max-h-40 overflow-y-auto space-y-2"></div>
                    <div id="assign-team-zone" class="hidden bg-slate-50 p-2 rounded-xl border space-y-2 text-xs font-bold"><label class="flex items-center gap-2"><input type="radio" name="team-radio" value="T·ªï S·∫£n Xu·∫•t" checked> T·ªï S·∫£n Xu·∫•t</label><label class="flex items-center gap-2"><input type="radio" name="team-radio" value="T·ªï Thu Ho·∫°ch"> T·ªï Thu Ho·∫°ch</label></div>
                    
                    <button onclick="app.actions.createTask()" class="btn btn-blue bg-slate-800">BAN H√ÄNH L·ªÜNH</button>
                </div>
            </div>
            <div id="task-list" class="space-y-3"></div>
        </div>

        <!-- C. S·∫¢N XU·∫§T (SX) -->
        <div id="view-sx" class="hidden">
            <div class="flex justify-between items-center px-1 mb-2"><h2 class="font-black text-slate-800">Nh·∫≠t K√Ω SX</h2><button onclick="app.actions.exportSX()" class="text-[10px] font-bold text-blue-600 bg-white border px-3 py-1 rounded-lg">Excel</button></div>
            <div class="card border-2 border-blue-50">
                <div class="flex bg-slate-100 p-1 rounded-xl mb-4">
                    <button onclick="app.ui.setSXMode('NH·∫¨P')" id="btn-sx-nhap" class="flex-1 py-3 rounded-lg text-xs font-black bg-blue-600 text-white shadow-md transition">NH·∫¨P KHO</button>
                    <button onclick="app.ui.setSXMode('XU·∫§T')" id="btn-sx-xuat" class="flex-1 py-3 rounded-lg text-xs font-black text-slate-400 hover:bg-white transition">XU·∫§T KHO</button>
                </div>
                <input type="hidden" id="sx-action" value="NH·∫¨P">
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3"><div><p class="label">Ng√†y</p><input type="date" id="sx-date" class="input-box bg-white p-2"></div><div><p class="label">L√¥ c·∫•y</p><input id="sx-batch" class="input-box bg-white text-center p-2" placeholder="..."></div></div>
                    <div><p class="label">Lo·∫°i Ph√¥i</p><input type="text" id="sx-type" list="phoi-list" class="input-box bg-white p-2" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p..."></div>
                    <div class="grid grid-cols-3 gap-2">
                        <div><p class="label">S·ªë l∆∞·ª£ng</p><input type="number" id="sx-qty" class="input-box bg-white text-center font-bold text-lg p-2"></div>
                        <div><p class="label text-red-500">H·ªßy</p><input type="number" id="sx-bad" placeholder="0" class="input-box bg-white text-center p-2"></div>
                        <div><p class="label text-green-600">T·∫≠n d·ª•ng</p><input type="number" id="sx-reuse" placeholder="0" class="input-box bg-white text-center p-2"></div>
                    </div>
                    <div><p class="label">N∆°i Nh·∫≠p/Xu·∫•t</p><input type="text" id="sx-dest" placeholder="Nh√† A, Kho B..." class="input-box bg-white p-2"></div>
                    <button onclick="app.actions.submitSX()" class="btn btn-blue mt-2">GHI D·ªÆ LI·ªÜU</button>
                </div>
            </div>
            <div id="sx-log-list" class="space-y-2"></div>
        </div>

        <!-- D. THU HO·∫†CH (TH) -->
        <div id="view-th" class="hidden">
             <div class="flex justify-between items-center px-1 mb-2"><h2 class="font-black text-slate-800">Thu Ho·∫°ch</h2><button onclick="app.actions.exportTH()" class="text-[10px] font-bold text-green-600 bg-white border px-3 py-1 rounded-lg">Excel</button></div>
             <div class="card border-2 border-green-50">
                 <div class="space-y-3">
                     <div><p class="label">Ch·ªçn Nh√†</p><select id="th-area" class="input-box bg-white font-bold text-green-700 p-2"></select></div>
                     <div class="bg-slate-50 p-3 rounded-2xl border border-slate-200">
                         <!-- Matrix 9 √¥ -->
                         <div class="grid grid-cols-4 gap-2 mb-2 items-end">
                            <div><label class="text-center text-[9px] font-bold block mb-1">B2</label><input type="number" id="th-b2" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">A1</label><input type="number" id="th-a1" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">A2</label><input type="number" id="th-a2" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">B1</label><input type="number" id="th-b1" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                        </div>
                        <div class="grid grid-cols-5 gap-2 items-end">
                            <div><label class="text-center text-[9px] font-bold block mb-1">D1</label><input type="number" id="th-d1" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">H.Th·ªß</label><input type="number" id="th-ht" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">ABF</label><input type="number" id="th-abf" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">B2F</label><input type="number" id="th-b2f" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">B1F</label><input type="number" id="th-b1f" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                        </div>
                        <div id="th-percent-display" class="grid grid-cols-4 gap-1 mt-3 pt-2 border-t border-slate-200 text-center text-[9px] text-slate-500 font-bold"></div>
                    </div>
                    
                    <div class="flex justify-between items-center bg-green-50 p-4 rounded-2xl border border-green-100">
                        <span class="font-bold text-green-800 text-xs">T·ªîNG H√ÅI:</span>
                        <span id="th-total-display" class="font-black text-2xl text-green-600">0 kg</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                         <div><p class="label text-red-500">H·ªßy ch√¢n (kg)</p><input type="number" id="th-huy-chan" class="input-box bg-white text-center p-2" placeholder="0"></div>
                         <div><p class="label text-orange-500">ƒê·ªïi tr·∫£ (kg)</p><input type="number" id="th-doi-tra" class="input-box bg-white text-center p-2" placeholder="0"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><p class="label text-blue-500">Xu·∫•t NL S·∫•y</p><input type="number" id="th-xuat-say" class="input-box bg-white text-center p-2" placeholder="0"></div>
                        <div><p class="label text-purple-500">Snack TP</p><input type="number" id="th-snack-tp" class="input-box bg-white text-center p-2" placeholder="0"></div>
                        <div><p class="label text-purple-500">Xu·∫•t NL Snack</p><input type="number" id="th-xuat-snack" class="input-box bg-white text-center p-2" placeholder="0"></div>
                    </div>
                    <div><p class="label">Ghi ch√∫ th√™m</p><input type="text" id="th-note" class="input-box bg-white p-2"></div>
                    
                    <button onclick="app.actions.submitTH()" class="btn btn-green mt-2">C·∫¨P NH·∫¨T KHO</button>
                 </div>
             </div>
             <div id="th-log-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- E. TEAM -->
        <div id="view-team" class="hidden">
             <div class="card border border-blue-100">
                <p class="label mb-3">ƒêI·ªÇM DANH C√Å NH√ÇN</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.actions.checkIn('S√°ng')" class="btn bg-yellow-50 text-yellow-700 border border-yellow-200">‚òÄÔ∏è CA S√ÅNG</button>
                    <button onclick="app.actions.checkIn('Chi·ªÅu')" class="btn bg-indigo-50 text-indigo-700 border border-indigo-200">üåô CA CHI·ªÄU</button>
                </div>
             </div>
             <div class="card bg-slate-50 border border-slate-200">
                 <p class="label mb-3">H√ÄNH CH√çNH</p>
                 <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.ui.showModal('modal-leave')" class="btn bg-white shadow-sm border text-slate-600"><i class="fas fa-calendar-times text-red-500"></i> Xin ngh·ªâ</button>
                    <button onclick="app.ui.showModal('modal-buy')" class="btn bg-white shadow-sm border text-slate-600"><i class="fas fa-shopping-cart text-green-500"></i> Mua h√†ng</button>
                 </div>
             </div>
             <p class="label px-2">DANH S√ÅCH NH√ÇN S·ª∞</p>
             <div id="team-list" class="space-y-2 pb-20"></div>
        </div>

    </main>

    <!-- 4. CHAT LAYER -->
    <div id="chat-layer" class="chat-bg">
        <div class="h-[90px] bg-white border-b flex items-end px-4 pb-3 shadow-sm flex-shrink-0">
             <button onclick="app.ui.closeChat()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center mr-3 active:bg-slate-200"><i class="fas fa-arrow-left text-slate-600"></i></button>
             <div><h2 class="font-bold text-slate-800 text-lg">Th·∫£o lu·∫≠n chung</h2></div>
        </div>
        <div id="chat-box"></div>
        <div style="background: white; padding: 12px; border-top: 1px solid #e2e8f0; display: flex; gap: 8px; padding-bottom: calc(12px + env(safe-area-inset-bottom));">
            <input id="chat-input" type="text" class="flex-1 bg-slate-100 rounded-full px-5 py-3 text-sm outline-none border border-slate-200" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeyup="if(event.key==='Enter') app.actions.sendChat()">
            <button onclick="app.actions.sendChat()" class="w-12 h-12 bg-blue-600 rounded-full text-white flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- 5. NAVIGATION -->
    <nav id="app-nav">
        <button onclick="app.ui.tab('home')" class="nav-btn active" id="btn-home"><i class="fas fa-home"></i><span>HOME</span></button>
        <button onclick="app.ui.tab('tasks')" class="nav-btn" id="btn-tasks"><i class="fas fa-clipboard-list"></i><span>VI·ªÜC</span></button>
        <button onclick="app.ui.tab('sx')" class="nav-btn" id="btn-sx"><i class="fas fa-industry"></i><span>SX</span></button>
        <button onclick="app.ui.tab('th')" class="nav-btn" id="btn-th"><i class="fas fa-box-open"></i><span>TH</span></button>
        <button onclick="app.ui.tab('team')" class="nav-btn" id="btn-team"><i class="fas fa-users"></i><span>TEAM</span></button>
        <button onclick="app.ui.openChat()" class="nav-btn"><i class="fas fa-comments"></i><span>CHAT</span></button>
    </nav>

    <!-- 6. MODALS -->
    <div id="settings-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('settings-modal')">
        <div class="modal-box">
            <h3 class="font-black text-xl mb-6">C√†i ƒë·∫∑t</h3>
            <div class="space-y-4">
                <button onclick="app.actions.exportAll()" class="btn bg-white text-blue-700 border border-blue-200 shadow-sm"><i class="fas fa-file-export"></i> XU·∫§T B√ÅO C√ÅO NG√ÄY</button>
                <div id="admin-tools" class="hidden space-y-3 border-t pt-3">
                    <p class="label border-b pb-2">Qu·∫£n tr·ªã vi√™n</p>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3">
                         <div class="flex gap-2"><input id="new-emp-name" placeholder="T√™n NV" class="input-box text-xs bg-white"><input id="new-emp-pin" placeholder="PIN" class="input-box text-xs w-20 text-center bg-white"></div>
                         <button onclick="app.actions.addEmployee()" class="btn btn-blue text-xs">Th√™m Nh√¢n S·ª±</button>
                    </div>
                    <button onclick="app.actions.addHouse()" class="btn bg-slate-100 text-slate-700 border text-xs">Th√™m Nh√† N·∫•m</button>
                </div>
                <button onclick="app.actions.logout()" class="btn btn-red text-xs mt-4">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>
    
    <!-- Report Task -->
    <div id="report-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('report-modal')"><div class="modal-box"><h3 class="font-bold text-center mb-4">B√°o c√°o</h3><input type="hidden" id="report-task-id"><input type="number" id="report-val" placeholder="S·ªë l∆∞·ª£ng" class="input-box text-center text-3xl mb-4"><input id="report-note" class="input-box mb-4" placeholder="Ghi ch√∫"><div class="grid grid-cols-2 gap-2"><button onclick="app.actions.submitReport('completed')" class="btn btn-green">Ho√†n th√†nh</button><button onclick="app.actions.submitReport('unfinished')" class="btn btn-orange">Ch∆∞a xong</button></div></div></div>
    
    <div id="modal-temp" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-temp')"><div class="modal-box text-center"><h3 class="font-bold mb-6 text-xl">Nhi·ªát ƒë·ªô <span id="temp-name" class="text-orange-500"></span></h3><input type="hidden" id="temp-id"><div class="grid grid-cols-2 gap-4 mb-6"><div><label class="label text-center">S√°ng</label><input id="temp-am" type="number" class="input-box text-center text-2xl"></div><div><label class="label text-center">Chi·ªÅu</label><input id="temp-pm" type="number" class="input-box text-center text-2xl"></div></div><button onclick="app.actions.saveTemp()" class="btn btn-orange">L∆∞u</button></div></div>
    
    <div id="modal-leave" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-leave')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg">Xin ngh·ªâ</h3><div class="space-y-3"><input id="leave-date" type="date" class="input-box"><select id="leave-reason" class="input-box"><option>·ªêm</option><option>Vi·ªác ri√™ng</option></select><button onclick="app.actions.submitHR('LEAVE')" class="btn btn-blue">G·ª≠i</button></div></div></div>
    <div id="modal-buy" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-buy')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg">ƒê·ªÅ xu·∫•t mua</h3><div class="space-y-3"><input type="text" id="pur-item" placeholder="T√™n h√†ng..." class="input-box"><div class="grid grid-cols-2 gap-3"><input type="number" id="pur-qty" placeholder="SL" class="input-box"><input type="text" id="pur-unit" placeholder="ƒê∆°n v·ªã" class="input-box"></div><button onclick="app.actions.submitHR('PURCHASE')" class="btn btn-green">G·ª≠i</button></div></div></div>
    <div id="modal-approve" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-approve')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg text-red-600">Duy·ªát ƒë∆°n</h3><div id="approval-list" class="space-y-3"></div></div></div>
    <div id="modal-add-sop" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-add-sop')"><div class="modal-box"><h3 class="font-bold mb-4">Th√™m Quy Tr√¨nh</h3><div class="space-y-3"><input id="new-sop-name" placeholder="T√™n c√¥ng vi·ªác" class="input-box"><input id="new-sop-val" placeholder="ƒê·ªãnh m·ª©c (S·ªë)" class="input-box"><button onclick="app.actions.addSOP()" class="btn-primary">L∆∞u</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fbConfig = { apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", authDomain: "ong5mushroom-vietnam.firebaseapp.com", projectId: "ong5mushroom-vietnam", storageBucket: "ong5mushroom-vietnam.firebasestorage.app", messagingSenderId: "931399604992", appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" };
        const appInstance = initializeApp(fbConfig);
        const db = getFirestore(appInstance);
        const ROOT = "artifacts/namong5_production/public/data";

        window.app = {
            data: { employees: [], houses: [], chat: [], tasks: [], production: [], harvest: [], hr: [] },
            user: JSON.parse(localStorage.getItem('n5_v90_user')) || null,
            assignMode: 'ind',
            currentPhoto: null,

            ui: {
                showModal: id => document.getElementById(id).classList.remove('hidden'),
                closeModal: id => document.getElementById(id).classList.add('hidden'),
                openChat: () => document.getElementById('chat-layer').style.display = 'flex',
                closeChat: () => document.getElementById('chat-layer').style.display = 'none',
                
                tab: (id) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    document.getElementById('view-'+id).classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));
                    const btn = document.querySelector(`button[onclick="app.ui.tab('${id}')"]`);
                    if(btn) btn.classList.add('nav-active');
                },

                toggleAssign: () => {
                    const m = document.getElementById('assign-mode').value;
                    document.getElementById('assign-ind-zone').classList.toggle('hidden', m !== 'ind');
                    document.getElementById('assign-team-zone').classList.toggle('hidden', m !== 'team');
                },

                calcTH: () => {
                    const ids = ['th-b2','th-a1','th-a2','th-b1','th-d1','th-ht','th-abf','th-b2f','th-b1f'];
                    let sum = 0; let html = '';
                    ids.forEach(id => sum += Number(document.getElementById(id).value)||0);
                    if(sum>0) ids.forEach(id => { const v=Number(document.getElementById(id).value)||0; if(v>0) html+=`<div class="stat-badge">${id.replace('th-','').toUpperCase()}: ${((v/sum)*100).toFixed(0)}%</div>`; });
                    document.getElementById('th-total-display').innerText = sum + ' kg';
                    document.getElementById('th-percent-display').innerHTML = html;
                }
            },

            init: () => {
                const status = document.getElementById('login-status');
                setTimeout(() => {
                    if (app.data.employees.length === 0) {
                        status.innerText = "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu...";
                        status.classList.replace('text-yellow-500', 'text-red-500');
                        document.getElementById('rescue-btn').classList.remove('hidden');
                    }
                }, 3000);

                signInAnonymously(getAuth(appInstance)).then(() => {
                    status.innerText = "ƒê√£ k·∫øt n·ªëi";
                    app.sync();
                });
                document.getElementById('sx-date').valueAsDate = new Date();
            },

            sync: () => {
                onSnapshot(collection(db, `${ROOT}/employees`), s => {
                    app.data.employees = s.docs.map(d => ({...d.data(), _id: d.id}));
                    app.renderLogin();
                    if(app.user) app.renderTeam();
                });
                ['houses', 'tasks', 'production_logs', 'harvest_logs', 'hr_requests'].forEach(col => {
                    onSnapshot(collection(db, `${ROOT}/${col}`), s => {
                        const key = col.includes('logs') ? col.split('_')[0] : col;
                        app.data[key] = s.docs.map(d => ({...d.data(), _id: d.id}));
                        if(app.user) app.renderContent();
                    });
                });
                onSnapshot(query(collection(db, `${ROOT}/chat`), orderBy("time", "asc"), limit(50)), s => {
                    app.data.chat = s.docs.map(d => d.data());
                    if(app.user) app.renderChat();
                });
            },

            renderLogin: () => {
                const s = document.getElementById('login-user');
                const btn = document.getElementById('login-btn');
                const pin = document.getElementById('login-pin');
                if (app.data.employees.length > 0) {
                    s.innerHTML = '<option value="">-- Ch·ªçn t√™n --</option>' + app.data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                    s.disabled = false;
                    pin.disabled = false;
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    document.getElementById('rescue-btn').classList.add('hidden');
                }
                
                if(app.user) {
                    document.getElementById('login-overlay').classList.add('hidden');
                    app.renderContent();
                }
            },

            doLogin: () => {
                const id = document.getElementById('login-user').value;
                const pin = document.getElementById('login-pin').value.trim();
                const emp = app.data.employees.find(e => String(e.id) === String(id) && String(e.pin).trim() === String(pin));
                if(emp) {
                    app.user = emp; localStorage.setItem('n5_v90_user', JSON.stringify(emp));
                    document.getElementById('login-overlay').classList.add('hidden'); app.renderContent();
                } else alert("Sai m√£ PIN!");
            },

            renderContent: () => {
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role);
                document.getElementById('head-user').innerText = app.user.name;
                document.getElementById('head-role').innerText = app.user.role;

                if(isAdmin) {
                    document.getElementById('admin-cog').classList.remove('hidden');
                    if(['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role)) document.getElementById('admin-tools').classList.remove('hidden');
                    if(['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω', 'T·ªï tr∆∞·ªüng'].includes(app.user.role)) document.getElementById('admin-task-form').classList.remove('hidden');
                }

                // Houses
                document.getElementById('house-list').innerHTML = app.data.houses.map(h => `
                    <div class="card flex justify-between items-center !p-4 !mb-2 border-l-4 border-blue-500 mb-3">
                        <div><p class="font-bold text-sm">${h.name}</p><p class="text-[10px] text-slate-400 font-bold mt-1">AM: ${h.temp?.am||'-'} | PM: ${h.temp?.pm||'-'}</p></div>
                        <button onclick="app.actions.openTemp('${h._id}', '${h.name}')" class="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-temperature-high text-xs"></i></button>
                    </div>`).join('');
                
                const hOpts = app.data.houses.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
                const s1 = document.getElementById('th-area'); if(s1.innerHTML==="") s1.innerHTML=hOpts;
                const mh = document.getElementById('house-multi-select'); if(mh.innerHTML==="") mh.innerHTML=app.data.houses.map(h => `<label class="flex items-center gap-1 text-[10px] p-2 border rounded"><input type="checkbox" value="${h.name}" name="h-check"> ${h.name}</label>`).join('');

                // Tasks
                let tasks = app.data.tasks.filter(t => t.status !== 'completed');
                if(!isAdmin) tasks = tasks.filter(t => t.assignee == app.user.id);
                document.getElementById('task-list').innerHTML = tasks.map(t => {
                     const isStarted = t.status === 'in_progress';
                     const canAction = t.assignee == app.user.id;
                     return `<div class="card border-l-4 border-indigo-500 !p-3 !mb-2"><div class="flex justify-between items-center"><div><p class="font-bold text-xs">${t.title} (${t.houseId})</p><p class="text-[9px] text-slate-400">${new Date(t.time).toLocaleTimeString()}</p></div><div class="flex gap-2">${isAdmin?`<button onclick="app.actions.delTask('${t._id}')" class="text-red-400"><i class="fas fa-trash"></i></button>`:''}${canAction ? (isStarted ? `<button onclick="app.actions.openReport('${t._id}', '${t.title}')" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold">B√ÅO C√ÅO</button>` : `<button onclick="app.actions.startTask('${t._id}')" class="bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold">NH·∫¨N VI·ªÜC</button>`) : ''}</div></div></div>`;
                }).join('');

                // Logs
                document.getElementById('sx-log-list').innerHTML = app.data.production.slice(0,5).map(l => `<div class="text-[10px] p-2 bg-slate-50 rounded mb-1 border flex justify-between"><span>${l.action} ${l.type}</span><span>${l.qty}</span></div>`).join('');
                document.getElementById('th-log-list').innerHTML = app.data.harvest.slice(0,5).map(l => `<div class="text-[10px] p-2 bg-slate-50 rounded mb-1 border flex justify-between"><span>${l.area}</span><span>${l.total} kg</span></div>`).join('');
            
                // Stats
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('stat-online').innerText = app.data.employees.filter(e => e.lastLogin === today).length;
                const yieldKg = app.data.harvest.filter(h => new Date(h.time).toDateString() === new Date().toDateString()).reduce((a,b) => a + (b.total||0), 0);
                document.getElementById('stat-yield').innerText = yieldKg.toLocaleString();
            },

            renderTeam: () => {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('team-list').innerHTML = app.data.employees.map(e => `
                    <div class="card flex justify-between items-center !p-3 !mb-2 border-l-4 ${e.lastLogin===today?'border-green-500':'border-slate-200'}">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-xs">${e.name.charAt(0)}</div><p class="text-xs font-bold text-slate-700">${e.name}</p></div>
                        ${e.lastLogin===today ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                    </div>`).join('');
            },

            renderChat: () => {
                document.getElementById('chat-box').innerHTML = app.data.chat.map(m => `<div class="chat-bubble ${m.senderId === app.user.id ? 'chat-me' : 'chat-other'}"><p class="text-[9px] font-bold opacity-50 mb-1">${m.senderName}</p>${m.text}</div>`).join('');
            },

            renderAdmin: () => {
                document.getElementById('sop-list').innerHTML = (app.data.sop||[]).map(s => `<option value="${s.title}">`).join('');
                document.getElementById('assign-ind-zone').innerHTML = app.data.employees.map(e => `<label class="flex items-center gap-2 p-2"><input type="checkbox" name="u-check" value="${e.id}"> <span class="text-xs font-bold">${e.name}</span></label>`).join('');
            },

            actions: {
                seedAdmin: async () => { if(confirm("T·∫°o Admin 9999?")) { await addDoc(collection(db, `${ROOT}/employees`), { id: 9999, name: "Admin", pin: "9999", role: "Gi√°m ƒë·ªëc" }); location.reload(); } },
                logout: () => { localStorage.removeItem('n5_v90_user'); location.reload(); },
                
                // Tasks
                createTask: async () => {
                    const title = document.getElementById('task-title').value;
                    const houses = Array.from(document.querySelectorAll('input[name="h-check"]:checked')).map(i => i.value);
                    const uids = Array.from(document.querySelectorAll('input[name="u-check"]:checked')).map(i => i.value);
                    if(!title || houses.length === 0 || uids.length === 0) return alert("Thi·∫øu th√¥ng tin!");
                    for(let h of houses) { for(let u of uids) { await addDoc(collection(db, `${ROOT}/tasks`), { title, houseId: h, assignee: u, status: 'pending', time: Date.now() }); } }
                    alert("ƒê√£ giao!");
                },
                startTask: async (id) => updateDoc(doc(db, `${ROOT}/tasks`, id), { status: 'in_progress', startTime: Date.now() }),
                delTask: async (id) => { if(confirm("X√≥a?")) deleteDoc(doc(db, `${ROOT}/tasks`, id)); },
                openReport: (id, title) => { document.getElementById('report-task-id').value = id; document.getElementById('report-title').innerText = title; app.ui.showModal('report-modal'); },
                submitReport: async (status) => {
                    const id = document.getElementById('report-task-id').value;
                    await updateDoc(doc(db, `${ROOT}/tasks`, id), { status, actual: document.getElementById('report-val').value, finishTime: Date.now() });
                    app.ui.hideModal('report-modal');
                },

                // SX & TH
                setSXMode: (m) => {
                    document.getElementById('sx-action').value = m;
                    document.getElementById('btn-sx-nhap').className = m==='NH·∫¨P' ? 'flex-1 py-3 rounded-lg text-xs font-black bg-blue-600 text-white shadow-md' : 'flex-1 py-3 rounded-lg text-xs font-black text-slate-400';
                    document.getElementById('btn-sx-xuat').className = m==='XU·∫§T' ? 'flex-1 py-3 rounded-lg text-xs font-black bg-orange-500 text-white shadow-md' : 'flex-1 py-3 rounded-lg text-xs font-black text-slate-400';
                },
                submitSX: async () => {
                    const d = { 
                        action: document.getElementById('sx-action').value, 
                        date: document.getElementById('sx-date').value, 
                        type: document.getElementById('sx-type').value, 
                        qty: Number(document.getElementById('sx-qty').value), 
                        batch: document.getElementById('sx-batch').value, 
                        dest: document.getElementById('sx-dest').value, 
                        bad: Number(document.getElementById('sx-bad').value), 
                        reuse: Number(document.getElementById('sx-reuse').value), 
                        user: app.user.name, time: Date.now() 
                    };
                    await addDoc(collection(db, `${ROOT}/production_logs`), d); alert("ƒê√£ l∆∞u!");
                },
                submitTH: async () => {
                    const details = {};
                    ['b2','a1','a2','b1','d1','ht','abf','b2f','b1f'].forEach(f => details[f] = Number(document.getElementById('th-'+f).value)||0);
                    const total = Object.values(details).reduce((a,b)=>a+b,0);
                    await addDoc(collection(db, `${ROOT}/harvest_logs`), { 
                        area: document.getElementById('th-area').value, 
                        details, total, 
                        note: document.getElementById('th-note').value,
                        note_err: document.getElementById('th-note-err').value,
                        note_snack: document.getElementById('th-note-snack').value,
                        xuat_say: document.getElementById('th-xuat-say').value,
                        snack_tp: document.getElementById('th-snack-tp').value,
                        user: app.user.name, time: Date.now() 
                    }); 
                    alert("ƒê√£ l∆∞u!");
                },

                // Other
                sendChat: async () => { const i = document.getElementById('chat-input'); if(!i.value) return; await addDoc(collection(db, `${ROOT}/chat`), { text: i.value, senderId: app.user.id, senderName: app.user.name, time: Date.now() }); i.value = ''; },
                checkIn: async (shift) => { const today = new Date().toISOString().split('T')[0]; await addDoc(collection(db, `${ROOT}/attendance_logs`), { uid: app.user.id, name: app.user.name, shift, date: today }); await updateDoc(doc(db, `${ROOT}/employees`, app.user._id), { lastLogin: today }); alert("ƒê√£ ƒëi·ªÉm danh!"); },
                submitHR: async (type) => { await addDoc(collection(db, `${ROOT}/hr_requests`), { type, requester: app.user.name, status: 'pending', content: type==='LEAVE' ? document.getElementById('leave-date').value : document.getElementById('buy-item').value }); alert("ƒê√£ g·ª≠i!"); },
                approve: async (id, status) => { await updateDoc(doc(db, `${ROOT}/hr_requests`, id), { status }); alert("ƒê√£ x·ª≠ l√Ω!"); },
                openTemp: (id, name) => { document.getElementById('temp-id').value = id; document.getElementById('temp-name').innerText = name; app.ui.showModal('modal-temp'); },
                saveTemp: async () => { const id = document.getElementById('temp-id').value; await updateDoc(doc(db, `${ROOT}/houses`, id), { 'temp.am': document.getElementById('temp-am').value, 'temp.pm': document.getElementById('temp-pm').value }); alert("ƒê√£ l∆∞u!"); app.ui.hideModal('modal-temp'); },
                addEmployee: async () => { await addDoc(collection(db, `${ROOT}/employees`), { id: Number(document.getElementById('new-emp-id').value), name: document.getElementById('new-emp-name').value, pin: document.getElementById('new-emp-pin').value, role: 'Nh√¢n vi√™n', score: 100 }); alert("ƒê√£ th√™m!"); },
                addSOP: async () => { await addDoc(collection(db, `${ROOT}/sop`), { title: document.getElementById('new-sop-name').value, sop: Number(document.getElementById('new-sop-val').value) }); alert("ƒê√£ th√™m!"); },
                addHouse: async () => { const name = prompt("Nh·∫≠p t√™n nh√†:"); if(name) await addDoc(collection(db, `${ROOT}/houses`), { name, temp: {am:0, pm:0} }); },
                fillSOP: () => { const val = document.getElementById('task-title').value; const item = (app.data.sop||[]).find(s => s.title === val); if(item) document.getElementById('task-target').value = item.sop; },
                exportAll: () => { alert("Xu·∫•t b√°o c√°o..."); },
                exportSX: () => { alert("Xu·∫•t SX..."); },
                exportTH: () => { alert("Xu·∫•t TH..."); }
            }
        };
        
        window.onload = app.init;
    </script>
</body>
</html>
