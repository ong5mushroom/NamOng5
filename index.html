<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>N·∫•m √îng 5 V103 - Platinum Supreme</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --blue: #2563eb; --header-h: 90px; --nav-h: 80px; --bg: #f8fafc; --shiitake: #78350f; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #334155; margin: 0; height: 100vh; overflow: hidden; user-select: none; }
        
        /* Layout Structure */
        #app-header { height: var(--header-h); background: white; border-bottom: 1px solid #e2e8f0; position: fixed; top: 0; left: 0; right: 0; z-index: 100; padding-top: env(safe-area-inset-top); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        #app-view-container { position: fixed; top: var(--header-h); bottom: var(--nav-h); left: 0; right: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 16px; padding-bottom: 40px; z-index: 10; }
        #app-nav { height: var(--nav-h); background: white; border-top: 1px solid #e2e8f0; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); display: flex; justify-content: space-around; align-items: center; }

        /* Helpers */
        .hidden { display: none !important; }
        .card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .input-box { width: 100%; background: #f1f5f9; border: 1px solid #cbd5e1; padding: 12px; border-radius: 12px; font-weight: 600; outline: none; font-size: 14px; transition: all 0.2s; }
        .input-box:focus { border-color: var(--blue); background: white; ring: 2px solid #bfdbfe; }
        .btn-primary { background: var(--blue); color: white; font-weight: 800; padding: 14px; border-radius: 14px; width: 100%; text-transform: uppercase; font-size: 12px; box-shadow: 0 4px 6px rgba(37,99,235,0.2); }
        .label { display: block; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
        
        .nav-btn { color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 9px; font-weight: 700; transition: color 0.2s; }
        .nav-btn.active { color: var(--blue); transform: translateY(-2px); }
        
        /* Sub-tabs */
        .sub-tab-btn { flex: 1; padding: 10px; font-size: 11px; font-weight: 800; text-align: center; border-radius: 10px; color: #64748b; transition: all 0.2s; }
        .sub-tab-btn.active { background: white; color: var(--blue); shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Login */
        #login-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-wait { background: #eab308; animation: pulse 1s infinite; }
        .status-ok { background: #22c55e; }

        /* Khung Chat (Platinum Fix) */
        #chat-layer { position: fixed; inset: 0; background: #efeae2; z-index: 2000; display: none; flex-direction: column; }
        .chat-bg { background-color: #efeae2; background-image: radial-gradient(var(--shiitake) 0.5px, transparent 0.5px); background-size: 24px 24px; }
        #chat-box { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 2010; }
        .chat-bubble { max-width: 82%; padding: 10px 14px; border-radius: 16px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; line-height: 1.4; }
        .chat-me { background: #dcf8c6; color: #1f2937; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-other { background: white; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-system { background: #fee2e2; color: #991b1b; align-self: center; border-radius: 8px; font-size: 11px; font-weight: 700; text-align: center; max-width: 90%; border: 1px dashed #f87171; padding: 8px 16px; margin: 5px 0; }
        
        .chat-sender-tag { font-size: 9px; font-weight: 900; color: var(--shiitake); margin-bottom: 2px; text-transform: uppercase; display: flex; align-items: center; gap: 4px; }
        .chat-avatar { width: 22px; height: 22px; border-radius: 50%; background: var(--blue); color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; border: 1px solid white; }
        .chat-input-area { background: white; padding: 12px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; padding-bottom: calc(12px + env(safe-area-inset-bottom)); flex-shrink: 0; z-index: 2020; }

        /* Modals */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 16px; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; max-height: 85vh; overflow-y: auto; }
        .input-mini { text-align: center; padding: 8px 4px; font-size: 13px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #msg-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 12px; z-index: 9999; font-size: 13px; font-weight: 600; display: none; text-align: center; min-width: 240px; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div id="msg-box"></div>

    <!-- 1. LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="w-24 h-24 bg-blue-600 rounded-[28px] flex items-center justify-center text-white text-5xl font-black mb-6 shadow-xl">5</div>
        <h1 class="text-3xl font-black text-slate-800 mb-1 tracking-tight">N·∫•m √îng 5</h1>
        <p class="text-xs font-bold text-blue-500 mb-10 tracking-widest uppercase">‚óè V103 Platinum Final</p>
        
        <div class="w-full max-w-sm space-y-4">
            <div id="login-status" class="text-center text-xs font-bold text-slate-400 mb-2 flex items-center justify-center">
                <span class="status-dot status-wait"></span> <span id="status-text">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</span>
            </div>
            <select id="login-user" class="input-box text-center appearance-none" disabled><option value="">Vui l√≤ng ƒë·ª£i...</option></select>
            <input id="login-pin" type="password" placeholder="Nh·∫≠p PIN b·∫£o m·∫≠t" class="input-box text-center text-xl tracking-widest" disabled maxlength="6" inputmode="numeric">
            <button id="login-btn" onclick="app.doLogin()" class="btn-primary opacity-50 cursor-not-allowed" disabled>V√ÄO H·ªÜ TH·ªêNG</button>
            <button id="rescue-btn" onclick="app.actions.seedAdmin()" class="hidden w-full border-2 border-red-100 text-red-500 py-3 rounded-xl font-bold text-xs mt-4 uppercase">KH·ªûI T·∫†O ADMIN (9999)</button>
        </div>
        <div class="flex gap-4 mt-12">
            <button onclick="location.reload()" class="text-xs text-blue-500 font-bold underline uppercase">T·∫£i l·∫°i</button>
            <button onclick="localStorage.clear(); location.reload()" class="text-xs text-slate-400 font-bold underline uppercase">X√≥a Cache</button>
        </div>
    </div>

    <!-- 2. HEADER -->
    <header id="app-header">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white w-9 h-9 rounded-xl flex items-center justify-center font-black shadow-md text-lg">5</div>
            <div><h1 class="text-xs font-black uppercase text-slate-800 tracking-wide">N·∫•m √îng 5</h1><p class="text-[8px] text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded inline-block mt-0.5 tracking-tighter uppercase font-black">‚óè Realtime Online</p></div>
        </div>
        <div class="flex items-center gap-2">
            <div class="text-right"><p id="head-user" class="font-bold text-xs text-slate-700">...</p><p id="head-role" class="text-[9px] text-blue-500 font-bold uppercase">...</p></div>
            <button onclick="app.ui.showModal('settings-modal')" class="w-9 h-9 bg-slate-50 rounded-full border flex items-center justify-center text-slate-500 active:bg-slate-100 shadow-sm"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <!-- 3. MAIN CONTAINER -->
    <div id="app-view-container">
        <!-- HOME -->
        <div id="view-home" class="view-section hidden">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="card border-l-4 border-blue-500 text-center !py-4 !mb-0 shadow-sm"><p class="label">Nh√¢n s·ª±</p><p class="text-2xl font-black text-blue-600" id="stat-online">0</p></div>
                <div class="card border-l-4 border-green-500 text-center !py-4 !mb-0 shadow-sm"><p class="label">T·ªïng H√°i (Kg)</p><p class="text-2xl font-black text-green-600" id="stat-yield">0</p></div>
            </div>
            <div class="card !p-4 border border-yellow-100 shadow-sm"><h3 class="text-xs font-black text-yellow-600 uppercase mb-3"><i class="fas fa-crown"></i> B·∫£ng V√†ng Thi ƒêua</h3><div id="leaderboard" class="space-y-2 text-xs"></div></div>
            <div id="house-list" class="space-y-3"></div>
        </div>

        <!-- TASKS -->
        <div id="view-tasks" class="view-section hidden">
             <div id="admin-task-form" class="hidden card border-2 border-blue-50 shadow-md">
                <div class="flex justify-between items-center mb-3"><span class="text-xs font-black text-blue-600 uppercase">Ban h√†nh l·ªánh m·ªõi</span><select id="assign-mode" onchange="app.ui.toggleAssign()" class="text-[10px] font-bold bg-slate-100 p-1 rounded"><option value="ind">C√° nh√¢n</option><option value="team">T·ªï</option></select></div>
                <div class="space-y-3">
                    <input id="task-title" placeholder="T√™n vi·ªác..." class="input-box bg-white text-sm" list="sop-list" onchange="app.actions.fillSOP()"><datalist id="sop-list"></datalist>
                    <div><p class="label">Ch·ªçn Nh√† (T√≠ch ch·ªçn)</p><div id="house-multi-select" class="grid grid-cols-3 gap-1 bg-slate-50 p-2 rounded border max-h-32 overflow-y-auto"></div></div>
                    <div class="grid grid-cols-2 gap-2"><div><p class="label">ƒê·ªãnh m·ª©c</p><input type="number" id="task-target" class="input-box bg-white text-center"></div></div>
                    <div id="assign-ind-zone" class="max-h-32 overflow-y-auto border p-2 rounded bg-slate-50 grid grid-cols-2 gap-1"></div>
                    <div id="assign-team-zone" class="hidden bg-slate-50 p-2 rounded-xl border space-y-2 text-xs font-bold"><label class="flex items-center gap-2"><input type="radio" name="team-radio" value="T·ªï S·∫£n Xu·∫•t" checked> T·ªï S·∫£n Xu·∫•t</label><label class="flex items-center gap-2"><input type="radio" name="team-radio" value="T·ªï Thu Ho·∫°ch"> T·ªï Thu Ho·∫°ch</label></div>
                    <button onclick="app.actions.createTask()" class="btn-primary bg-slate-800 mt-2">Giao Vi·ªác & Ban L·ªánh</button>
                </div>
            </div>
            <div id="task-list" class="space-y-4"></div>
        </div>

        <!-- THU HO·∫†CH (N√¢ng c·∫•p th√™m √¥ Ch√¢n n·∫•m) -->
        <div id="view-th" class="view-section hidden">
             <div class="flex bg-slate-200 p-1 rounded-xl mb-4 shadow-inner">
                 <button onclick="app.ui.setTHSubTab('harvest')" id="sub-btn-harvest" class="sub-tab-btn active uppercase">Thu ho·∫°ch n·∫•m</button>
                 <button onclick="app.ui.setTHSubTab('export')" id="sub-btn-export" class="sub-tab-btn uppercase">Xu·∫•t kho n·∫•m</button>
             </div>

             <!-- Tab 1: Nh·∫≠p s·∫£n l∆∞·ª£ng h√°i -->
             <div id="th-sub-harvest" class="space-y-3">
                 <div class="flex justify-between items-center px-1 mb-1">
                     <h2 class="font-black text-slate-800 uppercase text-xs">Ghi nh·∫≠n s·∫£n l∆∞·ª£ng h√°i</h2>
                     <button id="btn-export-th" onclick="app.actions.exportTH()" class="hidden text-[9px] font-bold text-green-600 bg-white border px-2 py-1 rounded-lg">Excel</button>
                 </div>
                 <div class="card border-2 border-green-50 shadow-md">
                     <div class="space-y-3">
                         <div><p class="label">Nh√† tr·ªìng</p><select id="th-area" class="input-box bg-white font-bold text-green-700 p-2"></select></div>
                         <div class="bg-slate-50 p-2 rounded-2xl border shadow-inner">
                             <div class="grid grid-cols-5 gap-1.5 mb-2 items-end">
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase">B2</label><input type="number" id="th-b2" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase">A1</label><input type="number" id="th-a1" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase">A2</label><input type="number" id="th-a2" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase">B1</label><input type="number" id="th-b1" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-blue-600">Ch√¢n</label><input type="number" id="th-chan" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            </div>
                             <div class="grid grid-cols-5 gap-1 items-end">
                                <div><label class="text-center text-[9px] font-black block mb-1">D1</label><input type="number" id="th-d1" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1">HT</label><input type="number" id="th-ht" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1">ABF</label><input type="number" id="th-abf" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1">B2F</label><input type="number" id="th-b2f" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1">B1F</label><input type="number" id="th-b1f" class="input-box input-mini" oninput="app.ui.calcTH()"></div>
                            </div>
                             <div id="th-percent-display" class="grid grid-cols-3 gap-1 mt-3 pt-2 border-t text-[8px] text-slate-500 font-bold uppercase"></div>
                         </div>
                         <div class="flex justify-between items-center bg-green-50 p-4 rounded-2xl border border-green-100"><span class="font-bold text-green-800 text-xs uppercase">T·ªïng h√°i bao g·ªìm ch√¢n:</span><span id="th-total-display" class="font-black text-2xl text-green-600">0 kg</span></div>
                         <div class="grid grid-cols-2 gap-3"><div><p class="label text-red-500">H·ªßy ch√¢n (kg)</p><input type="number" id="th-huy-chan" class="input-box bg-white text-center p-2" placeholder="0"></div><div><p class="label text-orange-500">ƒê·ªïi tr·∫£ (kg)</p><input type="number" id="th-doi-tra" class="input-box bg-white text-center p-2" placeholder="0"></div></div>
                         <button onclick="app.actions.submitTH()" class="btn-primary bg-green-600 mt-1 uppercase tracking-widest shadow-green-200">Ghi nh·∫≠n thu ho·∫°ch</button>
                     </div>
                 </div>
             </div>

             <!-- Tab 2: Xu·∫•t kho n·∫•m -->
             <div id="th-sub-export" class="space-y-3 hidden">
                 <h2 class="font-black text-slate-800 uppercase text-xs px-1">Xu·∫•t kho b√°n h√†ng & T·ªìn th·ª±c t·∫ø</h2>
                 <div class="card border-2 border-blue-50 shadow-md">
                     <div id="export-matrix" class="space-y-3"></div>
                     <button onclick="app.actions.submitExport()" class="btn-primary bg-blue-600 mt-6 uppercase shadow-blue-200">Ghi nh·∫≠n xu·∫•t kho</button>
                 </div>
             </div>
             <div id="th-log-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- S·∫¢N XU·∫§T -->
        <div id="view-sx" class="view-section hidden">
            <div class="flex justify-between items-center px-1 mb-2">
                <h2 class="font-black text-slate-800 uppercase text-sm">S·∫£n Xu·∫•t Ph√¥i</h2>
                <button id="btn-export-sx" onclick="app.actions.exportSX()" class="hidden text-[10px] font-bold text-blue-600 bg-white border px-3 py-1 rounded-lg">Excel</button>
            </div>
            <div class="card border-2 border-blue-50 shadow-md">
                <div class="flex bg-slate-100 p-1 rounded-xl mb-4 shadow-inner">
                    <button onclick="app.ui.setSXMode('NH·∫¨P')" id="btn-sx-nhap" class="flex-1 py-3 rounded-lg text-xs font-black bg-blue-600 text-white shadow-md transition uppercase">Nh·∫≠p</button>
                    <button onclick="app.ui.setSXMode('XU·∫§T')" id="btn-sx-xuat" class="flex-1 py-3 rounded-lg text-xs font-black text-slate-400 uppercase">Xu·∫•t</button>
                </div>
                <input type="hidden" id="sx-action" value="NH·∫¨P">
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3"><div><p class="label">Ng√†y</p><input type="date" id="sx-date" class="input-box bg-white p-2 text-xs"></div><div><p class="label">L√¥ c·∫•y</p><input id="sx-batch" class="input-box bg-white text-center p-2 text-xs" placeholder="..."></div></div>
                    <div><p class="label">Lo·∫°i Ph√¥i</p><input type="text" id="sx-type" list="phoi-list-sx" class="input-box bg-white p-2 text-xs" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p..."><datalist id="phoi-list-sx"><option value="049 ƒê·∫°t"><option value="049 TD"></datalist></div>
                    <div class="grid grid-cols-3 gap-2"><div><p class="label">S·ªë l∆∞·ª£ng</p><input type="number" id="sx-qty" class="input-box bg-white text-center font-bold text-lg p-2"></div><div><p class="label text-red-500">H·ªßy</p><input type="number" id="sx-bad" placeholder="0" class="input-box bg-white text-center p-2"></div><div><p class="label text-green-600">T·∫≠n d·ª•ng</p><input type="number" id="sx-reuse" placeholder="0" class="input-box bg-white text-center p-2"></div></div>
                    <div><p class="label">N∆°i Nh·∫≠p/Xu·∫•t</p><input type="text" id="sx-dest" placeholder="..." class="input-box bg-white p-2 text-xs"></div>
                    <button onclick="app.actions.submitSX()" class="btn-primary mt-2">L∆∞u d·ªØ li·ªáu SX</button>
                </div>
            </div>
            <div id="sx-log-list" class="space-y-2"></div>
        </div>

        <!-- TEAM -->
        <div id="view-team" class="view-section hidden">
             <div class="card border border-blue-100 shadow-sm"><p class="label mb-3 text-center">ƒêI·ªÇM DANH H√ÄNG NG√ÄY</p><div class="grid grid-cols-2 gap-3"><button onclick="app.actions.checkIn('S√°ng')" class="btn-primary bg-yellow-500 text-white shadow-yellow-100 uppercase">‚òÄÔ∏è Ca S√°ng</button><button onclick="app.actions.checkIn('Chi·ªÅu')" class="btn-primary bg-indigo-500 text-white shadow-indigo-100 uppercase">üåô Ca Chi·ªÅu</button></div></div>
             <div class="card bg-slate-50 border border-slate-200 shadow-sm"><p class="label mb-3">H√ÄNH CH√çNH</p><div class="grid grid-cols-2 gap-3"><button onclick="app.ui.showModal('modal-leave')" class="btn-primary bg-white text-slate-600 border shadow-none text-xs uppercase"><i class="fas fa-calendar-times text-red-500"></i> Xin ngh·ªâ</button><button onclick="app.ui.showModal('modal-buy')" class="btn-primary bg-white text-slate-600 border shadow-none text-xs uppercase"><i class="fas fa-shopping-cart text-green-500"></i> Mua h√†ng</button></div></div>
             <button id="btn-remind-att" onclick="app.actions.remindAttendance()" class="hidden w-full text-center text-xs text-blue-600 font-bold mb-4 bg-blue-50 p-2.5 rounded-lg border border-blue-100 uppercase">üì¢ Th√¥ng b√°o nh·∫Øc ƒëi·ªÉm danh qua Chat</button>
             <p class="label px-2 mb-2 tracking-widest font-black text-slate-400">NH√ÇN S·ª∞ TR·ª∞C TUY·∫æN</p>
             <div id="team-list" class="space-y-2 pb-20"></div>
        </div>
    </div>

    <!-- 5. CHAT OVERLAY -->
    <div id="chat-layer" class="shiitake-bg">
        <div class="h-[70px] bg-white border-b flex items-end px-4 pb-3 shadow-sm flex-shrink-0">
             <button onclick="app.ui.closeChat()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center mr-3 active:bg-slate-200 shadow-sm"><i class="fas fa-arrow-left text-slate-600"></i></button>
             <div><h2 class="font-black text-slate-800 text-lg uppercase tracking-tight">Th·∫£o lu·∫≠n n·ªôi b·ªô</h2></div>
        </div>
        <div id="chat-box" class="no-scrollbar flex-1 overflow-y-auto"></div>
        <div class="chat-input-area">
            <input id="chat-input" type="text" class="flex-1 bg-white rounded-full px-5 py-3 text-sm outline-none border border-slate-200 shadow-inner" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeyup="if(event.key==='Enter') app.actions.sendChat()">
            <button onclick="app.actions.sendChat()" class="w-12 h-12 bg-blue-600 rounded-full text-white flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-paper-plane text-xs"></i></button>
        </div>
    </div>

    <!-- 6. NAV -->
    <nav id="app-nav">
        <button onclick="app.ui.tab('home')" class="nav-btn active" id="btn-home"><i class="fas fa-home text-xl"></i><span>HOME</span></button>
        <button onclick="app.ui.tab('tasks')" class="nav-btn" id="btn-tasks"><i class="fas fa-clipboard-list text-xl"></i><span>VI·ªÜC</span></button>
        <button onclick="app.ui.tab('sx')" class="nav-btn" id="btn-sx"><i class="fas fa-industry text-xl"></i><span>SX</span></button>
        <button onclick="app.ui.tab('th')" class="nav-btn" id="btn-th"><i class="fas fa-box-open text-xl"></i><span>TH</span></button>
        <button onclick="app.ui.tab('team')" class="nav-btn" id="btn-team"><i class="fas fa-users text-xl"></i><span>TEAM</span></button>
        <button onclick="app.ui.openChat()" class="nav-btn"><i class="fas fa-comments text-xl"></i><span>CHAT</span></button>
    </nav>

    <!-- 7. MODALS -->
    <div id="settings-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('settings-modal')">
        <div class="modal-box">
            <h3 class="font-black text-xl mb-6 text-slate-800 uppercase tracking-tighter border-b pb-2 text-center">H·ªá th·ªëng</h3>
            <div class="space-y-4">
                <button id="btn-export-all" onclick="app.actions.exportAll()" class="hidden btn-primary bg-white text-blue-700 border border-blue-200 shadow-sm uppercase tracking-widest">Xu·∫•t B√°o C√°o T·ªïng</button>
                <div id="admin-tools" class="hidden space-y-3 border-t pt-3">
                    <p class="label border-b pb-1 italic text-center">Qu·∫£n tr·ªã vi√™n</p>
                    <button onclick="app.ui.showModal('modal-add-emp')" class="btn-primary bg-slate-700 text-xs uppercase shadow-none">Th√™m Nh√¢n S·ª±</button>
                    <button onclick="app.actions.addHouse()" class="btn-primary bg-slate-500 text-xs uppercase shadow-none">Th√™m Nh√† N·∫•m</button>
                    <button onclick="app.ui.showModal('modal-add-sop')" class="btn-primary bg-slate-400 text-xs uppercase shadow-none">Th√™m SOP Quy tr√¨nh</button>
                    <button onclick="app.ui.showModal('modal-approve')" class="btn-primary bg-green-600 text-xs uppercase shadow-none">Duy·ªát ƒê∆°n T·ª´</button>
                </div>
                <button onclick="app.actions.logout()" class="btn-primary bg-red-500 mt-4 uppercase shadow-md">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>
    
    <!-- Sub-Modals -->
    <div id="report-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('report-modal')"><div class="modal-box"><h3 class="font-black text-center mb-4 text-slate-800 uppercase">B√°o c√°o th·ª±c t·∫ø</h3><input type="hidden" id="report-task-id"><div class="mb-4"><p class="label text-center">S·∫£n l∆∞·ª£ng ƒë·∫°t ƒë∆∞·ª£c</p><input type="number" id="report-val" placeholder="0" class="input-box text-center text-3xl"></div><div class="mb-4"><p class="label text-center">Ghi ch√∫</p><input id="report-note" class="input-box" placeholder="..."></div><div class="grid grid-cols-2 gap-2"><button onclick="app.actions.submitReport('completed')" class="btn-primary bg-green-600 shadow-green-100 uppercase">Ho√†n th√†nh</button><button onclick="app.actions.submitReport('unfinished')" class="btn-primary bg-orange-500 shadow-orange-100 uppercase">Ch∆∞a xong</button></div></div></div>
    <div id="modal-house-history" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-house-history')"><div class="modal-box"><h3 class="font-bold text-center mb-2 text-blue-600 uppercase text-sm tracking-tighter">L·ªãch s·ª≠ Nh√†: <span id="history-house-name"></span></h3><div id="history-content" class="text-[11px] space-y-2 max-h-60 overflow-y-auto no-scrollbar tracking-tighter"></div></div></div>
    <div id="modal-temp" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-temp')"><div class="modal-box text-center"><h3 class="font-bold mb-6 text-xl">Nhi·ªát ƒë·ªô <span id="temp-name" class="text-orange-500"></span></h3><input type="hidden" id="temp-id"><div class="grid grid-cols-2 gap-4 mb-6"><div><label class="label text-center">S√°ng</label><input id="temp-am" type="number" class="input-box text-center text-2xl"></div><div><label class="label text-center">Chi·ªÅu</label><input id="temp-pm" type="number" class="input-box text-center text-2xl"></div></div><button onclick="app.actions.saveTemp()" class="btn-primary bg-orange-500 uppercase shadow-none">C·∫≠p nh·∫≠t</button></div></div>
    <div id="modal-leave" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-leave')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg text-blue-600 uppercase tracking-tighter">Xin ngh·ªâ ph√©p</h3><div class="space-y-3"><p class="label">Ng√†y ngh·ªâ</p><input id="leave-date" type="date" class="input-box"><p class="label">L√Ω do ngh·ªâ</p><select id="leave-reason" class="input-box"><option>·ªêm ƒëau</option><option>Vi·ªác ri√™ng gia ƒë√¨nh</option><option>Kh√°c</option></select><button onclick="app.actions.submitHR('LEAVE')" class="btn-primary uppercase tracking-widest">G·ª≠i ƒë∆°n</button></div></div></div>
    <div id="modal-buy" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-buy')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg text-green-600 uppercase tracking-tighter">Mua v·∫≠t t∆∞</h3><div class="space-y-3"><p class="label">N·ªôi dung mua</p><input type="text" id="pur-item" placeholder="..." class="input-box"><button onclick="app.actions.submitHR('PURCHASE')" class="btn-primary bg-green-600 uppercase tracking-widest">G·ª≠i ƒë·ªÅ xu·∫•t</button></div></div></div>
    <div id="modal-approve" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-approve')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg text-red-600 uppercase text-center uppercase tracking-tighter">Ph√™ duy·ªát ƒë∆°n</h3><div id="approval-list" class="space-y-3"></div></div></div>
    <div id="modal-add-sop" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-add-sop')"><div class="modal-box"><h3 class="font-bold mb-4 uppercase tracking-tighter">Th√™m SOP Quy tr√¨nh</h3><div class="space-y-3"><p class="label">T√™n c√¥ng vi·ªác</p><input id="new-sop-name" placeholder="..." class="input-box"><p class="label">ƒê·ªãnh m·ª©c</p><input id="new-sop-val" placeholder="..." class="input-box"><button onclick="app.actions.addSOP()" class="btn-primary uppercase">L∆∞u SOP</button></div></div></div>
    <div id="modal-add-emp" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-add-emp')">
        <div class="modal-box"><h3 class="font-bold mb-4 uppercase tracking-tighter">Th√™m Nh√¢n S·ª±</h3><div class="space-y-3">
            <p class="label">T√™n nh√¢n vi√™n</p><input id="new-emp-name" placeholder="..." class="input-box">
            <div class="grid grid-cols-2 gap-2"><div><p class="label">ID</p><input id="new-emp-id" placeholder="101" class="input-box"></div><div><p class="label">PIN</p><input id="new-emp-pin" placeholder="1234" class="input-box"></div></div>
            <p class="label">Vai tr√≤</p><select id="new-emp-role" class="input-box"><option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option><option value="T·ªï tr∆∞·ªüng">T·ªï tr∆∞·ªüng</option><option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option></select>
            <p class="label">T·ªï l√†m vi·ªác</p><select id="new-emp-team" class="input-box"><option value="T·ªï S·∫£n Xu·∫•t">T·ªï S·∫£n Xu·∫•t</option><option value="T·ªï Thu Ho·∫°ch">T·ªï Thu Ho·∫°ch</option></select>
            <button onclick="app.actions.addEmployee()" class="btn-primary uppercase">T·∫°o Nh√¢n S·ª±</button>
        </div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fbConfig = { apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", authDomain: "ong5mushroom-vietnam.firebaseapp.com", projectId: "ong5mushroom-vietnam", storageBucket: "ong5mushroom-vietnam.firebasestorage.app", messagingSenderId: "931399604992", appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" };
        const appInstance = initializeApp(fbConfig);
        const db = getFirestore(appInstance);
        const ROOT = "artifacts/namong5_production/public/data";

        window.app = {
            data: { employees: [], houses: [], chat: [], tasks: [], production: [], harvest: [], hr_requests: [], attendance: [], sop: [], exports: [] },
            user: JSON.parse(localStorage.getItem('n5_v101_user')) || null,

            ui: {
                showMsg: (t) => { const box = document.getElementById('msg-box'); box.innerText = t; box.style.display = 'block'; setTimeout(() => box.style.display = 'none', 4000); },
                showModal: id => document.getElementById(id).classList.remove('hidden'),
                closeModal: id => document.getElementById(id).classList.add('hidden'),
                openChat: () => {
                    document.getElementById('chat-layer').style.display = 'flex';
                    app.renderChat();
                    setTimeout(() => { const b = document.getElementById('chat-box'); b.scrollTop = b.scrollHeight; }, 150);
                },
                closeChat: () => document.getElementById('chat-layer').style.display = 'none',
                toggleModal: id => document.getElementById(id).classList.toggle('hidden'),
                
                tab: (id) => {
                    const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role);
                    if (!isAdmin) {
                        if (id === 'sx' && app.user.team !== 'T·ªï S·∫£n Xu·∫•t') { app.ui.showMsg('Ch·ªâ T·ªï S·∫£n Xu·∫•t m·ªõi ƒë∆∞·ª£c v√†o th·∫ª n√†y!'); return; }
                        if (id === 'th' && app.user.team !== 'T·ªï Thu Ho·∫°ch') { app.ui.showMsg('Ch·ªâ T·ªï Thu Ho·∫°ch m·ªõi ƒë∆∞·ª£c v√†o th·∫ª n√†y!'); return; }
                    }
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    document.getElementById('view-'+id).classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    const btn = document.querySelector(`button[onclick="app.ui.tab('${id}')"]`);
                    if(btn) btn.classList.add('active');
                    app.ui.closeChat();
                    if(id === 'th') app.ui.setTHSubTab('harvest');
                },

                setTHSubTab: (tabId) => {
                    document.getElementById('th-sub-harvest').classList.toggle('hidden', tabId !== 'harvest');
                    document.getElementById('th-sub-export').classList.toggle('hidden', tabId !== 'export');
                    document.getElementById('sub-btn-harvest').classList.toggle('active', tabId === 'harvest');
                    document.getElementById('sub-btn-export').classList.toggle('active', tabId === 'export');
                    if(tabId === 'export') app.ui.renderExportMatrix();
                },

                renderExportMatrix: () => {
                    const todayStr = new Date().toDateString();
                    const types = ['b2','a1','a2','b1','chan','d1','ht','abf','b2f','b1f'];
                    const harvestToday = {}; types.forEach(t => harvestToday[t] = 0);
                    
                    app.data.harvest.filter(h => new Date(h.time).toDateString() === todayStr).forEach(h => {
                        types.forEach(t => harvestToday[t] += (h.details?.[t] || 0));
                    });

                    const stock = {}; 
                    types.forEach(t => {
                        const totalH = app.data.harvest.reduce((acc, curr) => acc + (curr.details?.[t] || 0), 0);
                        const totalE = (app.data.exports || []).reduce((acc, curr) => acc + (curr[t] || 0), 0);
                        stock[t] = totalH - totalE;
                    });

                    const matrixEl = document.getElementById('export-matrix');
                    matrixEl.innerHTML = types.map(t => `
                        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 mb-2">
                            <div class="w-12 font-black text-blue-600 text-xs uppercase">${t === 'chan' ? 'Ch√¢n' : t.toUpperCase()}</div>
                            <div class="flex-1 text-[9px] text-slate-400 font-bold uppercase">
                                H√°i: <span class="text-green-600">${harvestToday[t]}</span> | 
                                T·ªìn: <span class="text-orange-600">${stock[t] - harvestToday[t]}</span>
                            </div>
                            <div class="w-24">
                                <input type="number" id="exp-${t}" class="input-box input-mini !p-2 !bg-white" placeholder="Xu·∫•t b√°n">
                            </div>
                        </div>`).join('');
                },

                setSXMode: (m) => {
                    document.getElementById('sx-action').value = m;
                    document.getElementById('btn-sx-nhap').className = m==='NH·∫¨P' ? 'flex-1 py-3 rounded-lg text-xs font-black bg-blue-600 text-white shadow-md transition' : 'flex-1 py-3 rounded-lg text-xs font-black text-slate-400';
                    document.getElementById('btn-sx-xuat').className = m==='XU·∫§T' ? 'flex-1 py-3 rounded-lg text-xs font-black bg-orange-500 text-white shadow-md transition' : 'flex-1 py-3 rounded-lg text-xs font-black text-slate-400';
                },
                toggleAssign: () => {
                    const m = document.getElementById('assign-mode').value;
                    document.getElementById('assign-ind-zone').classList.toggle('hidden', m !== 'ind');
                    document.getElementById('assign-team-zone').classList.toggle('hidden', m !== 'team');
                },
                calcTH: () => {
                    const ids = ['th-b2','th-a1','th-a2','th-b1','th-chan','th-d1','th-ht','th-abf','th-b2f','th-b1f'];
                    let sum = 0; let html = '';
                    ids.forEach(id => sum += Number(document.getElementById(id).value)||0);
                    if(sum>0) ids.forEach(id => { 
                        const v=Number(document.getElementById(id).value)||0; 
                        if(v>0) html+=`<div class="stat-badge">${id.replace('th-','').toUpperCase()}: ${((v/sum)*100).toFixed(0)}%</div>`; 
                    });
                    document.getElementById('th-total-display').innerText = sum + ' kg';
                    document.getElementById('th-percent-display').innerHTML = html;
                }
            },

            init: () => {
                const status = document.getElementById('login-status');
                setTimeout(() => { if (app.data.employees.length === 0) document.getElementById('rescue-btn').classList.remove('hidden'); }, 5000);
                signInAnonymously(getAuth(appInstance)).then(() => {
                    status.innerHTML = '<span class="status-dot status-ok"></span> K·∫øt n·ªëi t·ªët';
                    app.sync();
                });
                document.getElementById('sx-date').valueAsDate = new Date();
            },

            sync: () => {
                const mapData = s => s.docs.map(d => ({...d.data(), _id: d.id}));
                
                onSnapshot(collection(db, `${ROOT}/employees`), s => {
                    app.data.employees = mapData(s);
                    app.renderLogin();
                    if(app.user) { app.renderTeam(); app.renderApp(); }
                });

                onSnapshot(collection(db, `${ROOT}/chat`), s => {
                    app.data.chat = s.docs.map(d => d.data()).sort((a,b) => a.time - b.time);
                    if(app.user) app.renderChat();
                });

                ['houses', 'tasks', 'production_logs', 'harvest_logs', 'hr_requests', 'attendance_logs', 'sop', 'export_logs'].forEach(col => {
                    onSnapshot(collection(db, `${ROOT}/${col}`), s => {
                        const d = mapData(s);
                        if (col === 'production_logs') app.data.production = d;
                        else if (col === 'harvest_logs') app.data.harvest = d;
                        else if (col === 'hr_requests') app.data.hr_requests = d;
                        else if (col === 'export_logs') app.data.exports = d;
                        else app.data[col] = d;
                        if(app.user) app.renderDynamic();
                    });
                });
            },

            renderLogin: () => {
                const s = document.getElementById('login-user');
                if (app.data.employees.length > 0) {
                    s.innerHTML = '<option value="">-- Ch·ªçn t√™n th√†nh vi√™n --</option>' + app.data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                    s.disabled = false;
                    document.getElementById('login-pin').disabled = false;
                    document.getElementById('login-btn').disabled = false;
                    document.getElementById('login-btn').classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if(app.user) {
                    document.getElementById('login-overlay').classList.add('hidden');
                    app.renderApp();
                    app.ui.tab('home');
                }
            },

            doLogin: () => {
                const id = document.getElementById('login-user').value;
                const pin = document.getElementById('login-pin').value.trim();
                const emp = app.data.employees.find(e => String(e.id) === String(id) && String(e.pin).trim() === String(pin));
                if(emp) {
                    app.user = emp; localStorage.setItem('n5_v101_user', JSON.stringify(emp));
                    document.getElementById('login-overlay').classList.add('hidden'); 
                    app.renderApp();
                    app.ui.tab('home');
                } else app.ui.showMsg("M√£ PIN b·∫£o m·∫≠t kh√¥ng ƒë√∫ng!");
            },

            renderApp: () => {
                document.getElementById('head-user').innerText = app.user.name;
                document.getElementById('head-role').innerText = app.user.role;
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role);
                
                if(isAdmin) {
                    document.getElementById('admin-tools').classList.remove('hidden');
                    document.getElementById('admin-task-form').classList.remove('hidden');
                    document.getElementById('btn-export-sx').classList.remove('hidden');
                    document.getElementById('btn-export-th').classList.remove('hidden');
                    document.getElementById('btn-export-all').classList.remove('hidden');
                    document.getElementById('btn-remind-att').classList.remove('hidden');
                }
                app.renderDynamic();
                app.renderTeam();
            },
            
            renderDynamic: () => {
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role);
                document.getElementById('stat-online').innerText = app.data.employees.filter(e=>e.lastLogin===new Date().toISOString().split('T')[0]).length;
                document.getElementById('stat-yield').innerText = app.data.harvest ? app.data.harvest.filter(h => new Date(h.time).toDateString() === new Date().toDateString()).reduce((a,b) => a + (b.total||0), 0) : 0;

                document.getElementById('house-list').innerHTML = app.data.houses.map(h => `
                    <div class="card flex justify-between items-center !p-3 border-l-4 border-blue-500 shadow-sm">
                        <div><p class="font-bold text-sm text-slate-800 tracking-tight uppercase">${h.name}</p><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">AM: ${h.temp?.am||'-'}¬∞ | PM: ${h.temp?.pm||'-'}¬∞</p></div>
                        <div class="flex gap-2">
                            <button onclick="app.actions.viewHouseLogs('${h.name}')" class="bg-blue-50 text-blue-600 w-9 h-9 rounded-full flex items-center justify-center active:scale-90 shadow-sm"><i class="fas fa-file-alt text-xs"></i></button>
                            <button onclick="app.actions.openTemp('${h._id}', '${h.name}')" class="bg-orange-50 text-orange-600 w-9 h-9 rounded-full flex items-center justify-center active:scale-90 shadow-sm"><i class="fas fa-temperature-high text-xs"></i></button>
                        </div>
                    </div>`).join('');

                let tasks = app.data.tasks ? app.data.tasks.filter(t => t.status !== 'completed') : [];
                if(!isAdmin) tasks = tasks.filter(t => String(t.assignee) === String(app.user.id));
                const groups = {}; tasks.forEach(t => { if(!groups[t.assignee]) groups[t.assignee] = []; groups[t.assignee].push(t); });

                document.getElementById('task-list').innerHTML = Object.keys(groups).map(uid => {
                    const name = app.data.employees.find(e => String(e.id) === String(uid))?.name || uid;
                    const items = groups[uid].map(t => {
                        const isStarted = t.status === 'in_progress';
                        return `
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl mb-2 border border-slate-100 shadow-sm">
                            <div><p class="font-bold text-xs text-slate-700">${t.title} (${t.houseId})</p></div>
                            <div class="flex gap-2">
                                ${isAdmin?`<button onclick="app.actions.nudgeTask('${t._id}', '${name}', '${t.title}')" class="text-yellow-500 w-8 h-8 flex items-center justify-center active:scale-90"><i class="fas fa-bell"></i></button><button onclick="app.actions.delTask('${t._id}')" class="text-red-400 w-8 h-8 flex items-center justify-center active:scale-90"><i class="fas fa-trash"></i></button>`:''}
                                ${String(t.assignee) === String(app.user.id) ? (isStarted ? `<button onclick="app.actions.openReport('${t._id}', '${t.title}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold shadow-md uppercase tracking-tight">B√°o c√°o</button>`:`<button onclick="app.actions.startTask('${t._id}')" class="bg-green-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold shadow-md animate-pulse uppercase tracking-tight">Nh·∫≠n</button>`) : ''}
                            </div>
                        </div>`;
                    }).join('');
                    return `<div class="card !p-3 border-l-4 border-indigo-500 bg-white shadow-sm"><p class="text-[10px] font-black text-indigo-600 uppercase mb-2">üë§ ${name}</p>${items}</div>`;
                }).join('');
                
                document.getElementById('sx-log-list').innerHTML = app.data.production ? app.data.production.slice(0,5).map(l=>`<div class="text-[10px] p-2 border-b flex justify-between"><span>${l.action} ${l.type} (${l.dest})</span><span class="font-bold text-blue-600">${l.qty}</span></div>`).join('') : '';
                document.getElementById('th-log-list').innerHTML = app.data.harvest ? app.data.harvest.slice(0,5).map(l=>`<div class="text-[10px] p-2 border-b flex justify-between"><span>${l.area} (T·ªïng h√°i)</span><span class="font-bold text-green-600">${l.total} kg</span></div>`).join('') : '';
            },

            renderTeam: () => {
                 const today = new Date().toISOString().split('T')[0];
                 const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role);
                 const list = document.getElementById('team-list');
                 if(!list) return;
                 list.innerHTML = (app.data.employees || []).length > 0 ? app.data.employees.map(e => `
                    <div class="card flex justify-between items-center !p-3 border-l-4 ${e.lastLogin===today?'border-green-500':'border-slate-200'}">
                        <div class="flex items-center gap-3">
                            <div class="chat-avatar">${e.name.charAt(0)}</div>
                            <div>
                                <p class="text-xs font-bold text-slate-700 uppercase">${e.name}</p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">${e.role} | ${e.team || 'T·ªï t·ª± do'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            ${isAdmin ? `<button onclick="app.actions.delEmployee('${e._id}', '${e.name}')" class="text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center active:scale-75"><i class="fas fa-trash-alt text-xs"></i></button>` : ''}
                        </div>
                    </div>`).join('') : '<p class="text-center text-slate-400 py-4 italic text-xs uppercase font-bold">ƒêang t·∫£i danh s√°ch...</p>';
            },

            renderChat: () => {
                const box = document.getElementById('chat-box');
                if(!box || !app.user) return;
                
                const html = (app.data.chat || []).map(m => {
                    const isMe = String(m.senderId) === String(app.user.id);
                    const isSys = m.senderId === 'SYSTEM';
                    
                    if (isSys) {
                        return `<div class="chat-system">üì¢ ${m.text}</div>`;
                    }
                    
                    return `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <div class="chat-sender-tag">${isMe ? '' : `<div class="chat-avatar">${m.senderName ? m.senderName.charAt(0) : '?'}</div> ${m.senderName}`}</div>
                        <div class="chat-bubble ${isMe ? 'chat-me' : 'chat-other'} shadow-sm">
                            <p class="font-medium">${m.text}</p>
                        </div>
                    </div>`;
                }).join('');
                
                box.innerHTML = html || '<p class="text-center text-slate-400 italic text-xs py-12">B·∫Øt ƒë·∫ßu th·∫£o lu·∫≠n n·ªôi b·ªô t·∫°i ƒë√¢y</p>';
                box.scrollTop = box.scrollHeight;
            },

            actions: {
                seedAdmin: async () => { if(confirm("Kh·ªüi t·∫°o Admin?")) { await addDoc(collection(db, `${ROOT}/employees`), { id: 9999, name: "Admin", pin: "9999", role: "Gi√°m ƒë·ªëc", score: 100, team: "H·ªá Th·ªëng" }); location.reload(); } },
                logout: () => { localStorage.removeItem('n5_v101_user'); location.reload(); },
                
                createTask: async () => {
                    const title = document.getElementById('task-title').value;
                    const h = Array.from(document.querySelectorAll('input[name="h-chk"]:checked')).map(i => i.value);
                    const u = Array.from(document.querySelectorAll('input[name="u-chk"]:checked')).map(i => i.value);
                    if(!title || h.length===0 || u.length===0) return app.ui.showMsg("Vui l√≤ng ch·ªçn ƒë·ªß Nh√† v√† Nh√¢n vi√™n!");
                    for(let house of h) for(let uid of u) await addDoc(collection(db, `${ROOT}/tasks`), { title, houseId: house, assignee: uid, status: 'pending', time: Date.now() });
                    app.ui.showMsg("Ban h√†nh l·ªánh th√†nh c√¥ng!");
                },
                startTask: async (id) => updateDoc(doc(db, `${ROOT}/tasks`, id), { status: 'in_progress', startTime: Date.now() }),
                delTask: async (id) => { if(confirm("X√≥a l·ªánh n√†y?")) deleteDoc(doc(db, `${ROOT}/tasks`, id)); },
                
                nudgeTask: async (id, name, task) => {
                    const msg = `L·ªÜNH G·∫§P: Nh·∫Øc nh·ªü [${name}] ∆∞u ti√™n th·ª±c hi·ªán ngay vi·ªác [${task}]!`;
                    await addDoc(collection(db, `${ROOT}/chat`), { text: msg, senderId: 'SYSTEM', senderName: 'H·ªÜ TH·ªêNG', time: Date.now() });
                    app.ui.showMsg("ƒê√£ g·ª≠i th√∫c gi·ª•c qua Chat!");
                },

                remindAttendance: async () => {
                    const msg = `TH√îNG B√ÅO: Nh√¢n vi√™n ch∆∞a ƒëi·ªÉm danh vui l√≤ng v√†o ghi nh·∫≠n c√¥ng ca ngay!`;
                    await addDoc(collection(db, `${ROOT}/chat`), { text: msg, senderId: 'SYSTEM', senderName: 'H·ªÜ TH·ªêNG', time: Date.now() });
                    app.ui.showMsg("ƒê√£ g·ª≠i th√¥ng b√°o nh·∫Øc nh·ªü!");
                },

                submitReport: async (status) => {
                    const id = document.getElementById('report-task-id').value;
                    const val = document.getElementById('report-val').value;
                    await updateDoc(doc(db, `${ROOT}/tasks`, id), { status, actual: val, finishTime: Date.now() });
                    if(status==='completed') {
                         const task = app.data.tasks.find(t=>t._id===id);
                         const emp = app.data.employees.find(e=>String(e.id)==String(task.assignee));
                         if(emp) await updateDoc(doc(db, `${ROOT}/employees`, emp._id), { score: (emp.score||0) + 10 });
                    }
                    app.ui.closeModal('report-modal');
                    app.ui.showMsg("B√°o c√°o th√†nh c√¥ng!");
                },

                submitSX: async () => {
                    const d = { action: document.getElementById('sx-action').value, date: document.getElementById('sx-date').value, type: document.getElementById('sx-type').value, qty: Number(document.getElementById('sx-qty').value), batch: document.getElementById('sx-batch').value, dest: document.getElementById('sx-dest').value, bad: Number(document.getElementById('sx-bad').value), reuse: Number(document.getElementById('sx-reuse').value), user: app.user.name, time: Date.now() };
                    await addDoc(collection(db, `${ROOT}/production_logs`), d); app.ui.showMsg("Ghi nh·∫≠n S·∫£n Xu·∫•t th√†nh c√¥ng!");
                },

                submitTH: async () => {
                    const det = {}; ['b2','a1','a2','b1','chan','d1','ht','abf','b2f','b1f'].forEach(id => det[id]=Number(document.getElementById('th-'+id).value)||0);
                    const total = Object.values(det).reduce((a,b)=>a+b,0);
                    await addDoc(collection(db, `${ROOT}/harvest_logs`), { area: document.getElementById('th-area').value, details: det, total, user: app.user.name, time: Date.now(), bad: document.getElementById('th-huy-chan').value, ret: document.getElementById('th-doi-tra').value, note: document.getElementById('th-note').value });
                    app.ui.showMsg("C·∫≠p nh·∫≠t thu ho·∫°ch th√†nh c√¥ng!");
                },

                submitExport: async () => {
                    const types = ['b2','a1','a2','b1','chan','d1','ht','abf','b2f','b1f'];
                    const exportData = { time: Date.now(), user: app.user.name };
                    let totalExp = 0;
                    types.forEach(t => {
                        const val = Number(document.getElementById('exp-'+t).value) || 0;
                        exportData[t] = val;
                        totalExp += val;
                    });
                    if(totalExp === 0) return app.ui.showMsg("Ch∆∞a nh·∫≠p s·ªë l∆∞·ª£ng xu·∫•t!");
                    await addDoc(collection(db, `${ROOT}/export_logs`), exportData);
                    app.ui.showMsg("Ghi nh·∫≠n xu·∫•t kho b√°n h√†ng!");
                    app.ui.setTHSubTab('harvest');
                },

                sendChat: async () => { 
                    const i = document.getElementById('chat-input'); 
                    if(!i.value) return; 
                    await addDoc(collection(db, `${ROOT}/chat`), { text: i.value, senderId: String(app.user.id), senderName: app.user.name, time: Date.now() }); 
                    i.value = ''; 
                },
                checkIn: async (shift) => { const today = new Date().toISOString().split('T')[0]; await addDoc(collection(db, `${ROOT}/attendance_logs`), { uid: app.user.id, name: app.user.name, shift, date: today }); await updateDoc(doc(db, `${ROOT}/employees`, app.user._id), { lastLogin: today }); app.ui.showMsg("ƒêi·ªÉm danh th√†nh c√¥ng!"); },
                submitHR: async (type) => { await addDoc(collection(db, `${ROOT}/hr_requests`), { type, requester: app.user.name, status: 'pending', content: type==='LEAVE' ? document.getElementById('leave-date').value : document.getElementById('pur-item').value }); app.ui.showMsg("ƒê√£ g·ª≠i ƒë∆°n!"); app.ui.closeModal(type==='LEAVE'?'modal-leave':'modal-buy'); },
                approve: async (id, status) => { await updateDoc(doc(db, `${ROOT}/hr_requests`, id), { status }); app.ui.showMsg("X·ª≠ l√Ω ƒë∆°n xong!"); },
                
                saveTemp: async () => { const id = document.getElementById('temp-id').value; await updateDoc(doc(db, `${ROOT}/houses`, id), { 'temp.am': document.getElementById('temp-am').value, 'temp.pm': document.getElementById('temp-pm').value }); app.ui.showMsg("ƒê√£ l∆∞u nhi·ªát ƒë·ªô!"); app.ui.closeModal('modal-temp'); },
                openTemp: (id, name) => { document.getElementById('temp-id').value = id; document.getElementById('temp-name').innerText = name; app.ui.showModal('modal-temp'); },

                addEmployee: async () => { await addDoc(collection(db, `${ROOT}/employees`), { id: Number(document.getElementById('new-emp-id').value), name: document.getElementById('new-emp-name').value, pin: document.getElementById('new-emp-pin').value, team: document.getElementById('new-emp-team').value, role: document.getElementById('new-emp-role').value, score: 100 }); app.ui.showMsg("ƒê√£ th√™m nh√¢n s·ª±!"); app.ui.closeModal('modal-add-emp'); },
                delEmployee: async (id, name) => { if(confirm(`X√≥a nh√¢n vi√™n ${name}?`)) deleteDoc(doc(db, `${ROOT}/employees`, id)); },
                addSOP: async () => { await addDoc(collection(db, `${ROOT}/sop`), { title: document.getElementById('new-sop-name').value, sop: Number(document.getElementById('new-sop-val').value) }); app.ui.showMsg("ƒê√£ th√™m SOP!"); app.ui.closeModal('modal-add-sop'); },
                addHouse: async () => { const name = prompt("T√™n nh√† n·∫•m m·ªõi:"); if(name) await addDoc(collection(db, `${ROOT}/houses`), { name, temp: {am:0, pm:0} }); },
                fillSOP: () => { const val = document.getElementById('task-title').value; const item = (app.data.sop||[]).find(s => s.title === val); if(item) document.getElementById('task-target').value = item.sop; },
                
                viewHouseLogs: (name) => {
                    const logs = [
                        ...(app.data.production||[]).filter(l => l.dest === name).map(l => `<span class="text-blue-600 font-black text-[10px] uppercase">[SX]</span> ${l.action} ${l.qty} (${l.type})`),
                        ...(app.data.harvest||[]).filter(l => l.area === name).map(l => `<span class="text-green-600 font-black text-[10px] uppercase">[TH]</span> H√°i ${l.total}kg`)
                    ].reverse();
                    document.getElementById('history-house-name').innerText = name;
                    document.getElementById('history-content').innerHTML = logs.length ? logs.join('<br>') : '<p class="italic text-slate-400">Tr·ªëng</p>';
                    app.ui.showModal('modal-house-history');
                },

                downloadCSV: (csv, filename) => {
                    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url); link.setAttribute("download", filename);
                    link.style.visibility = 'hidden'; document.body.appendChild(link);
                    link.click(); document.body.removeChild(link);
                },

                exportSX: () => {
                    if (!['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role)) return;
                    let csv = "NGAY;GIO;NHAP/XUAT;LOAI PHOI;SO LUONG;LO CAY;NOI DEN;NGUOI NHAP;HUY;TAN DUNG\n";
                    app.data.production.sort((a,b)=>b.time-a.time).forEach(l => {
                        const d = new Date(l.time);
                        csv += `${d.toLocaleDateString()};${d.toLocaleTimeString()};${l.action};${l.type};${l.qty};${l.batch||''};${l.dest||''};${l.user||''};${l.bad||0};${l.reuse||0}\n`;
                    });
                    app.actions.downloadCSV(csv, "NhatKy_SanXuat.csv");
                },

                exportTH: () => {
                    if (!['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role)) return;
                    let csv = "NGAY;GIO;NHA;TONG;B2;A1;A2;B1;CHAN;D1;HT;ABF;B2F;B1F;HUY;TRA;NGUOI HAI\n";
                    app.data.harvest.sort((a,b)=>b.time-a.time).forEach(l => {
                        const d = new Date(l.time);
                        const det = l.details || {};
                        csv += `${d.toLocaleDateString()};${d.toLocaleTimeString()};${l.area};${l.total};${det.b2||0};${det.a1||0};${det.a2||0};${det.b1||0};${det.chan||0};${det.d1||0};${det.ht||0};${det.abf||0};${det.b2f||0};${det.b1f||0};${l.bad||0};${l.ret||0};${l.user||''}\n`;
                    });
                    app.actions.downloadCSV(csv, "NhatKy_ThuHoach.csv");
                },

                exportAll: () => {
                    if (!['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role)) return;
                    let csv = "NGAY;GIO;NHAN VIEN;VIEC;NHA;KET QUA;GHI CHU\n";
                    app.data.tasks.filter(t=>t.status==='completed').forEach(t => {
                        const d = new Date(t.finishTime || t.time);
                        csv += `${d.toLocaleDateString()};${d.toLocaleTimeString()};${t.assignee};${t.title};${t.houseId};${t.actual};${t.note||''}\n`;
                    });
                    app.actions.downloadCSV(csv, "BaoCao_TongHop.csv");
                }
            }
        };
        
        window.onload = app.init;
    </script>
</body>
</html>
