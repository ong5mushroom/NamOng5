<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="N·∫•m √îng 5">
    <meta name="theme-color" content="#2563eb">
    
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3252/3252932.png">
    
    <title>N·∫•m √îng 5 V155 - Platinum Supreme</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --blue: #2563eb; --header-h: 125px; --nav-h: 80px; --bg: #f8fafc; --shiitake: #5d2b0c; }
        
        /* C·∫•u h√¨nh Font Times New Roman to√†n h·ªá th·ªëng - B·∫£o v·ªá Icons */
        * { font-family: "Times New Roman", Times, serif; }
        .fas, .far, .fab, .fa-solid, .fa-regular, .fa-brands, [class^="fa-"], .fa-sm, .fa-xs { 
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important; 
        }
        
        body { 
            background: var(--bg); 
            color: #1e293b; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            user-select: none; 
        }
        
        #app-header { height: var(--header-h); background: white; border-bottom: 1px solid #e2e8f0; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding-top: env(safe-area-inset-top); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
        #app-view-container { position: fixed; top: var(--header-h); bottom: var(--nav-h); left: 0; right: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 16px; padding-bottom: 40px; z-index: 10; }
        #app-nav { height: var(--nav-h); background: white; border-top: 1px solid #e2e8f0; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); display: flex; justify-content: space-around; align-items: center; }

        .hidden { display: none !important; }
        .card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .input-box { width: 100%; background: #f1f5f9; border: 1.5px solid #cbd5e1; padding: 12px; border-radius: 12px; font-weight: 600; outline: none; font-size: 15px; transition: all 0.2s; }
        .input-box:focus { border-color: var(--blue); background: white; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        .btn-primary { background: var(--blue); color: white; font-weight: 800; padding: 14px; border-radius: 14px; width: 100%; text-transform: uppercase; font-size: 12px; box-shadow: 0 4px 6px rgba(37,99,235,0.2); transition: all 0.2s; border: none; cursor: pointer; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
        .label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.02em; }
        
        .nav-btn { color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; transition: color 0.2s; background: none; border: none; outline: none; }
        .nav-btn.active { color: var(--blue); transform: translateY(-2px); }
        
        .sub-tab-btn { flex: 1; padding: 10px; font-size: 11px; font-weight: 800; text-align: center; border-radius: 10px; color: #64748b; transition: all 0.2s; background: none; border: none; }
        .sub-tab-btn.active { background: white; color: var(--blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Login Overlay Styling */
        #login-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-wait { background: #eab308; animation: pulse 1s infinite; }
        .status-ok { background: #22c55e; }

        /* Chat Styling */
        #chat-layer { position: fixed; inset: 0; background: #efeae2; z-index: 2000; display: none; flex-direction: column; }
        .chat-bg { background-image: url('data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M20 5c-5 0-9 4-9 9 0 3 2 5 5 6v10h8V20c3-1 5-3 5-6 0-5-4-9-9-9z" fill="%2378350f" fill-opacity="0.05"/></svg>'); }
        #chat-box { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .chat-bubble { max-width: 82%; padding: 10px 14px; border-radius: 16px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .chat-me { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-other { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-system { background: #fee2e2; color: #991b1b; align-self: center; border-radius: 8px; font-size: 11px; font-weight: 700; text-align: center; border: 1px dashed #f87171; padding: 10px 16px; margin: 5px 0; width: 95%; }
        .reaction-bar { position: absolute; bottom: -12px; right: 0; display: flex; gap: 2px; background: white; border-radius: 20px; padding: 2px 6px; border: 1px solid #eee; font-size: 9px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 5; }

        /* Icon Shiitake */
        .shiitake-logo { width: 220px; height: 220px; margin-bottom: 25px; filter: drop-shadow(0 15px 35px rgba(93,43,12,0.35)); }
        
        .staff-online { border: 2px solid #22c55e !important; background: #f0fdf4 !important; }
        .staff-offline { opacity: 0.6; filter: grayscale(0.8); background: #f1f5f9 !important; }

        .log-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 8px; background: white; }
        .log-table th { background: var(--shiitake); text-align: left; padding: 10px; color: white; border: 1px solid #4a220a; font-weight: 800; text-transform: uppercase; }
        .log-table td { padding: 10px; border: 1px solid #e2e8f0; font-weight: 600; color: #475569; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .slogan { font-size: 13px; font-weight: 900; color: var(--shiitake); letter-spacing: 0.08em; text-transform: uppercase; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="msg-box"></div>

    <!-- 1. LOGIN OVERLAY -->
    <div id="login-overlay">
        <svg class="shiitake-logo" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M216 350c0 40 10 98 40 98s40-58 40-98z" fill="#D2B48C" />
            <path d="M256 90c-140 0-230 80-230 180 0 40 40 70 80 80 40 10 110 20 150 20s110-10 150-20c40-10 80-40 80-80 0-100-90-180-230-180z" fill="#5D2B0C"/>
            <ellipse cx="180" cy="180" rx="25" ry="15" fill="#8B4513" opacity="0.4" />
            <ellipse cx="320" cy="210" rx="35" ry="20" fill="#8B4513" opacity="0.4" />
            <ellipse cx="240" cy="250" rx="30" ry="15" fill="#8B4513" opacity="0.4" />
            <path d="M120 230c40-15 100-25 136-25s96 10 136 25" fill="none" stroke="#FFFFFF" stroke-width="6" stroke-linecap="round" opacity="0.2"/>
        </svg>
        <h1 class="text-4xl font-black text-slate-800 mb-0.5 tracking-tight text-center italic leading-none font-black">N·∫•m √îng 5</h1>
        <p class="slogan mb-12 text-center font-black">TRAO S·ª®C KH·ªéE, TR·ªåN Y√äU TH∆Ø∆†NG</p>
        
        <div class="w-full max-w-sm space-y-4">
            <div id="login-status" class="text-center text-xs font-bold text-slate-400 mb-2 flex items-center justify-center font-black italic">
                <span class="status-dot status-wait" id="auth-dot"></span> <span id="status-text">ƒêang nh·∫≠n di·ªán b·∫£o m·∫≠t...</span>
            </div>
            <select id="login-user" class="input-box text-center appearance-none shadow-sm font-black" disabled><option value="">ƒêang t·∫£i danh s√°ch...</option></select>
            <input id="login-pin" type="password" placeholder="M√£ PIN b·∫£o m·∫≠t" class="input-box text-center text-2xl tracking-[0.4em] shadow-inner font-black" disabled maxlength="6" inputmode="numeric">
            <button id="login-btn" onclick="app.doLogin()" class="btn-primary opacity-50 cursor-not-allowed bg-amber-900 shadow-amber-900/20 italic" disabled>V√ÄO H·ªÜ TH·ªêNG</button>
        </div>
    </div>

    <!-- 2. HEADER -->
    <header id="app-header">
        <div class="flex items-center gap-3">
            <div class="bg-amber-900 p-1.5 rounded-xl shadow-lg border border-amber-800">
                <svg width="28" height="28" viewBox="0 0 512 512" fill="white">
                   <path d="M216 350c0 40 10 98 40 98s40-58 40-98z" fill="#D2B48C" opacity="0.3" />
                   <path d="M256 90c-140 0-230 80-230 180 0 40 40 70 80 80 40 10 110 20 150 20s110-10 150-20c40-10 80-40 80-80 0-100-90-180-230-180z" fill="currentColor"/>
                </svg>
            </div>
            <div class="leading-none">
                <h1 class="text-base font-black uppercase text-slate-800 tracking-wide leading-none font-black">N·∫•m √îng 5</h1>
                <p class="text-[7px] font-black text-amber-800 uppercase mt-1 tracking-tighter italic">TRAO S·ª®C KH·ªéE, TR·ªåN Y√äU TH∆Ø∆†NG</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="text-right leading-none"><p id="head-user" class="font-bold text-xs text-slate-700">...</p><p id="head-role" class="text-[9px] text-amber-700 font-bold uppercase mt-1 italic tracking-tighter">...</p></div>
            <button onclick="app.ui.showModal('settings-modal')" class="w-9 h-9 bg-slate-50 rounded-full border flex items-center justify-center text-slate-500 active:scale-90 shadow-sm"><i class="fas fa-cog text-xs"></i></button>
        </div>
    </header>

    <!-- 3. MAIN CONTAINER -->
    <div id="app-view-container">
        <!-- HOME (Trang ch·ªß) -->
        <div id="view-home" class="view-section hidden animate-in fade-in">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="card border-l-4 border-blue-500 text-center shadow-sm"><p class="label mb-1">Tr·ª±c tuy·∫øn</p><p class="text-2xl font-black text-blue-600 leading-none" id="stat-online">0</p></div>
                <div class="card border-l-4 border-green-500 text-center shadow-sm"><p class="label uppercase mb-1 font-black">H√°i ng√†y (Kg)</p><p class="text-2xl font-black text-green-600 leading-none" id="stat-yield">0.00</p></div>
            </div>
            
            <div class="card border border-yellow-100 shadow-sm mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-black text-yellow-600 uppercase tracking-widest leading-none italic font-black"><i class="fas fa-trophy mr-1"></i> B·∫£ng V√†ng Danh D·ª±</h3>
                    <button onclick="app.actions.exportTH()" class="text-[10px] font-black text-blue-500 bg-blue-50 px-2.5 py-1 rounded shadow-sm uppercase italic font-black border border-blue-100">B√°o C√°o T·ªïng</button>
                </div>
                <div id="leaderboard" class="space-y-2 text-xs"></div>
            </div>
            
            <p class="label px-2 mb-2 tracking-widest font-black text-slate-400 italic font-black uppercase text-[9px]">Nh·∫≠t k√Ω theo t·ª´ng nh√† tr·ªìng</p>
            <div id="house-list" class="space-y-3"></div>
        </div>

        <!-- VI·ªÜC (TASKS) -->
        <div id="view-tasks" class="view-section hidden animate-in fade-in">
             <div id="admin-task-form" class="hidden card border-2 border-blue-50 shadow-md">
                <div class="flex justify-between items-center mb-3"><span class="text-xs font-black text-blue-600 uppercase italic">Ban l·ªánh giao vi·ªác</span><select id="assign-mode" onchange="app.ui.toggleAssign()" class="text-[10px] font-bold bg-slate-100 p-1 rounded shadow-inner"><option value="ind">C√° nh√¢n</option><option value="team">C·∫£ T·ªï</option></select></div>
                <div class="space-y-3">
                    <input id="task-title" placeholder="T√™n c√¥ng vi·ªác..." class="input-box bg-white text-sm shadow-inner font-bold italic">
                    <div><p class="label">Ch·ªçn Nh√† n·∫•m</p><div id="house-multi-select" class="grid grid-cols-3 gap-1 bg-slate-50 p-2 rounded border max-h-32 overflow-y-auto shadow-inner"></div></div>
                    <div id="assign-ind-zone" class="max-h-32 overflow-y-auto border p-2 rounded bg-slate-50 grid grid-cols-2 gap-1 shadow-inner font-black"></div>
                    <div id="assign-team-zone" class="hidden bg-slate-50 p-2 rounded-xl border space-y-2 text-xs font-bold shadow-inner"><label class="flex items-center gap-2 font-black"><input type="radio" name="team-radio" value="T·ªï S·∫£n Xu·∫•t" checked> T·ªï S·∫£n Xu·∫•t</label><label class="flex items-center gap-2 font-black"><input type="radio" name="team-radio" value="T·ªï Thu Ho·∫°ch"> T·ªï Thu Ho·∫°ch</label></div>
                    <button onclick="app.actions.createTask()" class="btn-primary bg-slate-800 mt-2 shadow-lg uppercase font-black italic">Ban l·ªánh ngay</button>
                </div>
            </div>
            <div id="task-list-grouped" class="space-y-4 pb-20 mt-2"></div>
        </div>

        <!-- S·∫¢N XU·∫§T (Dropdown Nh√†) -->
        <div id="view-sx" class="view-section hidden animate-in fade-in">
            <h2 class="font-black text-slate-800 uppercase text-xs tracking-tight mb-2 px-1 italic font-black">Qu·∫£n l√Ω Ph√¥i N·∫•m</h2>
            <div class="card border-2 border-indigo-50 shadow-md">
                <div class="space-y-4">
                    <div>
                        <p class="label font-black text-blue-600 uppercase mb-1 leading-none text-[10px]">Nh√† N·∫•m Nh·∫≠n/Xu·∫•t Ph√¥i</p>
                        <select id="sx-house-id" class="input-box bg-white font-bold text-indigo-700 shadow-sm border-indigo-100 font-black italic leading-none"></select>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        <div><p class="label font-black text-slate-600 uppercase mb-1 leading-none text-[9px]">Lo·∫°i Ph√¥i n·∫•m</p><input id="sx-type" list="phoi-list-v5" class="input-box bg-white p-2 text-xs shadow-inner font-black italic" placeholder="V√≠ d·ª•: 049 ƒê·∫°t..."><datalist id="phoi-list-v5"><option value="049 ƒê·∫°t"><option value="049 TD"></datalist></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><p class="label font-black text-slate-600 uppercase mb-1 leading-none text-[9px]">S·ªë t√∫i ph√¥i</p><input type="number" id="sx-qty" class="input-box bg-white text-center font-black text-lg p-2 shadow-inner" placeholder="0"></div>
                            <div><p class="label font-black text-slate-600 uppercase mb-1 leading-none text-[9px]">M√£ L√¥ c·∫•y</p><input id="sx-batch" class="input-box bg-white text-center p-2 text-xs shadow-inner font-black" placeholder="..."></div>
                        </div>
                        <div><p class="label font-black text-slate-600 uppercase mb-1 leading-none text-[9px]">Ng√†y nh·∫≠p/xu·∫•t kho</p><input type="date" id="sx-date" class="input-box bg-white text-center p-2 text-xs shadow-inner"></div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="app.actions.submitSX('NH·∫¨P')" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-md active:scale-95 transition-all italic font-black leading-none">Nh·∫≠p kho</button>
                        <button onclick="app.actions.submitSX('XU·∫§T')" class="flex-1 bg-amber-700 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-md active:scale-95 transition-all italic font-black leading-none">Xu·∫•t kho</button>
                    </div>
                </div>
            </div>
            <p class="label px-2 mt-4 italic font-black text-slate-400 font-black uppercase text-[9px]">Nh·∫≠t k√Ω s·∫£n xu·∫•t g·∫ßn nh·∫•t</p>
            <div id="sx-log-list" class="space-y-2 pb-24 mt-2"></div>
        </div>

        <!-- THU HO·∫†CH & ƒê√ìNG G√ìI (THDG) -->
        <div id="view-th" class="view-section hidden animate-in fade-in">
             <div class="flex bg-slate-200 p-1 rounded-xl mb-4 shadow-inner border border-slate-300">
                 <button onclick="app.ui.setTHSubTab('harvest')" id="sub-btn-harvest" class="sub-tab-btn active uppercase font-black italic">H√°i n·∫•m s·∫°ch</button>
                 <button onclick="app.ui.setTHSubTab('export')" id="sub-btn-export" class="sub-tab-btn uppercase font-black italic">Xu·∫•t ƒë∆°n b√°n</button>
             </div>
             
             <div id="th-sub-harvest" class="space-y-3">
                 <div class="card border-2 border-green-50 shadow-md">
                     <div class="space-y-3">
                         <div><p class="label font-black text-blue-600 italic uppercase leading-none mb-1 text-[10px]">V·ªã tr√≠ nh√† h√°i (B·∫Øt bu·ªôc ch·ªçn)</p><select id="th-area" class="input-box bg-white font-bold text-green-700 shadow-sm border-green-100 font-black italic leading-none"></select></div>
                         <div class="bg-slate-50 p-3 rounded-2xl border shadow-inner">
                             <div class="grid grid-cols-5 gap-2 mb-2 font-black">
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">B2</label><input type="number" id="th-b2" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">A1</label><input type="number" id="th-a1" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">A2</label><input type="number" id="th-a2" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">B1</label><input type="number" id="th-b1" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 text-blue-600 font-black italic uppercase leading-none">Ch√¢n</label><input type="number" id="th-chan" step="0.01" class="input-box !p-2 text-center border-blue-100 font-black shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                            </div>
                             <div class="grid grid-cols-5 gap-2">
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">D1</label><input type="number" id="th-d1" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">A1F</label><input type="number" id="th-a1f" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">A2F</label><input type="number" id="th-a2f" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">B2F</label><input type="number" id="th-b2f" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">HT</label><input type="number" id="th-ht" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                            </div>
                         </div>
                         <div class="bg-green-50 p-4 rounded-xl border border-green-200 flex justify-between items-center shadow-sm"><span class="text-xs font-bold uppercase text-green-800 italic font-black leading-none">T·ªïng kh·ªëi l∆∞·ª£ng:</span><span id="th-total-display" class="font-black text-2xl text-green-600 leading-none">0.00 kg</span></div>
                         <button onclick="app.actions.submitTH()" class="btn-primary bg-green-600 shadow-lg uppercase font-black italic">Ghi nh·∫≠n phi·∫øu h√°i s·∫°ch</button>
                     </div>
                 </div>
             </div>
             
             <div id="th-sub-export" class="space-y-3 hidden">
                <div class="card border-2 border-blue-50 shadow-lg">
                    <div class="mb-4"><p class="label font-black text-blue-600 uppercase tracking-tighter italic leading-none mb-2 font-black">T√™n kh√°ch h√†ng nh·∫≠n ƒë∆°n</p><input id="export-customer-name" placeholder="V√≠ d·ª•: Ch·ªã NƒÉm, Anh Ba, Kho A..." class="input-box bg-white shadow-inner font-bold italic leading-none font-black"></div>
                    <div id="export-matrix" class="grid grid-cols-1 gap-1.5 mb-4"></div>
                    <button onclick="app.actions.submitExport()" class="btn-primary bg-blue-600 shadow-md uppercase font-black italic leading-none">Ch·ªët ƒë∆°n xu·∫•t b√°n</button>
                </div>
             </div>
             
             <p class="label px-1 mt-4 tracking-widest font-black text-slate-400 italic leading-none uppercase text-[9px]">B·∫£ng k√™ h√°i & Xu·∫•t kho (2 ng√†y)</p>
             <div id="harvest-recent-table" class="overflow-x-auto no-scrollbar mt-2 pb-20 shadow-sm rounded-xl border"></div>
        </div>

        <!-- TEAM (Nh√¢n s·ª± & Ch·∫•m c√¥ng) -->
        <div id="view-team" class="view-section hidden px-1 animate-in fade-in">
             <div class="card p-4 text-center shadow-sm mb-4 border-2 border-blue-100 shadow-inner font-black"><p class="label mb-3 uppercase tracking-widest font-black italic text-blue-600 leading-none">H·ªá th·ªëng ƒëi·ªÉm danh Heritage</p><div class="grid grid-cols-2 gap-3 font-black"><button onclick="app.actions.checkIn('S√°ng')" class="btn-primary bg-yellow-500 shadow-yellow-100 uppercase font-black italic leading-none">‚òÄÔ∏è Ca S√°ng</button><button onclick="app.actions.checkIn('Chi·ªÅu')" class="btn-primary bg-indigo-500 shadow-indigo-100 uppercase font-black italic leading-none">üåô Ca Chi·ªÅu</button></div></div>
             
             <div class="card bg-slate-50 border-slate-200 shadow-sm mb-4">
                <p class="label mb-3 uppercase font-black text-[9px] italic leading-none">T√°c v·ª• h√†nh ch√≠nh</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.ui.showModal('modal-leave')" class="btn-primary bg-white text-slate-600 border shadow-none text-[10px] italic font-black shadow-sm border-slate-300 leading-none font-black"><i class="fas fa-calendar-times text-red-500 mr-1"></i> Xin ngh·ªâ</button>
                    <button onclick="app.ui.showModal('modal-buy')" class="btn-primary bg-white text-slate-600 border shadow-none text-[10px] italic font-black shadow-sm border-slate-300 leading-none font-black"><i class="fas fa-shopping-cart text-green-500 mr-1"></i> Mua h√†ng</button>
                </div>
                <div class="mt-5 pt-4 border-t border-slate-200 flex flex-col gap-2">
                    <p class="label text-[8px] text-center mb-1 font-black italic uppercase">B√°o c√°o nghi·ªáp v·ª• t·ªï ƒë·ªôi</p>
                    <button onclick="app.actions.exportCSVByTeam(app.user.team)" class="w-full bg-blue-700 text-white py-3 rounded-xl font-black text-[11px] uppercase shadow-md italic tracking-widest leading-none font-black">B√°o c√°o S·∫£n l∆∞·ª£ng T·ªï ${app.user.team || ''}</button>
                    <button onclick="app.actions.exportAttendance()" class="w-full bg-slate-200 text-slate-700 py-3 rounded-xl font-black text-[11px] uppercase shadow-inner italic tracking-tight border border-slate-300 leading-none font-black">Xu·∫•t File Ch·∫•m C√¥ng T·ªï</button>
                </div>
             </div>
             
             <p class="label px-2 mb-2 tracking-widest font-black text-slate-400 uppercase text-[9px] leading-none italic font-black">Th√†nh vi√™n ƒë·ªôi ng≈©</p>
             <div id="team-list" class="space-y-2 pb-24 font-black"></div>
        </div>
    </div>

    <!-- 4. CHAT -->
    <div id="chat-layer">
        <div class="h-[70px] bg-white border-b flex items-end px-4 pb-3 shadow-sm">
             <button onclick="app.ui.closeChat()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center mr-3 active:bg-slate-200 shadow-sm shadow-inner"><i class="fas fa-arrow-left text-slate-600"></i></button>
             <h2 class="font-black text-slate-800 text-lg uppercase tracking-tight leading-none italic font-black">Trao ƒë·ªïi n·∫•m s·∫°ch</h2>
        </div>
        <div id="chat-box" class="no-scrollbar chat-bg shadow-inner"></div>
        <div class="chat-input-area bg-white p-3 flex gap-2 border-t shadow-lg pb-10">
            <button class="w-11 h-11 rounded-full bg-red-50 text-red-500 flex items-center justify-center active:scale-75 shadow-sm" onclick="app.actions.sendReaction('‚ù§Ô∏è')"><i class="fas fa-heart text-sm"></i></button>
            <input id="chat-input" type="text" class="flex-1 bg-slate-100 rounded-full px-5 py-2.5 text-sm outline-none border shadow-inner font-medium shadow-inner italic font-black" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeyup="if(event.key==='Enter') app.actions.sendChat()">
            <button onclick="app.actions.sendChat()" class="w-11 h-11 bg-blue-600 rounded-full text-white flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-paper-plane text-xs"></i></button>
        </div>
    </div>

    <!-- 5. NAV -->
    <nav id="app-nav">
        <button onclick="app.ui.tab('home')" class="nav-btn active" id="btn-home"><i class="fas fa-home text-xl"></i><span>HOME</span></button>
        <button onclick="app.ui.tab('tasks')" class="nav-btn" id="btn-tasks"><i class="fas fa-clipboard-list text-xl"></i><span>VI·ªÜC</span></button>
        <button onclick="app.ui.tab('sx')" class="nav-btn" id="btn-sx"><i class="fas fa-industry text-xl"></i><span>SX</span></button>
        <button onclick="app.ui.tab('th')" class="nav-btn" id="btn-th"><i class="fas fa-box-open text-xl"></i><span>THDG</span></button>
        <button onclick="app.ui.tab('team')" class="nav-btn" id="btn-team"><i class="fas fa-users text-xl"></i><span>TEAM</span></button>
        <button onclick="app.ui.openChat()" class="nav-btn"><i class="fas fa-comments text-xl"></i><span>CHAT</span></button>
    </nav>

    <!-- 6. MODALS -->
    <div id="settings-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('settings-modal')">
        <div class="modal-box shadow-2xl border-2 border-slate-50 font-black">
            <h3 class="font-black text-xl mb-6 text-slate-800 uppercase border-b pb-3 text-center italic text-blue-600 leading-none font-black">Trung t√¢m Qu·∫£n tr·ªã</h3>
            <div class="space-y-4">
                <div id="admin-tools" class="hidden space-y-3 font-black">
                    <button onclick="app.actions.resetLeaderboard()" class="btn-primary bg-orange-600 uppercase font-black shadow-lg flex items-center justify-center gap-3 italic font-black leading-none"><i class="fas fa-history text-xs mr-1 font-black"></i> Reset BXH Th√°ng</button>
                    <div class="border-t pt-5 space-y-2">
                        <button onclick="app.ui.showModal('modal-add-staff')" class="btn-primary bg-slate-700 uppercase shadow-none text-[10px] italic font-black">Th√™m nh√¢n s·ª± m·ªõi</button>
                        <button onclick="app.actions.addHouse()" class="btn-primary bg-slate-500 uppercase shadow-none text-[10px] italic font-black">Th√™m nh√† n·∫•m m·ªõi</button>
                    </div>
                </div>
                <button onclick="app.actions.logout()" class="btn-primary bg-red-500 mt-6 shadow-md font-black italic uppercase tracking-widest leading-none font-black">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>

    <!-- Modal Form: ƒê∆°n t·ª´ & Nh√† n·∫•m -->
    <div id="modal-leave" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-leave')"><div class="modal-box shadow-2xl p-8 border-2 border-blue-50 font-black"><h3 class="font-bold mb-6 uppercase text-blue-600 text-center italic leading-none font-black">ƒê∆°n xin ngh·ªâ ph√©p</h3><div class="space-y-4 pt-2 font-black"><p class="label font-black italic text-[11px] mb-0 leading-none font-black">Ng√†y b·∫Øt ƒë·∫ßu ngh·ªâ</p><input id="leave-date" type="date" class="input-box shadow-inner font-black"><p class="label font-black italic text-[11px] mb-0 leading-none font-black">L√Ω do ngh·ªâ</p><select id="leave-reason" class="input-box shadow-inner font-black"><option>S·ª©c kh·ªèe / ·ªêm</option><option>Vi·ªác gia ƒë√¨nh</option><option>Kh√°c</option></select><button onclick="app.actions.submitHR('LEAVE')" class="btn-primary shadow-md italic uppercase font-black mt-2 leading-none font-black">X√°c nh·∫≠n g·ª≠i ƒë∆°n</button></div></div></div>
    <div id="modal-buy" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-buy')"><div class="modal-box shadow-2xl p-8 border-2 border-green-50 font-black"><h3 class="font-bold mb-6 uppercase text-green-600 text-center italic leading-none font-black font-black">ƒê·ªÅ xu·∫•t mua v·∫≠t t∆∞</h3><div class="space-y-4 pt-2 font-black"><p class="label font-black italic leading-none text-[11px] uppercase font-black">T√™n h√†ng / V·∫≠t t∆∞ c·∫ßn nh·∫≠p g·∫•p</p><input type="text" id="pur-item" placeholder="Nh·∫≠p t√™n v·∫≠t t∆∞..." class="input-box shadow-inner font-bold italic leading-none font-black font-black"><button onclick="app.actions.submitHR('PURCHASE')" class="btn-primary bg-green-600 shadow-md italic uppercase font-black mt-2 font-black leading-none">G·ª≠i ƒë·ªÅ xu·∫•t mua</button></div></div></div>

    <!-- Modal Nhi·ªát ƒë·ªô -->
    <div id="modal-temp" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-temp')">
        <div class="modal-box text-center shadow-2xl p-8 border-2 border-orange-50 font-black">
            <h3 class="font-black mb-8 text-xl uppercase tracking-tighter text-slate-800 italic leading-none font-black">Nhi·ªát ƒë·ªô Nh√† <span id="temp-name" class="text-orange-500"></span></h3>
            <input type="hidden" id="temp-id">
            <div class="grid grid-cols-2 gap-6 mb-8 font-black">
                <div><label class="label text-center font-black uppercase leading-none mb-1 text-orange-500 italic font-black">‚òÄÔ∏è S√°ng</label><input id="temp-am" type="number" step="0.1" class="input-box text-center text-4xl font-black text-orange-600 bg-orange-50 shadow-inner" placeholder="0.0"></div>
                <div><label class="label text-center font-black uppercase tracking-widest leading-none mb-1 text-blue-500 italic font-black">üåô Chi·ªÅu</label><input id="temp-pm" type="number" step="0.1" class="input-box text-center text-4xl font-black text-blue-500 bg-blue-50 shadow-inner" placeholder="0.0"></div>
            </div>
            <button onclick="app.actions.saveTemp()" class="btn-primary bg-orange-500 shadow-lg font-black py-5 italic uppercase font-black leading-none">C·∫≠p nh·∫≠t d·ªØ li·ªáu</button>
        </div>
    </div>

    <!-- Modal Th√™m nh√¢n s·ª± -->
    <div id="modal-add-staff" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-add-staff')">
        <div class="modal-box shadow-2xl p-8"><h3 class="font-bold mb-6 uppercase text-center italic leading-tight text-blue-600 leading-none font-black font-black">C·∫•p t√†i kho·∫£n Heritage</h3><div class="space-y-4 font-black"><input id="new-emp-name" placeholder="H·ªç v√† t√™n..." class="input-box shadow-inner italic font-black font-black"><div class="grid grid-cols-2 gap-3 font-black"><input id="new-emp-id" placeholder="M√£ ID" class="input-box shadow-inner font-black font-black" inputmode="numeric"><input id="new-emp-pin" placeholder="PIN 4-6 s·ªë" class="input-box shadow-inner font-black font-black" inputmode="numeric" maxlength="6"></div><select id="new-emp-role" class="input-box shadow-inner italic font-black font-black"><option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option><option value="T·ªï tr∆∞·ªüng">T·ªï tr∆∞·ªüng</option><option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option></select><select id="new-emp-team" class="input-box shadow-inner italic font-black font-black"><option value="T·ªï Thu Ho·∫°ch">T·ªï Thu Ho·∫°ch</option><option value="T·ªï S·∫£n Xu·∫•t">T·ªï S·∫£n Xu·∫•t</option></select><button onclick="app.actions.addEmployee()" class="btn-primary shadow-md font-black uppercase italic leading-none font-black">K√≠ch ho·∫°t t√†i kho·∫£n</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Configuration - B·∫¢N G·ªêC 104 ·ªîN ƒê·ªäNH
        const fbConfig = { apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", authDomain: "ong5mushroom-vietnam.firebaseapp.com", projectId: "ong5mushroom-vietnam", storageBucket: "ong5mushroom-vietnam.firebasestorage.app", messagingSenderId: "931399604992", appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" };
        const appInstance = initializeApp(fbConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);
        const ROOT = "artifacts/namong5_production/public/data";

        window.app = {
            data: { employees: [], houses: [], harvest: [], exports: [], chat: [], production: [], attendance: [], tasks: [], hr_requests: [] },
            user: JSON.parse(localStorage.getItem('n5_v101_user')) || null,

            getEmpName: (id) => {
                const emp = window.app.data.employees.find(e => String(e.id) === String(id));
                return emp ? emp.name : id;
            },

            ui: {
                showMsg: (t) => { const box = document.getElementById('msg-box'); if(box) { box.innerText = t; box.style.display = 'block'; setTimeout(() => box.style.display = 'none', 3000); }},
                showModal: id => { const el = document.getElementById(id); if(el) el.classList.remove('hidden'); },
                closeModal: id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); },
                openChat: () => { document.getElementById('chat-layer').style.display = 'flex'; window.app.renderChat(); },
                closeChat: () => { document.getElementById('chat-layer').style.display = 'none'; },
                
                initPWA: () => {
                    const manifest = { "name": "N·∫•m √îng 5 Supreme", "short_name": "N·∫•m √îng 5", "start_url": ".", "display": "standalone", "background_color": "#f8fafc", "theme_color": "#2563eb", "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3252/3252932.png", "sizes": "512x512", "type": "image/png" }] };
                    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                    const manifestURL = URL.createObjectURL(blob);
                    const link = document.head.querySelector('link[rel="manifest"]') || document.createElement('link');
                    link.rel = 'manifest'; link.href = manifestURL; document.head.appendChild(link);
                },

                tab: (id) => {
                    if (!window.app.user) return;
                    const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(window.app.user.role);
                    if (!isAdmin && id === 'th' && window.app.user.team !== 'T·ªï Thu Ho·∫°ch') return window.app.ui.showMsg("D√†nh ri√™ng T·ªï Thu Ho·∫°ch!");
                    if (!isAdmin && id === 'sx' && window.app.user.team !== 'T·ªï S·∫£n Xu·∫•t') return window.app.ui.showMsg("D√†nh ri√™ng T·ªï S·∫£n Xu·∫•t!");
                    
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    document.getElementById('view-'+id)?.classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    const btn = document.querySelector(`button[onclick="app.ui.tab('${id}')"]`);
                    if(btn) btn.classList.add('active');
                },

                setTHSubTab: (tabId) => {
                    const h = document.getElementById('th-sub-harvest');
                    const e = document.getElementById('th-sub-export');
                    const bh = document.getElementById('sub-btn-harvest');
                    const be = document.getElementById('sub-btn-export');
                    if(h) h.classList.toggle('hidden', tabId !== 'harvest');
                    if(e) e.classList.toggle('hidden', tabId !== 'export');
                    if(bh) bh.classList.toggle('active', tabId === 'harvest');
                    if(be) be.classList.toggle('active', tabId === 'export');
                    if(tabId === 'export') window.app.ui.renderExportMatrix();
                },

                renderExportMatrix: () => {
                    const matrixEl = document.getElementById('export-matrix');
                    if(!matrixEl) return;
                    const types = [{id:'b2',n:'N·∫•m B2'},{id:'a1',n:'N·∫•m A1'},{id:'a2',n:'N·∫•m A2'},{id:'b1',n:'N·∫•m B1'},{id:'chan',n:'Ch√¢n N·∫•m'},{id:'ht',n:'H·∫ßu Th·ªß'},{id:'d1',n:'N·∫•m D1'},{id:'a1f',n:'N·∫•m A1F'},{id:'a2f',n:'N·∫•m A2F'},{id:'b2f',n:'N·∫•m B2F'}];
                    const stock = {}; types.forEach(t => {
                        const hCount = window.app.data.harvest.reduce((a, c) => a + (c.details?.[t.id] || 0), 0);
                        const eCount = window.app.data.exports.reduce((a, c) => a + (c.details?.[t.id] || 0), 0);
                        stock[t.id] = hCount - eCount;
                    });
                    matrixEl.innerHTML = types.map(t => `
                        <div class="bg-white p-3 rounded-2xl border flex items-center justify-between shadow-sm mb-1">
                            <div class="flex flex-col leading-none w-32 font-black">
                                <span class="text-[10px] font-black text-blue-600 uppercase mb-1 leading-none italic font-black">${t.n}</span>
                                <span class="text-[8px] text-slate-400 font-bold leading-none mt-1 italic text-[7px] font-black">T·ªìn: ${stock[t.id].toFixed(2)} Kg</span>
                            </div>
                            <input type="number" id="exp-qty-${t.id}" step="0.01" class="input-box !p-2 !text-center font-black !bg-slate-50 flex-1 mx-3 shadow-inner font-black" placeholder="0.00">
                        </div>`).join('');
                },

                calcTH: () => {
                    const ids = ['th-b2','th-a1','th-a2','th-b1','th-chan','th-d1','th-a1f','th-a2f','th-b2f','th-ht'];
                    let sum = 0; ids.forEach(id => sum += Number(document.getElementById(id)?.value)||0);
                    const disp = document.getElementById('th-total-display'); if(disp) disp.innerText = sum.toFixed(2) + ' kg';
                },

                resetTHInputs: () => {
                    ['th-b2','th-a1','th-a2','th-b1','th-chan','th-d1','th-a1f','th-a2f','th-b2f','th-ht','th-bad','th-note'].forEach(id => {
                        const el = document.getElementById(id); if(el) el.value = '';
                    });
                    const disp = document.getElementById('th-total-display'); if(disp) disp.innerText = '0.00 kg';
                },

                setSXMode: (m) => {
                    document.getElementById('sx-action').value = m;
                    document.getElementById('btn-sx-nhap').className = m==='NH·∫¨P' ? 'flex-1 py-3 rounded-lg text-xs font-black bg-blue-600 text-white shadow-md uppercase transition italic font-black shadow-inner font-black' : 'flex-1 py-3 rounded-lg text-xs font-black text-slate-400 uppercase transition italic font-black';
                    document.getElementById('btn-sx-xuat').className = m==='XU·∫§T' ? 'flex-1 py-3 rounded-lg text-xs font-black bg-orange-500 text-white shadow-md uppercase transition italic font-black shadow-inner font-black' : 'flex-1 py-3 rounded-lg text-xs font-black text-slate-400 uppercase transition italic font-black';
                },
                toggleAssign: () => {
                    const m = document.getElementById('assign-mode')?.value;
                    document.getElementById('assign-ind-zone')?.classList.toggle('hidden', m !== 'ind');
                    document.getElementById('assign-team-zone')?.classList.toggle('hidden', m !== 'team');
                }
            },

            init: () => {
                window.app.ui.initPWA();
                signInAnonymously(auth).then(() => {
                    const statusText = document.getElementById('status-text'); if(statusText) statusText.innerText = 'C∆° s·ªü Heritage: ƒê√£ K·∫øt N·ªëi';
                    const dot = document.querySelector('#login-status .status-dot'); if(dot) dot.className = 'status-dot status-ok';
                    window.app.sync();
                });
                if ("Notification" in window && Notification.permission === 'default') { Notification.requestPermission(); }
                const dateEl = document.getElementById('sx-date');
                if(dateEl) dateEl.valueAsDate = new Date();
            },

            sync: () => {
                const mapData = s => s.docs.map(d => ({...d.data(), _id: d.id}));
                onSnapshot(collection(db, `${ROOT}/employees`), s => {
                    window.app.data.employees = mapData(s);
                    window.app.renderLogin();
                    if(window.app.user) { window.app.renderTeam(); window.app.renderApp(); }
                });
                onSnapshot(collection(db, `${ROOT}/chat`), s => {
                    window.app.data.chat = s.docs.map(d => ({...d.data(), _id: d.id})).sort((a,b) => a.time - b.time);
                    if(window.app.user) window.app.renderChat();
                });
                ['houses', 'harvest_logs', 'export_logs', 'attendance_logs', 'production_logs', 'tasks', 'hr_requests'].forEach(col => {
                    onSnapshot(collection(db, `${ROOT}/${col}`), s => {
                        const d = mapData(s);
                        if (col === 'harvest_logs') window.app.data.harvest = d;
                        else if (col === 'export_logs') window.app.data.exports = d;
                        else if (col === 'attendance_logs') window.app.data.attendance = d;
                        else if (col === 'production_logs') window.app.data.production = d;
                        else window.app.data[col] = d;
                        if(window.app.user) window.app.renderDynamic();
                    });
                });
            },

            renderLogin: () => {
                const s = document.getElementById('login-user');
                if (s && window.app.data.employees.length > 0) {
                    const savedId = s.value;
                    s.innerHTML = '<option value="">-- Click ch·ªçn danh t√≠nh --</option>' + 
                        window.app.data.employees.map(e => `<option value="${e.id}" ${e.id==savedId?'selected':''}>${e.name}</option>`).join('');
                    s.disabled = false;
                    const pin = document.getElementById('login-pin'); if(pin) pin.disabled = false;
                    const btn = document.getElementById('login-btn'); if(btn) btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if(window.app.user) {
                    const overlay = document.getElementById('login-overlay');
                    if(overlay) overlay.classList.add('hidden');
                    window.app.renderApp();
                    window.app.ui.tab('home');
                }
            },

            doLogin: () => {
                const id = document.getElementById('login-user').value;
                const pin = document.getElementById('login-pin').value.trim();
                const emp = window.app.data.employees.find(e => String(e.id) === String(id) && String(e.pin).trim() === String(pin));
                if(emp) {
                    window.app.user = emp; localStorage.setItem('n5_v101_user', JSON.stringify(emp));
                    document.getElementById('login-overlay').classList.add('hidden'); 
                    window.app.renderApp();
                    window.app.ui.tab('home');
                } else window.app.ui.showMsg("M√£ PIN ch∆∞a ch√≠nh x√°c!");
            },

            renderApp: () => {
                if(!window.app.user) return;
                document.getElementById('head-user').innerText = window.app.user.name;
                document.getElementById('head-role').innerText = window.app.user.role;
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(window.app.user.role);
                if(isAdmin) {
                    document.getElementById('admin-tools')?.classList.remove('hidden');
                    document.getElementById('admin-task-form')?.classList.remove('hidden');
                }
                window.app.renderDynamic();
                window.app.renderTeam();
            },

            renderDynamic: () => {
                if(!window.app.user) return;
                const todayStr = new Date().toISOString().split('T')[0];
                const totalYield = window.app.data.harvest.filter(h => new Date(h.time).toDateString() === new Date().toDateString()).reduce((a,b) => a + (b.total||0), 0);
                document.getElementById('stat-online').innerText = window.app.data.employees.filter(e=>e.lastLogin === todayStr).length;
                document.getElementById('stat-yield').innerText = totalYield.toFixed(2);

                const houseMulti = document.getElementById('house-multi-select');
                if (houseMulti) houseMulti.innerHTML = window.app.data.houses.map(h => `<label class="flex items-center gap-1 text-[10px] font-bold bg-white p-2 rounded border shadow-sm font-black italic"><input type="checkbox" name="h-chk" value="${h.name}"> ${h.name}</label>`).join('');

                const assignInd = document.getElementById('assign-ind-zone');
                if (assignInd) assignInd.innerHTML = window.app.data.employees.map(e => `<label class="flex items-center gap-1 text-[10px] font-bold bg-white p-2 rounded border shadow-sm font-black italic leading-none font-black"><input type="checkbox" name="u-chk" value="${e.id}"> ${e.name}</label>`).join('');

                // FIX Dropdown Nh√†
                const thArea = document.getElementById('th-area');
                if (thArea && window.app.data.houses.length > 0) {
                    const cur = thArea.value;
                    thArea.innerHTML = '<option value="">-- Ch·ªçn Nh√† N·∫•m --</option>' + window.app.data.houses.map(h => `<option value="${h.name}" ${h.name===cur?'selected':''}>${h.name}</option>`).join('');
                }
                
                const sxHouseDropdown = document.getElementById('sx-house-id');
                if(sxHouseDropdown && window.app.data.houses.length > 0) {
                    const cur = sxHouseDropdown.value;
                    sxHouseDropdown.innerHTML = '<option value="">-- Ch·ªçn Nh√† N·∫•m --</option>' + window.app.data.houses.map(h => `<option value="${h.name}" ${h.name===cur?'selected':''}>${h.name}</option>`).join('');
                }

                // Nh·∫≠t k√Ω nh√† (Kg v√† Ng√†y)
                document.getElementById('house-list').innerHTML = window.app.data.houses.map(h => {
                    const lastH = [...window.app.data.harvest].filter(x => x.area === h.name).pop();
                    const lastDate = lastH ? new Date(lastH.time).toLocaleDateString('vi-VN') : 'N/A';
                    return `
                    <div class="card border-l-4 border-amber-800 shadow-sm transition active:scale-95">
                        <div class="flex justify-between items-start">
                            <div class="leading-none flex-1 mr-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <p class="font-black text-sm uppercase text-slate-800 leading-none font-black italic leading-none">${h.name}</p>
                                    <button onclick="app.actions.exportCSVByHouse('${h.name}')" class="text-[8px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded shadow-inner uppercase font-black italic border leading-none font-black">BC Nh√†</button>
                                </div>
                                <p class="text-[9px] text-slate-400 font-bold uppercase italic leading-none tracking-tight font-black font-black">Nhi·ªát: AM ${h.temp?.am||0}¬∞ | PM ${h.temp?.pm||0}¬∞</p>
                            </div>
                            <button onclick="app.actions.openTemp('${h._id}', '${h.name}')" class="bg-orange-50 text-orange-600 w-9 h-9 rounded-full flex items-center justify-center border border-orange-100 shadow-sm active:scale-75 transition shadow-md"><i class="fas fa-thermometer-half text-xs"></i></button>
                        </div>
                        <div class="bg-slate-50 p-2.5 rounded-xl border border-slate-100 mt-3 flex justify-between items-center shadow-inner">
                            <p class="text-[11px] font-bold text-slate-600 leading-none italic font-black font-black font-black">${lastH ? `H√°i <span class="text-blue-600 font-black">${lastH.total.toFixed(2)} Kg</span>` : 'S·∫°ch n·∫•m'}</p>
                            <p class="text-[10px] font-bold text-slate-400 italic leading-none font-black font-black uppercase">${lastDate}</p>
                        </div>
                    </div>`}).join('');

                // Gom vi·ªác theo nh√¢n vi√™n
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(window.app.user.role);
                const taskGroup = {}; 
                window.app.data.tasks.filter(t => t.status !== 'completed').forEach(t => {
                    const emp = window.app.data.employees.find(e => String(e.id) === String(t.assignee));
                    const name = emp ? emp.name : 'Nh√¢n s·ª±';
                    if(!taskGroup[name]) taskGroup[name] = [];
                    taskGroup[name].push(t);
                });

                document.getElementById('task-list-grouped').innerHTML = Object.keys(taskGroup).length ? Object.keys(taskGroup).map(name => `
                    <div class="card !p-0 overflow-hidden border-2 border-slate-100 shadow-sm">
                        <div class="bg-slate-100 p-3.5 flex justify-between items-center border-b">
                            <span class="font-black text-xs uppercase text-slate-700 leading-none italic font-black font-black leading-none">${name}</span>
                            ${isAdmin ? `<button onclick="app.actions.nudgeStaff('${name}')" class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-[9px] font-black uppercase shadow-sm italic leading-none">Th√∫c gi·ª•c</button>` : ''}
                        </div>
                        <div class="p-3.5 space-y-2 font-black">
                            ${taskGroup[name].map(t => `
                                <div class="flex justify-between items-center border-b border-dashed border-slate-100 pb-2 last:border-0 last:pb-0 font-black">
                                    <div class="leading-tight flex-1 mr-2"><p class="font-bold text-[11px] text-slate-700 font-black italic uppercase font-black leading-none">${t.title}</p><p class="text-[9px] text-indigo-500 italic uppercase font-black leading-none mt-1.5 font-black">T·∫°i: ${t.houseId}</p></div>
                                    <div class="flex gap-2">
                                        ${isAdmin ? `<button onclick="app.actions.delTask('${t._id}')" class="text-red-400 w-7 h-7 flex items-center justify-center bg-red-50 rounded-lg shadow-sm border border-red-100"><i class="fas fa-trash-alt text-[10px]"></i></button>` : ''}
                                        ${String(t.assignee) === String(window.app.user.id) ? `<button onclick="app.actions.completeTask('${t._id}', '${t.title}')" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-[9px] font-black shadow-sm italic uppercase font-black">XONG</button>` : ''}
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>`).join('') : '<p class="text-center py-10 text-slate-400 font-bold uppercase text-[10px] italic leading-none font-black font-black">S·∫°ch l·ªánh c√¥ng vi·ªác Heritage</p>';

                document.getElementById('sx-log-list').innerHTML = (window.app.data.production || []).slice(-15).reverse().map(l => `
                    <div class="text-[10px] p-3 bg-white mb-1 border rounded-xl flex justify-between shadow-sm border-l-4 ${l.action==='NH·∫¨P'?'border-l-blue-500':'border-l-amber-700'}">
                        <div class="flex flex-col leading-none font-black">
                            <span class="font-black italic uppercase ${l.action==='NH·∫¨P'?'text-blue-600':'text-amber-800'} text-[9px] font-black">${l.action} ${l.qty} T√öI - ${l.house}</span>
                            <span class="text-slate-400 font-bold text-[8px] mt-1 italic font-black">${l.type} | L√¥ ${l.batch}</span>
                        </div>
                        <span class="text-slate-300 font-black italic text-[8px] font-black leading-none">${l.date}</span>
                    </div>`).join('');

                window.app.renderLeaderboard();
                window.app.renderTHTable();
            },

            renderTHTable: () => {
                const el = document.getElementById('harvest-recent-table');
                if(!el) return;
                const logs = [...window.app.data.harvest].sort((a,b) => b.time - a.time).slice(0, 15);
                const twoDaysMs = 2 * 24 * 60 * 60 * 1000;
                const expRecent = window.app.data.exports.filter(e => (Date.now() - e.time) < twoDaysMs).sort((a,b)=>b.time-a.time);

                el.innerHTML = `
                <table class="log-table shadow-sm mb-6">
                    <thead><tr><th>Nh√†</th><th>DABF</th><th>AB</th><th>B</th><th>HT</th><th>T·ªïng</th><th>User</th></tr></thead>
                    <tbody>${logs.map(l => {
                            const d = l.details || {};
                            const DABF = (Number(d.d1)||0) + (Number(d.a1f)||0) + (Number(d.a2f)||0) + (Number(d.b1f)||0) + (Number(d.b2f)||0);
                            const AB = (Number(d.a1)||0) + (Number(d.a2)||0);
                            const B = (Number(d.b1)||0) + (Number(d.b2)||0);
                            return `<tr><td class="font-black text-blue-600 italic leading-none font-black">${l.area}</td><td>${DABF.toFixed(2)}</td><td>${AB.toFixed(2)}</td><td>${B.toFixed(2)}</td><td class="text-orange-600 font-black italic font-black font-black">${(Number(d.ht)||0).toFixed(2)}</td><td class="font-black bg-slate-50">${l.total.toFixed(2)}</td><td class="tracking-tighter font-bold uppercase text-slate-400 opacity-60 leading-none font-black italic font-black font-black">${l.user}</td></tr>`}).join('')}
                    </tbody>
                </table>
                <p class="label px-1 mt-4 text-blue-600 font-black italic uppercase text-[9px] leading-none mb-1 font-black italic">Xu·∫•t kho t∆∞∆°i (2 ng√†y g·∫ßn nh·∫•t)</p>
                <table class="log-table shadow-sm mt-2 font-black">
                    <thead><tr><th>Ng√†y</th><th>Kh√°ch</th><th>T·ªïng</th><th>User</th></tr></thead>
                    <tbody>${expRecent.map(e => `<tr><td>${new Date(e.time).toLocaleDateString('vi-VN')}</td><td class="font-black italic font-black">${e.customer}</td><td class="text-green-600 font-black font-black">${e.total_qty.toFixed(2)}</td><td class="uppercase text-[7px] font-black leading-none italic opacity-60 font-black">${e.user}</td></tr>`).join('')}</tbody>
                </table>`;
            },

            renderLeaderboard: () => {
                const el = document.getElementById('leaderboard');
                if(!el) return;
                const sorted = [...window.app.data.employees].sort((a,b) => (b.score||0) - (a.score||0)).slice(0, 5);
                el.innerHTML = sorted.map((e, i) => `
                    <div class="flex justify-between items-center p-2.5 bg-slate-50 rounded-xl border mb-1">
                        <div class="flex items-center gap-2">
                            <span class="w-5 h-5 flex items-center justify-center ${i===0?'bg-yellow-500 font-black':'bg-blue-600'} text-white rounded-full font-black text-[9px] shadow-sm italic font-black">${i+1}</span>
                            <span class="font-bold text-slate-700 uppercase text-[11px] italic font-black leading-none font-black font-black">${e.name}</span>
                        </div>
                        <span class="font-black text-blue-600 text-[11px] leading-none italic font-black font-black font-black font-black">${(e.score||0).toFixed(0)}ƒë</span>
                    </div>`).join('');
            },

            renderTeam: () => {
                const list = document.getElementById('team-list');
                if(!list) return;
                const todayStr = new Date().toISOString().split('T')[0];
                list.innerHTML = window.app.data.employees.map(e => `
                    <div class="card flex justify-between items-center !p-4 ${e.lastLogin===todayStr?'staff-online shadow-md font-black':'border-slate-200 staff-offline shadow-none'}">
                        <div class="flex items-center gap-4">
                            <div class="w-11 h-11 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-600 border-2 border-white shadow-inner uppercase text-lg italic leading-none font-black">${e.name.charAt(0)}</div>
                            <div>
                                <p class="text-sm font-bold uppercase text-slate-700 leading-none font-black italic font-black font-black">${e.name}</p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase mt-1.5 italic font-black leading-none font-black font-black font-black">${e.team || 'N/A'} | ${e.role}</p>
                            </div>
                        </div>
                        ${['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(window.app.user.role) ? `<button onclick="app.actions.delEmployee('${e._id}', '${e.name}')" class="text-red-300 w-10 h-10 flex items-center justify-center active:scale-75 transition shadow-sm"><i class="fas fa-trash-alt text-xs"></i></button>` : ''}
                    </div>`).join('');
            },

            renderChat: () => {
                const box = document.getElementById('chat-box');
                if(!box) return;
                box.innerHTML = (window.app.data.chat || []).map((m) => {
                    const isMe = String(m.senderId) === String(window.app.user.id);
                    const isSys = m.senderId === 'SYSTEM';
                    if(isSys) return `<div class="chat-system shadow-sm border font-black italic leading-none">üì¢ ${m.text}</div>`;
                    let reacts = m.reactions ? `<div class="reaction-bar">${Object.entries(m.reactions).map(([r, count]) => `<span>${r}${count > 1 ? count : ''}</span>`).join('')}</div>` : '';
                    return `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <div class="chat-sender-tag text-[9px] font-black uppercase text-slate-400 mb-1 px-1 leading-none italic font-black font-black font-black font-black font-black leading-none">${isMe ? '' : m.senderName}</div>
                        <div class="chat-bubble ${isMe ? 'chat-me' : 'chat-other'} font-medium shadow-sm relative italic font-black font-black leading-none" ondblclick="app.actions.reactMessage('${m._id}', '‚ù§Ô∏è')">
                            ${m.text}${reacts}
                        </div>
                    </div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            },

            actions: {
                notify: (title, body) => { if ("Notification" in window && Notification.permission === "granted") { new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3252/3252932.png' }); }},
                logout: () => { localStorage.removeItem('n5_v101_user'); location.reload(); },
                
                pushChatNotify: async (msg) => {
                    await addDoc(collection(db, `${ROOT}/chat`), { text: msg, senderId: 'SYSTEM', senderName: 'H·ªÜ TH·ªêNG', time: Date.now() });
                },

                nudgeStaff: async (name) => {
                    await window.app.actions.pushChatNotify(`TH√öC GI·ª§C: Qu·∫£n l√Ω y√™u c·∫ßu [${name}] kh·∫©n tr∆∞∆°ng ho√†n th√†nh c√°c vi·ªác t·ªìn ƒë·ªçng ngay!`);
                },
                createTask: async () => {
                    const title = document.getElementById('task-title').value;
                    const h = Array.from(document.querySelectorAll('input[name="h-chk"]:checked')).map(i => i.value);
                    const u = Array.from(document.querySelectorAll('input[name="u-chk"]:checked')).map(i => i.value);
                    if(!title || h.length===0 || u.length===0) return window.app.ui.showMsg("Thi·∫øu tin!");
                    for(let house of h) for(let uid of u) { await addDoc(collection(db, `${ROOT}/tasks`), { title, houseId: house, assignee: uid, status: 'pending', time: Date.now() }); }
                    await window.app.actions.pushChatNotify(`GIAO VI·ªÜC: L·ªánh m·ªõi [${title}] t·∫°i Nh√† ${h.join(', ')}`);
                },
                completeTask: async (id, title) => {
                    await updateDoc(doc(db, `${ROOT}/tasks`, id), { status: 'completed', finishTime: Date.now() });
                    await window.app.actions.pushChatNotify(`B√ÅO C√ÅO: ${window.app.user.name} ƒë√£ l√†m xong vi·ªác: ${title}`);
                },
                delTask: async (id) => { if(confirm("X√≥a l·ªánh n√†y?")) deleteDoc(doc(db, `${ROOT}/tasks`, id)); },
                submitTH: async () => {
                    const area = document.getElementById('th-area')?.value; if(!area) return window.app.ui.showMsg("H√£y ch·ªçn nh√† n·∫•m!");
                    const d = {}; ['b2','a1','a2','b1','chan','d1','a1f','a2f','b2f','ht'].forEach(id => d[id] = Number(document.getElementById('th-'+id)?.value) || 0);
                    const total = Object.values(d).reduce((a,b)=>a+b,0);
                    if(total === 0) return window.app.ui.showMsg("Ch∆∞a nh·∫≠p s·ªë l∆∞·ª£ng!");
                    await addDoc(collection(db, `${ROOT}/harvest_logs`), { area, details: d, total, user: window.app.user.name, time: Date.now() });
                    await updateDoc(doc(db, `${ROOT}/employees`, window.app.user._id), { score: (window.app.user.score||0) + 10 });
                    await window.app.actions.pushChatNotify(`THU HO·∫†CH: ${window.app.user.name} v·ª´a h√°i ${total.toFixed(2)} Kg n·∫•m s·∫°ch t·∫°i Nh√† ${area}`);
                    window.app.ui.showMsg("ƒê√£ l∆∞u h√°i!"); window.app.ui.resetTHInputs();
                },
                submitExport: async () => {
                    const customer = document.getElementById('export-customer-name')?.value; if(!customer) return window.app.ui.showMsg("Nh·∫≠p kh√°ch!");
                    const types = ['b2','a1','a2','b1','chan','d1','a1f','a2f','b2f','ht'];
                    const det = {}; let total = 0;
                    types.forEach(t => { const v = Number(document.getElementById('exp-qty-'+t)?.value) || 0; if(v > 0) { det[t] = v; total += v; } });
                    if(total === 0) return window.app.ui.showMsg("Nh·∫≠p s·ªë l∆∞·ª£ng!");
                    await addDoc(collection(db, `${ROOT}/export_logs`), { customer, details: det, total_qty: total, time: Date.now(), user: window.app.user.name });
                    await window.app.actions.pushChatNotify(`XU·∫§T KHO: ${window.app.user.name} ch·ªët ƒë∆°n ${total.toFixed(2)} Kg cho ${customer}`);
                    window.app.ui.showMsg("ƒê√£ xu·∫•t kho!"); document.getElementById('export-customer-name').value = '';
                },
                submitSX: async (action) => {
                    const house = document.getElementById('sx-house-id').value;
                    const type = document.getElementById('sx-type').value;
                    const qty = Number(document.getElementById('sx-qty').value);
                    const batch = document.getElementById('sx-batch').value;
                    const date = document.getElementById('sx-date').value;
                    if(!house || !type || !qty) return window.app.ui.showMsg("Ch·ªçn nh√† & Lo·∫°i ph√¥i!");
                    const data = { action, house, type, qty, batch, date, user: window.app.user.name, time: Date.now() };
                    await addDoc(collection(db, `${ROOT}/production_logs`), data);
                    await window.app.actions.pushChatNotify(`S·∫¢N XU·∫§T: ${window.app.user.name} ${action} ${qty} t√∫i ph√¥i t·∫°i Nh√† ${house} (${type})`);
                    app.ui.showMsg("ƒê√£ l∆∞u d·ªØ li·ªáu SX!");
                },
                checkIn: async (shift) => { 
                    const today = new Date().toISOString().split('T')[0]; 
                    await updateDoc(doc(db, `${ROOT}/employees`, window.app.user._id), { lastLogin: today, score: (window.app.user.score||0) + 2 }); 
                    await addDoc(collection(db, `${ROOT}/attendance_logs`), { date: today, time: Date.now(), user: window.app.user.name, uid: window.app.user.id, shift, team: window.app.user.team || 'Th√†nh vi√™n' });
                    await window.app.actions.pushChatNotify(`ƒêI·ªÇM DANH: ${window.app.user.name} v√†o ca ${shift.toUpperCase()}`);
                    app.ui.showMsg("ƒêi·ªÉm danh th√†nh c√¥ng!"); 
                },
                reactMessage: async (msgId, icon) => {
                    const log = window.app.data.chat.find(m => m._id === msgId); if(!log) return;
                    const reactions = log.reactions || {}; reactions[icon] = (reactions[icon] || 0) + 1;
                    await updateDoc(doc(db, `${ROOT}/chat`, msgId), { reactions });
                },
                sendChat: async (emoji = null) => { 
                    const input = document.getElementById('chat-input'); const text = emoji || input.value; if(!text) return; 
                    await addDoc(collection(db, `${ROOT}/chat`), { text, senderId: String(window.app.user.id), senderName: window.app.user.name, time: Date.now() }); 
                    if(input) input.value = ''; 
                },
                sendReaction: async (icon) => {
                    // Th·∫£ Tim v√†o tin nh·∫Øn cu·ªëi kh√¥ng ph·∫£i c·ªßa H·ªá Th·ªëng
                    const lastMsg = [...window.app.data.chat].filter(m => m.senderId !== 'SYSTEM').pop();
                    if(lastMsg) { await window.app.actions.reactMessage(lastMsg._id, icon); }
                    else { await window.app.actions.sendChat(icon); }
                },
                submitHR: async (type) => { 
                    const content = type==='LEAVE' ? document.getElementById('leave-date').value : document.getElementById('pur-item').value;
                    const label = type==='LEAVE' ? 'XIN NGH·ªà' : 'MUA H√ÄNG';
                    await addDoc(collection(db, `${ROOT}/hr_requests`), { type, requester: window.app.user.name, status: 'pending', content, time: Date.now() }); 
                    await window.app.actions.pushChatNotify(`H√ÄNH CH√çNH: ${window.app.user.name} tr√¨nh ƒë∆°n ${label}: ${content}`);
                    window.app.ui.showMsg("ƒê√£ tr√¨nh ƒë∆°n!"); window.app.ui.closeModal(type==='LEAVE'?'modal-leave':'modal-buy'); 
                },

                // --- X·ª¨ L√ù CSV T√ÅCH BI·ªÜT C·ªòT + FIX L·ªñI FONT (FINAL FIX) ---
                downloadCSV: (csv, filename) => {
                    // B∆∞·ªõc 1: Th√™m BOM (Byte Order Mark) ƒë·ªÉ Excel nh·∫≠n di·ªán UTF-8
                    const bom = "\uFEFF";
                    // B∆∞·ªõc 2: Th√™m ch·ªâ th·ªã sep=; ƒë·ªÉ Excel t·ª± ƒë·ªông t√°ch c·ªôt ngay
                    const head = "sep=;\n";
                    const content = bom + head + csv;
                    // B∆∞·ªõc 3: T·∫°o Blob v√† t·∫£i v·ªÅ
                    const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url); link.setAttribute("download", filename);
                    link.style.visibility = 'hidden'; document.body.appendChild(link);
                    link.click(); document.body.removeChild(link);
                },
                exportAttendance: () => {
                    let csv = "NG√ÄY;GI·ªú;NH√ÇN VI√äN;ID;CA L√ÄM;T·ªî ƒê·ªòI\n";
                    window.app.data.attendance.filter(a => a.team === window.app.user.team || ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(window.app.user.role)).sort((a,b)=>b.time-a.time).forEach(l => {
                        csv += `${l.date};${new Date(l.time).toLocaleTimeString()};${l.user};${l.uid};${l.shift};${l.team}\n`;
                    });
                    window.app.actions.downloadCSV(csv, "BaoCao_ChamCong_Heritage.csv");
                },
                exportTH: () => {
                    let csv = "NG√ÄY;GI·ªú;NH√Ä;DABF;AB;B;HT;T·ªîNG;USER\n";
                    window.app.data.harvest.sort((a,b)=>b.time-a.time).forEach(l => {
                        const d = l.details || {};
                        const DABF = (Number(d.d1)||0) + (Number(d.a1f)||0) + (Number(d.a2f)||0) + (Number(d.b1f)||0) + (Number(d.b2f)||0);
                        const AB = (Number(d.a1)||0) + (Number(d.a2)||0);
                        const B = (Number(d.b1)||0) + (Number(d.b2)||0);
                        csv += `${new Date(l.time).toLocaleDateString()};${new Date(l.time).toLocaleTimeString()};${l.area};${DABF.toFixed(2)};${AB.toFixed(2)};${B.toFixed(2)};${(Number(d.ht)||0).toFixed(2)};${l.total.toFixed(2)};${l.user}\n`;
                    });
                    window.app.actions.downloadCSV(csv, "BaoCao_TongHeThong.csv");
                },
                exportCSVByTeam: (teamName) => {
                    let csv = "NG√ÄY;GI·ªú;USER;NH√Ä;S·∫¢N L∆Ø·ª¢NG;T·ªî\n";
                    window.app.data.harvest.filter(a => {
                        const emp = window.app.data.employees.find(e => e.name === a.user);
                        return emp && emp.team === teamName;
                    }).forEach(l => {
                        csv += `${new Date(l.time).toLocaleDateString()};${new Date(l.time).toLocaleTimeString()};${l.user};${l.area};${l.total.toFixed(2)};${teamName}\n`;
                    });
                    window.app.actions.downloadCSV(csv, `BaoCao_SanLuong_To_${teamName}.csv`);
                },
                exportCSVByHouse: (houseName) => {
                    let csv = "NG√ÄY;GI·ªú;USER;DABF;AB;B;HT;T·ªîNG\n";
                    window.app.data.harvest.filter(h => h.area === houseName).forEach(l => {
                        const d = l.details || {};
                        const DABF = (Number(d.d1)||0) + (Number(d.a1f)||0) + (Number(d.a2f)||0) + (Number(d.b1f)||0) + (Number(d.b2f)||0);
                        const AB = (Number(d.a1)||0) + (Number(d.a2)||0);
                        const B = (Number(d.b1)||0) + (Number(d.b2)||0);
                        csv += `${new Date(l.time).toLocaleDateString()};${new Date(l.time).toLocaleTimeString()};${l.user};${DABF.toFixed(2)};${AB.toFixed(2)};${B.toFixed(2)};${(Number(d.ht)||0).toFixed(2)};${l.total.toFixed(2)}\n`;
                    });
                    window.app.actions.downloadCSV(csv, `BaoCao_Nha_${houseName}.csv`);
                },
                resetLeaderboard: async () => { if(confirm("RESET ƒêI·ªÇM TH√ÅNG M·ªöI?")) { for(let e of window.app.data.employees) await updateDoc(doc(db, `${ROOT}/employees`, e._id), { score: 0 }); window.app.ui.showMsg("ƒê√£ reset!"); }},
                saveTemp: async () => { const id = document.getElementById('temp-id')?.value; await updateDoc(doc(db, `${ROOT}/houses`, id), { 'temp.am': Number(document.getElementById('temp-am')?.value), 'temp.pm': Number(document.getElementById('temp-pm')?.value) }); app.ui.showMsg("ƒê√£ l∆∞u!"); app.ui.closeModal('modal-temp'); },
                openTemp: (id, name) => { const h = window.app.data.houses.find(x => x._id === id); document.getElementById('temp-id').value = id; document.getElementById('temp-name').innerText = name; document.getElementById('temp-am').value = h.temp?.am||0; document.getElementById('temp-pm').value = h.temp?.pm||0; window.app.ui.showModal('modal-temp'); },
                addEmployee: async () => { const n = document.getElementById('new-emp-name').value; const id = Number(document.getElementById('new-emp-id').value); const p = document.getElementById('new-emp-pin').value; if(!n||!id||!p) return window.app.ui.showMsg("Thi·∫øu tin!"); await addDoc(collection(db, `${ROOT}/employees`), { id, name: n, pin: p, team: document.getElementById('new-emp-team').value, role: document.getElementById('new-emp-role').value, score: 0 }); app.ui.closeModal('modal-add-staff'); window.app.ui.showMsg("ƒê√£ th√™m nh√¢n s·ª±!"); },
                delEmployee: async (id, name) => { if(confirm(`X√≥a nh√¢n s·ª± ${name}?`)) deleteDoc(doc(db, `${ROOT}/employees`, id)); },
                addHouse: async () => { const name = prompt("T√™n nh√† n·∫•m m·ªõi:"); if(name) await addDoc(collection(db, `${ROOT}/houses`), { name, temp: {am:0, pm:0} }); }
            }
        };
        window.onload = window.app.init;
    </script>
</body>
</html>
