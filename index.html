<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NẤM ÔNG 5 – V75 FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- React core (NO JSX) -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f5f5f5;padding:10px}
input,select,button{width:100%;padding:10px;margin:5px 0;font-size:16px}
button{background:#2e7d32;color:#fff;border:none;border-radius:4px}
.box{background:#fff;padding:12px;border-radius:6px;margin-bottom:10px}
.hidden{display:none}
</style>
</head>

<body>
<div id="root"></div>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  projectId: "YOUR_PROJECT_ID"
});
const db = firebase.firestore();

/* ================= APP STATE ================= */
const e = React.createElement;

const AppContext = {
  user: null,
  employees: []
};

/* ================= LOGIN MODULE ================= */
function LoginModule({ onLogin }) {
  const [emps, setEmps] = React.useState([]);
  const [ready, setReady] = React.useState(false);

  React.useEffect(() => {
    db.collection("employees").get().then(snap => {
      const list = snap.docs.map(d => d.data());
      setEmps(list);
      setReady(true);
    });
  }, []);

  function doLogin() {
    const id = document.getElementById("login-user").value;
    const pin = document.getElementById("login-pin").value;

    if (!id || !pin) {
      alert("Chưa nhập đủ thông tin");
      return;
    }

    const emp = emps.find(e =>
      String(e.id) === String(id) &&
      String(e.pin).replace(/\D/g,'') === String(pin).replace(/\D/g,'')
    );

    if (!emp) {
      alert("Sai PIN");
      return;
    }

    localStorage.setItem("ong5_user", JSON.stringify(emp));
    onLogin(emp);
  }

  if (!ready) {
    return e("div",{className:"box"}, "Đang tải dữ liệu...");
  }

  return e("div",{className:"box"},
    e("h3",null,"ĐĂNG NHẬP"),
    e("select",{id:"login-user"},
      e("option",{value:""},"-- Chọn tên --"),
      emps.map(u => e("option",{key:u.id,value:u.id},u.name))
    ),
    e("input",{id:"login-pin",type:"password",placeholder:"Mã PIN"}),
    e("button",{onClick:doLogin},"Đăng nhập")
  );
}

/* ================= PRODUCTION MODULE ================= */
function Production({ user }) {
  function submit(ev){
    ev.preventDefault();
    const f = ev.target;
    db.collection("production_logs").add({
      date:f.date.value,
      action:f.action.value,
      material:f.material.value,
      quantity:Number(f.qty.value),
      batch:f.batch.value,
      location:f.loc.value,
      destroy:Number(f.destroy.value||0),
      reuse:Number(f.reuse.value||0),
      user:user.name,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{ alert("Đã lưu sản xuất"); f.reset(); });
  }

  return e("div",{className:"box"},
    e("h3",null,"SẢN XUẤT"),
    e("form",{onSubmit:submit},
      e("input",{type:"date",name:"date",required:true}),
      e("select",{name:"action"},
        e("option",{value:"IN"},"Nhập"),
        e("option",{value:"OUT"},"Xuất")
      ),
      e("input",{name:"material",placeholder:"Loại phôi",required:true}),
      e("input",{name:"qty",type:"number",placeholder:"Số lượng",required:true}),
      e("input",{name:"batch",placeholder:"Lô"}),
      e("input",{name:"loc",placeholder:"Nhà"}),
      e("input",{name:"destroy",placeholder:"Số hủy"}),
      e("input",{name:"reuse",placeholder:"Số tận dụng"}),
      e("button",{type:"submit"},"Lưu")
    )
  );
}

/* ================= HARVEST MODULE ================= */
function Harvest({ user }) {
  const fields=["B2","A1","A2","B1","D1","HAU_THU","AB_F","B2_F","B1_F","TRA","LOI","HAO_HUT","XUAT_SAY","HUY_CHAN","NL_SNACK","SNACK_TP"];
  const [data,setData]=React.useState({});
  const total=Object.values(data).reduce((a,b)=>a+Number(b||0),0);

  function save(){
    db.collection("harvest_logs").add({
      date:new Date().toISOString().slice(0,10),
      items:data,
      total:total,
      user:user.name,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{ alert("Đã lưu thu hoạch"); setData({}); });
  }

  return e("div",{className:"box"},
    e("h3",null,"THU HOẠCH"),
    fields.map(f =>
      e("input",{
        key:f,
        placeholder:f,
        type:"number",
        value:data[f]||"",
        onChange:ev=>setData(Object.assign({},data,{[f]:ev.target.value}))
      })
    ),
    e("b",null,"TỔNG: "+total),
    e("button",{onClick:save},"Lưu")
  );
}

/* ================= APP ROOT ================= */
function App(){
  const [user,setUser]=React.useState(null);

  React.useEffect(()=>{
    const u = localStorage.getItem("ong5_user");
    if(u) setUser(JSON.parse(u));
  },[]);

  if(!user){
    return e(LoginModule,{onLogin:setUser});
  }

  return e("div",null,
    e("h3",null,"Xin chào "+user.name),
    e(Production,{user}),
    e(Harvest,{user})
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(e(App));
</script>
</body>
</html>
