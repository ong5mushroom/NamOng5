<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>Nấm Ông 5 V90.1 - Hybrid</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* GIỮ NGUYÊN CSS V65 ĐÃ ỔN ĐỊNH */
        :root { --blue: #2563eb; --header: 60px; --nav: 70px; --bg: #f8fafc; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #1e293b; margin: 0; height: 100vh; overflow: hidden; touch-action: manipulation; }
        
        /* Layout */
        #app-header { height: var(--header); background: white; border-bottom: 1px solid #e2e8f0; position: fixed; top: 0; width: 100%; z-index: 50; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; padding-top: env(safe-area-inset-top); }
        #app-main { margin-top: var(--header); height: calc(100vh - var(--header) - var(--nav)); overflow-y: auto; padding: 16px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        #app-nav { height: var(--nav); background: white; border-top: 1px solid #e2e8f0; position: fixed; bottom: 0; width: 100%; z-index: 50; display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        
        .hidden { display: none !important; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-box { width: 100%; background: #f1f5f9; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; font-weight: 600; outline: none; font-size: 14px; }
        .btn-primary { background: var(--blue); color: white; font-weight: 700; padding: 12px; border-radius: 10px; width: 100%; text-transform: uppercase; font-size: 12px; }
        .nav-btn { color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 2px; font-size: 9px; font-weight: 700; }
        .nav-active { color: var(--blue); } .nav-active i { transform: translateY(-2px); }
        
        /* Login */
        #login-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }
        
        /* Chat */
        .chat-bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; margin-bottom: 6px; font-size: 13px; }
        .chat-me { background: var(--blue); color: white; align-self: flex-end; }
        .chat-other { background: #f1f5f9; align-self: flex-start; }
        
        /* New Styles for V90 Features */
        .stat-badge { font-size: 9px; padding: 2px 4px; border-radius: 4px; background: #eff6ff; color: #1d4ed8; font-weight: bold; display: inline-block; margin: 1px; border: 1px solid #bfdbfe; }
        .input-mini { text-align: center; padding: 6px; font-size: 13px; }
        
        /* Modal */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 16px; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 100%; max-width: 350px; border-radius: 16px; padding: 20px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN (V65 Stable Logic) -->
    <div id="login-screen">
        <div class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center text-white text-4xl font-black mb-6">5</div>
        <h1 class="text-2xl font-black text-slate-800 mb-6">Nấm Ông 5 <span class="text-blue-600">V90.1</span></h1>
        
        <div id="login-loading" class="text-xs font-bold text-slate-400 mb-4 animate-pulse">Đang tải dữ liệu...</div>
        
        <div class="w-full max-w-xs space-y-4">
            <select id="login-user" class="input-box text-center" disabled><option>...</option></select>
            <input type="password" id="login-pin" placeholder="Nhập PIN" class="input-box text-center text-xl tracking-widest" disabled>
            <button id="login-btn" onclick="app.doLogin()" class="btn-primary opacity-50" disabled>ĐĂNG NHẬP</button>
            <button id="rescue-btn" onclick="app.seedAdmin()" class="hidden w-full border border-red-200 text-red-500 py-2 rounded-lg font-bold text-xs mt-4">KHỞI TẠO ADMIN</button>
        </div>
    </div>

    <!-- HEADER -->
    <header id="app-header">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">5</div>
            <span class="font-bold text-slate-800">Nấm Ông 5</span>
        </div>
        <div class="flex items-center gap-2">
            <span id="ui-user" class="text-xs font-bold text-slate-500">...</span>
            <button onclick="app.ui.toggleModal('settings-modal')" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center"><i class="fas fa-cog text-slate-500"></i></button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="app-main">
        
        <!-- HOME (V65 Layout) -->
        <div id="tab-home" class="tab-content">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="card text-center !py-3 !mb-0 border-l-4 border-blue-500">
                    <p class="text-[10px] uppercase text-slate-400 font-bold">Nhân sự</p>
                    <p class="text-2xl font-black text-blue-600" id="stat-online">0</p>
                </div>
                <div class="card text-center !py-3 !mb-0 border-l-4 border-green-500">
                    <p class="text-[10px] uppercase text-slate-400 font-bold">Tổng hái</p>
                    <p class="text-2xl font-black text-green-600" id="stat-yield">0</p>
                </div>
            </div>
            
            <div class="card !p-3 border border-yellow-100 mb-4">
                <h3 class="text-xs font-bold text-yellow-600 mb-2"><i class="fas fa-crown"></i> Bảng Vàng</h3>
                <div id="leaderboard" class="space-y-2 text-xs"></div>
            </div>

            <h3 class="text-xs font-bold text-slate-500 mb-2 uppercase px-1">Danh sách Nhà</h3>
            <div id="house-list" class="space-y-2"></div>
        </div>

        <!-- TASKS (V65 Structure) -->
        <div id="tab-tasks" class="tab-content hidden">
            <!-- Admin Form -->
            <div id="admin-task-form" class="hidden card border border-blue-100">
                <div class="flex justify-between mb-2"><span class="text-xs font-bold text-blue-600 uppercase">Giao việc</span><select id="assign-mode" onchange="app.toggleAssign()" class="text-[10px] bg-slate-100 p-1 rounded font-bold"><option value="ind">Cá nhân</option><option value="team">Tổ</option></select></div>
                <div class="space-y-2">
                    <input id="task-title" placeholder="Tên công việc..." class="input-box" list="sop-list" onchange="app.fillSop()">
                    <datalist id="sop-list"></datalist>
                    <div id="house-select-container" class="grid grid-cols-3 gap-2 bg-slate-50 p-2 rounded border max-h-24 overflow-y-auto"></div>
                    <input type="number" id="task-target" placeholder="Định mức" class="input-box">
                    <div id="assign-ind-zone" class="max-h-32 overflow-y-auto border p-2 rounded bg-slate-50 space-y-1"></div>
                    <div id="assign-team-zone" class="hidden text-xs font-bold space-y-1"><label class="flex gap-2"><input type="radio" name="team" value="Tổ Sản Xuất" checked> Tổ SX</label><label class="flex gap-2"><input type="radio" name="team" value="Tổ Thu Hoạch"> Tổ TH</label></div>
                    <button onclick="app.createTask()" class="btn-primary bg-slate-800">Ban hành</button>
                </div>
            </div>
            <div id="task-list" class="space-y-2"></div>
        </div>

        <!-- SẢN XUẤT (V90 Features Injected) -->
        <div id="tab-sx" class="tab-content hidden">
            <div class="flex justify-between items-center px-1 mb-2"><h2 class="font-bold text-slate-800">Nhật Ký SX</h2><button onclick="app.actions.exportSX()" class="text-[10px] font-bold text-blue-600 border px-2 py-1 rounded">Excel</button></div>
            <div class="card border-l-4 border-blue-500">
                <div class="flex bg-slate-100 p-1 rounded-lg mb-3">
                    <button onclick="app.setSXMode('NHẬP')" id="btn-sx-nhap" class="flex-1 py-2 rounded-md text-xs font-bold bg-blue-600 text-white shadow">NHẬP KHO</button>
                    <button onclick="app.setSXMode('XUẤT')" id="btn-sx-xuat" class="flex-1 py-2 rounded-md text-xs font-bold text-slate-400">XUẤT KHO</button>
                </div>
                <input type="hidden" id="sx-action" value="NHẬP">
                <div class="space-y-2">
                    <div class="flex gap-2"><input type="date" id="sx-date" class="input-box"><input id="sx-batch" class="input-box text-center" placeholder="Lô cấy"></div>
                    <input id="sx-type" class="input-box" placeholder="Loại phôi (049...)" list="phoi-list">
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="sx-qty" class="input-box text-center font-bold" placeholder="SL">
                        <input type="number" id="sx-bad" class="input-box text-center text-red-500" placeholder="Hủy">
                        <input type="number" id="sx-reuse" class="input-box text-center text-green-500" placeholder="T.Dụng">
                    </div>
                    <input id="sx-dest" class="input-box" placeholder="Nơi Nhập/Xuất">
                    <button onclick="app.submitSX()" class="btn-primary">GHI DỮ LIỆU</button>
                </div>
            </div>
            <div id="sx-log-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- THU HOẠCH (V90 Features Injected) -->
        <div id="tab-th" class="tab-content hidden">
            <div class="flex justify-between items-center px-1 mb-2"><h2 class="font-bold text-slate-800">Thu Hoạch</h2><button onclick="app.actions.exportTH()" class="text-[10px] font-bold text-green-600 border px-2 py-1 rounded">Excel</button></div>
            <div class="card border-l-4 border-green-500">
                <div class="space-y-3">
                    <select id="th-area" class="input-box font-bold text-green-700"></select>
                    <!-- Matrix 9 -->
                    <div class="bg-slate-50 p-2 rounded-lg border">
                        <div class="grid grid-cols-4 gap-1 mb-2">
                            <div><label class="text-[9px] block text-center font-bold">B2</label><input type="number" id="th-b2" class="input-box input-mini" oninput="app.calcTH()"></div>
                            <div><label class="text-[9px] block text-center font-bold">A1</label><input type="number" id="th-a1" class="input-box input-mini" oninput="app.calcTH()"></div>
                            <div><label class="text-[9px] block text-center font-bold">A2</label><input type="number" id="th-a2" class="input-box input-mini" oninput="app.calcTH()"></div>
                            <div><label class="text-[9px] block text-center font-bold">B1</label><input type="number" id="th-b1" class="input-box input-mini" oninput="app.calcTH()"></div>
                        </div>
                        <div class="grid grid-cols-5 gap-1">
                            <div><label class="text-[9px] block text-center font-bold">D1</label><input type="number" id="th-d1" class="input-box input-mini" oninput="app.calcTH()"></div>
                            <div><label class="text-[9px] block text-center font-bold">HT</label><input type="number" id="th-ht" class="input-box input-mini" oninput="app.calcTH()"></div>
                            <div><label class="text-[9px] block text-center font-bold">ABF</label><input type="number" id="th-abf" class="input-box input-mini" oninput="app.calcTH()"></div>
                            <div><label class="text-[9px] block text-center font-bold">B2F</label><input type="number" id="th-b2f" class="input-box input-mini" oninput="app.calcTH()"></div>
                            <div><label class="text-[9px] block text-center font-bold">B1F</label><input type="number" id="th-b1f" class="input-box input-mini" oninput="app.calcTH()"></div>
                        </div>
                        <div id="th-percent-display" class="mt-2 pt-2 border-t text-[9px] flex flex-wrap gap-1"></div>
                    </div>
                    <div class="flex justify-between items-center bg-green-50 p-2 rounded border border-green-200">
                        <span class="text-xs font-bold text-green-800">TỔNG:</span>
                        <span id="th-total-display" class="text-xl font-black text-green-600">0 kg</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <input type="number" id="th-huy-chan" class="input-box input-mini" placeholder="Hủy chân">
                         <input type="number" id="th-doi-tra" class="input-box input-mini" placeholder="Đổi trả">
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <input type="number" id="th-xuat-say" class="input-box input-mini" placeholder="Xuất sấy">
                        <input type="number" id="th-snack-tp" class="input-box input-mini" placeholder="Snack TP">
                        <input type="number" id="th-xuat-snack" class="input-box input-mini" placeholder="Xuất Snack">
                    </div>
                    <input type="text" id="th-note" class="input-box" placeholder="Ghi chú thêm...">
                    <button onclick="app.submitTH()" class="btn-primary bg-green-600">CẬP NHẬT</button>
                </div>
            </div>
            <div id="th-log-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- TEAM -->
        <div id="tab-team" class="tab-content hidden">
            <div class="card border border-blue-100"><p class="label">ĐIỂM DANH</p><div class="grid grid-cols-2 gap-3"><button onclick="app.checkIn('Sáng')" class="btn-primary bg-yellow-500 text-white">CA SÁNG</button><button onclick="app.checkIn('Chiều')" class="btn-primary bg-indigo-500 text-white">CA CHIỀU</button></div></div>
            <div class="card"><p class="label">HÀNH CHÍNH</p><div class="grid grid-cols-2 gap-3"><button onclick="app.ui.toggleModal('modal-leave')" class="btn-primary bg-white text-slate-600 border">Xin nghỉ</button><button onclick="app.ui.toggleModal('modal-buy')" class="btn-primary bg-white text-slate-600 border">Mua hàng</button></div></div>
            <p class="label px-2">NHÂN SỰ</p>
            <div id="team-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- CHAT -->
        <div id="tab-chat" class="tab-content hidden flex flex-col h-full">
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 pb-20"></div>
            <div class="fixed bottom-[70px] left-0 right-0 bg-white p-2 border-t flex gap-2">
                <input id="chat-input" class="flex-1 input-box" placeholder="Nhập tin nhắn..." onkeyup="if(event.key==='Enter') app.sendChat()">
                <button onclick="app.sendChat()" class="w-10 h-10 bg-blue-600 rounded-full text-white flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

    </main>

    <!-- NAV -->
    <nav id="app-nav">
        <button onclick="app.ui.tab('home')" class="nav-btn nav-active" id="btn-home"><i class="fas fa-home text-lg"></i><span>HOME</span></button>
        <button onclick="app.ui.tab('tasks')" class="nav-btn" id="btn-tasks"><i class="fas fa-tasks text-lg"></i><span>VIỆC</span></button>
        <button onclick="app.ui.tab('sx')" class="nav-btn" id="btn-sx"><i class="fas fa-industry text-lg"></i><span>SX</span></button>
        <button onclick="app.ui.tab('th')" class="nav-btn" id="btn-th"><i class="fas fa-box-open text-lg"></i><span>TH</span></button>
        <button onclick="app.ui.tab('team')" class="nav-btn" id="btn-team"><i class="fas fa-users text-lg"></i><span>TEAM</span></button>
        <button onclick="app.ui.tab('chat')" class="nav-btn" id="btn-chat"><i class="fas fa-comments text-lg"></i><span>CHAT</span></button>
    </nav>

    <!-- MODALS -->
    <div id="settings-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.toggleModal('settings-modal')">
        <div class="modal-box">
            <h3 class="font-bold mb-4">Cài đặt</h3>
            <button onclick="app.actions.exportAll()" class="btn-primary bg-white text-blue-600 border mb-2">Xuất Báo Cáo</button>
            <div id="admin-tools" class="hidden border-t pt-2 space-y-2">
                <p class="label">Admin</p>
                <div class="flex gap-2"><input id="new-emp-name" placeholder="Tên" class="input-box"><input id="new-emp-pin" placeholder="PIN" class="input-box w-20"></div>
                <button onclick="app.addEmployee()" class="btn-primary bg-slate-700">Thêm NV</button>
                <button onclick="app.actions.addHouse()" class="btn-primary bg-slate-500">Thêm Nhà</button>
                <button onclick="app.ui.toggleModal('modal-approve')" class="btn-primary bg-green-600">Duyệt Đơn</button>
            </div>
            <button onclick="app.logout()" class="btn-primary bg-red-500 mt-4">Đăng xuất</button>
        </div>
    </div>
    
    <div id="report-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.toggleModal('report-modal')"><div class="modal-box"><h3 class="font-bold text-center mb-4">Báo cáo</h3><input type="hidden" id="report-task-id"><input type="number" id="report-val" placeholder="SL Đạt" class="input-box text-center text-2xl mb-4"><input id="report-note" class="input-box mb-4" placeholder="Ghi chú"><div class="grid grid-cols-2 gap-2"><button onclick="app.submitReport('completed')" class="btn-primary bg-green-600">Xong</button><button onclick="app.submitReport('unfinished')" class="btn-primary bg-orange-500">Chưa</button></div></div></div>
    
    <div id="modal-leave" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.toggleModal('modal-leave')"><div class="modal-box"><h3 class="font-bold mb-2">Xin nghỉ</h3><input id="leave-date" type="date" class="input-box mb-2"><select id="leave-reason" class="input-box mb-2"><option>Ốm</option><option>Việc riêng</option></select><button onclick="app.submitHR('LEAVE')" class="btn-primary">Gửi</button></div></div>
    <div id="modal-buy" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.toggleModal('modal-buy')"><div class="modal-box"><h3 class="font-bold mb-2">Mua hàng</h3><input id="buy-item" placeholder="Tên hàng" class="input-box mb-2"><input id="buy-qty" placeholder="SL & Đơn vị" class="input-box mb-2"><button onclick="app.submitHR('PURCHASE')" class="btn-primary bg-green-600">Gửi</button></div></div>
    <div id="modal-approve" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.toggleModal('modal-approve')"><div class="modal-box"><h3 class="font-bold mb-2">Duyệt đơn</h3><div id="approval-list" class="space-y-2"></div></div></div>
    <div id="modal-temp" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.toggleModal('modal-temp')"><div class="modal-box"><h3 class="font-bold mb-2">Nhiệt độ <span id="temp-name"></span></h3><input type="hidden" id="temp-id"><div class="grid grid-cols-2 gap-2 mb-2"><input id="temp-am" placeholder="Sáng" class="input-box text-center"><input id="temp-pm" placeholder="Chiều" class="input-box text-center"></div><button onclick="app.saveTemp()" class="btn-primary bg-orange-500">Lưu</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fbConfig = { apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", authDomain: "ong5mushroom-vietnam.firebaseapp.com", projectId: "ong5mushroom-vietnam", storageBucket: "ong5mushroom-vietnam.firebasestorage.app", messagingSenderId: "931399604992", appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" };
        const appInstance = initializeApp(fbConfig);
        const db = getFirestore(appInstance);
        const ROOT = "artifacts/namong5_production/public/data";

        window.app = {
            data: { employees: [], houses: [], chat: [], tasks: [], production: [], harvest: [], hr: [] },
            user: JSON.parse(localStorage.getItem('n5_v90_1_user')) || null,
            
            ui: {
                toggleModal: id => { const el = document.getElementById(id); el.classList.toggle('hidden'); },
                tab: id => {
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                    document.getElementById('tab-'+id).classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));
                    const btn = document.querySelector(`button[onclick="app.ui.tab('${id}')"]`);
                    if(btn) btn.classList.add('nav-active');
                    if(id === 'chat') setTimeout(() => document.getElementById('chat-box').scrollTop = 9999, 100);
                }
            },

            init: () => {
                const status = document.getElementById('login-loading');
                setTimeout(() => { 
                    if(app.data.employees.length===0) {
                        status.innerText = "Không tìm thấy dữ liệu. Hãy khởi tạo.";
                        document.getElementById('rescue-btn').classList.remove('hidden');
                    }
                }, 4000);
                
                signInAnonymously(getAuth(appInstance)).then(() => {
                    status.innerText = "Đang đồng bộ...";
                    app.sync();
                });
                document.getElementById('sx-date').valueAsDate = new Date();
            },

            sync: () => {
                onSnapshot(collection(db, `${ROOT}/employees`), s => {
                    app.data.employees = s.docs.map(d => ({...d.data(), _id: d.id}));
                    app.renderLogin();
                    if(app.user) app.renderTeam();
                });
                ['houses', 'tasks', 'production_logs', 'harvest_logs', 'hr_requests', 'attendance_logs', 'sop'].forEach(col => {
                    onSnapshot(collection(db, `${ROOT}/${col}`), s => {
                        const key = col.includes('logs') ? col.split('_')[0] : (col === 'hr_requests' ? 'hr' : col);
                        app.data[key] = s.docs.map(d => ({...d.data(), _id: d.id}));
                        if(app.user) app.renderDynamic();
                    });
                });
                onSnapshot(query(collection(db, `${ROOT}/chat`), orderBy("time", "asc"), limit(50)), s => {
                    app.data.chat = s.docs.map(d => d.data());
                    if(app.user) app.renderChat();
                });
            },

            renderLogin: () => {
                const s = document.getElementById('login-user');
                if (app.data.employees.length > 0) {
                    s.innerHTML = '<option value="">-- Chọn tên --</option>' + app.data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                    s.disabled = false;
                    document.getElementById('login-pin').disabled = false;
                    document.getElementById('login-btn').disabled = false;
                    document.getElementById('login-btn').classList.remove('opacity-50');
                    document.getElementById('login-loading').innerText = "Sẵn sàng";
                    document.getElementById('rescue-btn').classList.add('hidden');
                }
                if(app.user) {
                    document.getElementById('login-screen').classList.add('hidden');
                    app.renderApp();
                }
            },

            doLogin: () => {
                const id = document.getElementById('login-user').value;
                const pin = document.getElementById('login-pin').value.trim();
                const emp = app.data.employees.find(e => String(e.id) === String(id) && String(e.pin).trim() === String(pin));
                if(emp) {
                    app.user = emp; localStorage.setItem('n5_v90_1_user', JSON.stringify(emp));
                    document.getElementById('login-screen').classList.add('hidden'); app.renderApp();
                } else alert("Sai mã PIN!");
            },

            renderApp: () => {
                document.getElementById('ui-user').innerText = app.user.name;
                const isAdmin = ['Giám đốc', 'Quản lý', 'Tổ trưởng'].includes(app.user.role);
                if(isAdmin) {
                    document.getElementById('admin-task-form').classList.remove('hidden');
                    document.getElementById('admin-tools').classList.remove('hidden');
                }
                app.renderDynamic();
            },
            
            renderDynamic: () => {
                // Populate Selects
                const houseOpts = app.data.houses.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
                ['th-area', 'task-house-id'].forEach(id => {
                     const el = document.getElementById(id);
                     if(el && el.innerHTML === "") el.innerHTML = houseOpts;
                });
                const mh = document.getElementById('house-select-container');
                if(mh && mh.innerHTML === "") mh.innerHTML = app.data.houses.map(h => `<label class="flex items-center gap-1 text-[10px] p-2 border rounded"><input type="checkbox" value="${h.name}" name="h-check"> ${h.name}</label>`).join('');

                // 1. HOME
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('stat-online').innerText = app.data.employees.filter(e => e.lastLogin === today).length;
                const yieldKg = app.data.harvest.filter(h => new Date(h.time).toDateString() === new Date().toDateString()).reduce((a,b) => a + (b.total||0), 0);
                document.getElementById('stat-yield').innerText = yieldKg.toLocaleString();
                
                document.getElementById('house-list').innerHTML = app.data.houses.map(h => `
                    <div class="card flex justify-between items-center !p-3 !mb-2 border-l-4 border-blue-500">
                        <div><p class="font-bold text-sm">${h.name}</p><p class="text-[10px] text-slate-400">AM: ${h.temp?.am||'-'} | PM: ${h.temp?.pm||'-'}</p></div>
                        <button onclick="app.actions.openTemp('${h._id}','${h.name}')" class="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-temperature-high text-xs"></i></button>
                    </div>`).join('');
                
                const top = [...app.data.employees].sort((a,b) => (b.score||0) - (a.score||0)).slice(0, 3);
                document.getElementById('leaderboard').innerHTML = top.map((p, i) => `<div class="flex justify-between items-center bg-yellow-50 p-2 rounded mb-1"><span class="font-bold text-xs">#${i+1} ${p.name}</span><span class="font-bold text-yellow-600 text-xs">${p.score || 0}đ</span></div>`).join('');

                // 2. TASKS
                const isAdmin = ['Giám đốc', 'Quản lý'].includes(app.user.role);
                let tasks = app.data.tasks.filter(t => t.status !== 'completed');
                if(!isAdmin) tasks = tasks.filter(t => t.assignee == app.user.id);
                const groups = {}; tasks.forEach(t => { if(!groups[t.assignee]) groups[t.assignee] = []; groups[t.assignee].push(t); });
                document.getElementById('task-list').innerHTML = Object.keys(groups).map(uid => {
                    const name = app.data.employees.find(e => String(e.id) === String(uid))?.name || uid;
                    const items = groups[uid].map(t => {
                        const isStarted = t.status === 'in_progress';
                        return `<div class="flex justify-between items-center p-3 bg-slate-50 rounded mb-2 border"><div><p class="font-bold text-xs">${t.title} (${t.houseId})</p></div><div>${isAdmin?`<button onclick="app.actions.delTask('${t._id}')" class="text-red-500 mr-2"><i class="fas fa-trash"></i></button>`:''}${t.assignee == app.user.id ? (isStarted ? `<button onclick="app.actions.openReport('${t._id}', '${t.title}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">BÁO CÁO</button>` : `<button onclick="app.actions.startTask('${t._id}')" class="bg-green-600 text-white px-2 py-1 rounded text-xs">NHẬN</button>`) : ''}</div></div>`;
                    }).join('');
                    return `<div class="card !p-3 mb-2 border-l-4 border-indigo-500"><p class="text-xs font-bold text-indigo-600 uppercase mb-2">${name}</p>${items}</div>`;
                }).join('');

                // 3. LOGS
                document.getElementById('sx-log-list').innerHTML = app.data.production.slice(0,5).map(l => `<div class="text-[10px] p-2 bg-slate-50 rounded mb-1 border flex justify-between"><span>${l.action} ${l.type}</span><span>${l.qty}</span></div>`).join('');
                document.getElementById('th-log-list').innerHTML = app.data.harvest.slice(0,5).map(l => `<div class="text-[10px] p-2 bg-slate-50 rounded mb-1 border flex justify-between"><span>${l.area}</span><span>${l.total} kg</span></div>`).join('');
                
                // 4. APPROVAL
                const pending = app.data.hr.filter(r => r.status === 'pending');
                document.getElementById('approval-list').innerHTML = pending.length ? pending.map(r => `<div class="p-2 bg-slate-50 border rounded mb-2 text-xs"><p class="font-bold">${r.type} - ${r.requester}</p><p>${r.content}</p><div class="flex gap-2 mt-1"><button onclick="app.actions.approve('${r._id}','approved')" class="text-green-600 font-bold">Duyệt</button><button onclick="app.actions.approve('${r._id}','rejected')" class="text-red-600 font-bold">Hủy</button></div></div>`).join('') : 'Trống';
            },

            renderTeam: () => {
                 const today = new Date().toISOString().split('T')[0];
                 document.getElementById('team-list').innerHTML = app.data.employees.map(e => `
                    <div class="card flex justify-between items-center !p-3 !mb-2 border-l-4 ${e.lastLogin===today?'border-green-500':'border-slate-200'}">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-xs">${e.name.charAt(0)}</div><p class="text-xs font-bold text-slate-700">${e.name}</p></div>
                        ${e.lastLogin===today ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                    </div>`).join('');
            },

            renderChat: () => {
                document.getElementById('chat-box').innerHTML = app.data.chat.map(m => `<div class="chat-bubble ${m.senderId === app.user.id ? 'chat-me' : 'chat-other'}"><p class="text-[9px] opacity-50 mb-1">${m.senderName}</p>${m.text}</div>`).join('');
            },

            renderAdmin: () => {
                const sopList = document.getElementById('sop-list');
                const indZone = document.getElementById('assign-ind-zone');
                if(sopList.innerHTML === "") sopList.innerHTML = (app.data.sop||[]).map(s => `<option value="${s.title}">`).join('');
                if(indZone.innerHTML === "") indZone.innerHTML = app.data.employees.map(e => `<label class="flex items-center gap-2 p-2"><input type="checkbox" name="u-check" value="${e.id}"> <span class="text-xs font-bold">${e.name}</span></label>`).join('');
            },

            // LOGIC FUNCTIONS
            calcTH: () => {
                const ids = ['th-b2','th-a1','th-a2','th-b1','th-d1','th-ht','th-abf','th-b2f','th-b1f'];
                let sum = 0; let html = '';
                ids.forEach(id => sum += Number(document.getElementById(id).value)||0);
                if(sum>0) ids.forEach(id => { const v=Number(document.getElementById(id).value)||0; if(v>0) html+=`<div class="stat-badge">${id.replace('th-','').toUpperCase()}: ${((v/sum)*100).toFixed(0)}%</div>`; });
                document.getElementById('th-total-display').innerText = sum + ' kg';
                document.getElementById('th-percent-display').innerHTML = html;
            },

            setSXMode: (m) => {
                document.getElementById('sx-action').value = m;
                document.getElementById('btn-sx-nhap').className = m==='NHẬP' ? 'flex-1 py-2 rounded font-bold bg-blue-600 text-white' : 'flex-1 py-2 rounded font-bold text-slate-400';
                document.getElementById('btn-sx-xuat').className = m==='XUẤT' ? 'flex-1 py-2 rounded font-bold bg-orange-500 text-white' : 'flex-1 py-2 rounded font-bold text-slate-400';
            },

            toggleAssign: () => {
                const m = document.getElementById('assign-mode').value;
                document.getElementById('assign-ind-zone').classList.toggle('hidden', m !== 'ind');
                document.getElementById('assign-team-zone').classList.toggle('hidden', m !== 'team');
            },

            actions: {
                seedAdmin: async () => { if(confirm("Tạo Admin?")) { await addDoc(collection(db, `${ROOT}/employees`), { id: 9999, name: "Admin", pin: "9999", role: "Giám đốc", score: 100 }); location.reload(); } },
                logout: () => { localStorage.removeItem('n5_v90_1_user'); location.reload(); },
                
                // Tasks
                createTask: async () => {
                    const title = document.getElementById('task-title').value;
                    const houses = Array.from(document.querySelectorAll('input[name="h-check"]:checked')).map(i => i.value);
                    const uids = Array.from(document.querySelectorAll('input[name="u-check"]:checked')).map(i => i.value);
                    if(!title || houses.length === 0 || uids.length === 0) return alert("Thiếu thông tin!");
                    for(let h of houses) { for(let u of uids) { await addDoc(collection(db, `${ROOT}/tasks`), { title, houseId: h, assignee: u, status: 'pending', time: Date.now() }); } }
                    alert("Đã giao!");
                },
                startTask: async (id) => updateDoc(doc(db, `${ROOT}/tasks`, id), { status: 'in_progress', startTime: Date.now() }),
                delTask: async (id) => { if(confirm("Xóa?")) deleteDoc(doc(db, `${ROOT}/tasks`, id)); },
                
                openReport: (id, title) => { document.getElementById('report-task-id').value = id; document.getElementById('report-title').innerText = title; app.ui.toggleModal('report-modal'); },
                submitReport: async (status) => {
                    const id = document.getElementById('report-task-id').value;
                    await updateDoc(doc(db, `${ROOT}/tasks`, id), { status, actual: document.getElementById('report-val').value, finishTime: Date.now() });
                    app.ui.toggleModal('report-modal');
                },

                // Forms
                submitSX: async () => {
                    const d = { action: document.getElementById('sx-action').value, date: document.getElementById('sx-date').value, type: document.getElementById('sx-type').value, qty: Number(document.getElementById('sx-qty').value), batch: document.getElementById('sx-batch').value, dest: document.getElementById('sx-dest').value, bad: Number(document.getElementById('sx-bad').value), reuse: Number(document.getElementById('sx-reuse').value), user: app.user.name, time: Date.now() };
                    await addDoc(collection(db, `${ROOT}/production_logs`), d); alert("Đã lưu!");
                },
                submitTH: async () => {
                    const details = {}; ['b2','a1','a2','b1','d1','ht','abf','b2f','b1f'].forEach(f => details[f] = Number(document.getElementById('th-'+f).value)||0);
                    const total = Object.values(details).reduce((a,b)=>a+b,0);
                    await addDoc(collection(db, `${ROOT}/harvest_logs`), { area: document.getElementById('th-area').value, details, total, user: app.user.name, time: Date.now(), note_err: document.getElementById('th-note-err').value, note_snack: document.getElementById('th-note-snack').value, xuat_say: document.getElementById('th-xuat-say').value, snack_tp: document.getElementById('th-snack-tp').value }); alert("Đã lưu!");
                },
                
                // Utils
                sendChat: async () => { const i = document.getElementById('chat-input'); if(!i.value) return; await addDoc(collection(db, `${ROOT}/chat`), { text: i.value, senderId: app.user.id, senderName: app.user.name, time: Date.now() }); i.value = ''; },
                checkIn: async (shift) => { const today = new Date().toISOString().split('T')[0]; await addDoc(collection(db, `${ROOT}/attendance_logs`), { uid: app.user.id, name: app.user.name, shift, date: today }); await updateDoc(doc(db, `${ROOT}/employees`, app.user._id), { lastLogin: today }); alert("Đã điểm danh!"); },
                submitHR: async (type) => { await addDoc(collection(db, `${ROOT}/hr_requests`), { type, requester: app.user.name, status: 'pending', content: type==='LEAVE' ? document.getElementById('leave-date').value : document.getElementById('buy-item').value }); alert("Đã gửi!"); },
                approve: async (id, status) => { await updateDoc(doc(db, `${ROOT}/hr_requests`, id), { status }); alert("Đã xử lý!"); },
                
                openTemp: (id, name) => { document.getElementById('temp-id').value = id; document.getElementById('temp-name').innerText = name; app.ui.toggleModal('modal-temp'); },
                saveTemp: async () => { const id = document.getElementById('temp-id').value; await updateDoc(doc(db, `${ROOT}/houses`, id), { 'temp.am': document.getElementById('temp-am').value, 'temp.pm': document.getElementById('temp-pm').value }); alert("Đã lưu!"); app.ui.toggleModal('modal-temp'); },
                
                addEmployee: async () => { await addDoc(collection(db, `${ROOT}/employees`), { id: Number(document.getElementById('new-emp-id').value), name: document.getElementById('new-emp-name').value, pin: document.getElementById('new-emp-pin').value, role: 'Nhân viên', score: 100 }); alert("Đã thêm!"); },
                addSOP: async () => { await addDoc(collection(db, `${ROOT}/sop`), { title: document.getElementById('new-sop-name').value, sop: Number(document.getElementById('new-sop-val').value) }); alert("Đã thêm!"); },
                addHouse: async () => { const name = prompt("Nhập tên nhà:"); if(name) await addDoc(collection(db, `${ROOT}/houses`), { name, temp: {am:0, pm:0} }); },
                fillSOP: () => { const val = document.getElementById('task-title').value; const item = (app.data.sop||[]).find(s => s.title === val); if(item) document.getElementById('task-target').value = item.sop; },
                
                exportSX: () => alert("Export SX..."),
                exportTH: () => alert("Export TH..."),
                exportAll: () => alert("Export All..."),
            }
        };
        
        window.onload = app.init;
    </script>
</body>
</html>
