<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>N·∫•m √îng 5 V78 - UI Perfect</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { 
            --blue: #2563eb; 
            --header-h: 100px; 
            --nav-h: 80px; 
            --bg: #f1f5f9;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #334155; margin: 0; height: 100vh; overflow: hidden; touch-action: manipulation; }
        
        /* Layout */
        #app-header { height: var(--header-h); background: white; border-bottom: 1px solid #e2e8f0; position: fixed; top: 0; width: 100%; z-index: 50; padding-top: env(safe-area-inset-top); display: flex; align-items: center; justify-content: space-between; padding-left: 20px; padding-right: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        #app-main { margin-top: var(--header-h); height: calc(100vh - var(--header-h) - var(--nav-h)); overflow-y: auto; padding: 20px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        #app-nav { height: var(--nav-h); background: white; border-top: 1px solid #e2e8f0; position: fixed; bottom: 0; width: 100%; z-index: 50; display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02); }
        
        .hidden { display: none !important; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid #f1f5f9; }
        .nav-btn { color: #94a3b8; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; }
        .nav-active { color: var(--blue); transform: translateY(-2px); }
        .nav-active i { font-size: 20px; filter: drop-shadow(0 4px 6px rgba(37,99,235,0.3)); }
        
        /* Inputs & Buttons */
        .input-box { width: 100%; background: #f8fafc; border: 2px solid #e2e8f0; padding: 14px; border-radius: 16px; font-weight: 600; outline: none; transition: all 0.2s; font-size: 14px; }
        .input-box:focus { border-color: var(--blue); background: white; }
        .label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }
        .btn-primary { background: var(--blue); color: white; font-weight: 800; padding: 14px; border-radius: 16px; width: 100%; text-transform: uppercase; font-size: 12px; box-shadow: 0 4px 12px rgba(37,99,235,0.2); transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.98); }
        
        /* Login Overlay */
        #login-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        
        /* Chat */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 20px; margin-bottom: 10px; font-size: 14px; line-height: 1.5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chat-me { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-other { background: white; align-self: flex-start; border-bottom-left-radius: 4px; }

        /* Modal */
        .modal-wrap { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
        .modal-box { background: white; width: 100%; max-width: 440px; border-radius: 32px; padding: 28px; max-height: 90vh; overflow-y: auto; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-ok { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-wait { background: #eab308; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN (GI·ªÆ NGUY√äN CODE V77 - ƒê√É ·ªîN ƒê·ªäNH) -->
    <div id="login-overlay">
        <div class="w-24 h-24 bg-blue-600 rounded-[32px] flex items-center justify-center text-white text-5xl font-black mb-6 shadow-2xl shadow-blue-200">5</div>
        <h1 class="text-3xl font-black text-slate-800 mb-2">N·∫•m √îng 5</h1>
        <p id="login-status" class="text-xs font-bold text-slate-400 mb-10 flex items-center bg-white px-4 py-2 rounded-full shadow-sm">
            <span class="status-dot status-wait" id="status-dot"></span> <span id="status-text">ƒêang k·∫øt n·ªëi...</span>
        </p>
        
        <div class="w-full max-w-sm space-y-5">
            <select id="login-user" class="input-box text-center appearance-none" disabled><option>ƒêang t·∫£i d·ªØ li·ªáu...</option></select>
            <input type="password" id="login-pin" placeholder="Nh·∫≠p PIN x√°c th·ª±c" class="input-box text-center text-xl tracking-widest" disabled inputmode="numeric">
            <button id="login-btn" onclick="app.doLogin()" class="btn-primary opacity-50" disabled>ƒêƒÇNG NH·∫¨P</button>
            
            <button id="rescue-btn" onclick="app.actions.seedAdmin()" class="hidden w-full border-2 border-red-100 text-red-500 py-3 rounded-2xl font-bold text-xs mt-4">
                <i class="fas fa-shield-alt mr-2"></i> T·∫†O ADMIN KH·∫®N C·∫§P
            </button>
        </div>
        <button onclick="localStorage.clear(); location.reload()" class="mt-12 text-xs text-slate-300 font-bold underline">C√†i ƒë·∫∑t l·∫°i ·ª©ng d·ª•ng</button>
    </div>

    <!-- 2. HEADER -->
    <header id="app-header">
        <div class="flex items-center gap-4">
            <button id="back-chat-btn" onclick="app.ui.tab('home')" class="hidden w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-500 active:bg-slate-200"><i class="fas fa-arrow-left"></i></button>
            <div>
                <h1 class="text-sm font-black uppercase text-slate-800 tracking-wide">N·∫•m √îng 5</h1>
                <p class="text-[9px] text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded-md inline-block mt-1">‚óè V78 Final</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right">
                <p id="head-user" class="font-bold text-xs text-slate-800">...</p>
                <p id="head-role" class="text-[9px] text-slate-400 font-bold uppercase">...</p>
            </div>
            <button id="admin-cog" onclick="app.ui.showModal('settings-modal')" class="hidden w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center border border-slate-200 text-slate-400 active:scale-90 transition"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <!-- 3. MAIN CONTENT -->
    <main id="app-main" class="no-scrollbar">
        
        <!-- VIEW: HOME -->
        <div id="view-home" class="view-section space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="card border-l-4 border-blue-500 !mb-0">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Nh√¢n s·ª± Online</p>
                    <p class="text-3xl font-black text-slate-800 mt-1" id="stat-online">0</p>
                </div>
                <div class="card border-l-4 border-green-500 !mb-0">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">T·ªïng h√°i (Kg)</p>
                    <p class="text-3xl font-black text-slate-800 mt-1" id="stat-yield">0</p>
                </div>
            </div>

            <!-- B·∫£ng V√†ng -->
             <div class="card !p-5 border border-yellow-100">
                <h3 class="text-xs font-black text-yellow-600 uppercase mb-4 flex items-center gap-2"><i class="fas fa-trophy"></i> B·∫£ng V√†ng Thi ƒêua</h3>
                <div id="leaderboard" class="space-y-3"></div>
            </div>
            
            <div class="flex justify-between items-center px-2">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Tr·∫°ng th√°i nh√† n·∫•m</h3>
                <button onclick="app.actions.addHouse()" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 hover:bg-blue-100">+ Th√™m nh√†</button>
            </div>
            <div id="house-list" class="space-y-3 pb-8"></div>
        </div>

        <!-- VIEW: VI·ªÜC (TASKS) -->
        <div id="view-tasks" class="view-section hidden space-y-5">
            <!-- Form Giao Vi·ªác -->
            <div id="admin-task-form" class="hidden card border-2 border-blue-50 !mb-0">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs font-black text-blue-600 uppercase flex items-center gap-2"><i class="fas fa-plus-circle"></i> Giao vi·ªác m·ªõi</span>
                    <select id="assign-mode" onchange="app.toggleAssignMode()" class="text-[10px] font-bold bg-slate-100 p-1.5 rounded-lg outline-none"><option value="ind">C√° nh√¢n</option><option value="team">Theo T·ªï</option></select>
                </div>
                <div class="space-y-3">
                    <input type="text" id="task-title" placeholder="T√™n c√¥ng vi·ªác (Vd: T∆∞·ªõi n·∫•m)..." list="sop-list" class="input-box bg-white" onchange="app.fillSop()">
                    <datalist id="sop-list"></datalist>
                    
                    <div>
                        <p class="label">Ch·ªçn Nh√† (ƒêa ch·ªçn)</p>
                        <div id="house-select-container" class="grid grid-cols-3 gap-2 bg-slate-50 p-2 rounded-xl border border-slate-200 max-h-32 overflow-y-auto"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div><p class="label">ƒê·ªãnh m·ª©c</p><input type="number" id="task-target" class="input-box bg-white text-center"></div>
                        <div id="assign-team-zone" class="hidden bg-slate-50 p-2 rounded-xl border border-slate-200 flex flex-col justify-center">
                            <label class="flex items-center gap-2 text-[10px] font-bold mb-1"><input type="radio" name="team-radio" value="T·ªï S·∫£n Xu·∫•t" checked> T·ªï SX</label>
                            <label class="flex items-center gap-2 text-[10px] font-bold"><input type="radio" name="team-radio" value="T·ªï Thu Ho·∫°ch"> T·ªï TH</label>
                        </div>
                    </div>

                    <div id="assign-ind-zone" class="bg-slate-50 p-3 rounded-xl border border-slate-200 max-h-40 overflow-y-auto space-y-2"></div>
                    
                    <button onclick="app.createTask()" class="btn-primary">Ban h√†nh l·ªánh</button>
                </div>
            </div>
            
            <div id="task-list" class="space-y-4 pb-20"></div>
        </div>

        <!-- VIEW: S·∫¢N XU·∫§T -->
        <div id="view-sx" class="view-section hidden space-y-5">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-lg font-black text-slate-800">Nh·∫≠t K√Ω SX</h2>
                <button onclick="app.actions.exportSX()" class="text-[10px] font-bold bg-white text-blue-600 px-3 py-2 rounded-xl border border-blue-100 shadow-sm"><i class="fas fa-download mr-1"></i> Excel</button>
            </div>
            
            <div class="card border-2 border-blue-50">
                <div class="flex bg-slate-100 p-1 rounded-xl mb-4">
                    <button onclick="app.setSXMode('NH·∫¨P')" id="btn-sx-nhap" class="flex-1 py-3 rounded-lg text-xs font-black bg-blue-600 text-white shadow-md transition">NH·∫¨P KHO</button>
                    <button onclick="app.setSXMode('XU·∫§T')" id="btn-sx-xuat" class="flex-1 py-3 rounded-lg text-xs font-black text-slate-400 hover:bg-white transition">XU·∫§T KHO</button>
                </div>
                <input type="hidden" id="sx-action" value="NH·∫¨P">
                
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div><p class="label">Ng√†y</p><input type="date" id="sx-date" class="input-box bg-white"></div>
                        <div><p class="label">L√¥ c·∫•y</p><input type="text" id="sx-batch" placeholder="Vd: 27.11" class="input-box bg-white text-center"></div>
                    </div>
                    <div><p class="label">Lo·∫°i Ph√¥i</p><input type="text" id="sx-type" list="phoi-list" class="input-box bg-white" placeholder="Ch·ªçn lo·∫°i..."></div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><p class="label">S·ªë l∆∞·ª£ng</p><input type="number" id="sx-qty" class="input-box bg-white text-center font-bold text-lg"></div>
                        <div><p class="label text-red-500">S·ªë H·ªßy</p><input type="number" id="sx-bad" placeholder="0" class="input-box bg-white text-center"></div>
                        <div><p class="label text-green-600">T·∫≠n d·ª•ng</p><input type="number" id="sx-reuse" placeholder="0" class="input-box bg-white text-center"></div>
                    </div>
                    <div><p class="label">N∆°i Nh·∫≠p/Xu·∫•t</p><input type="text" id="sx-dest" placeholder="Nh√† A, Kho B..." class="input-box bg-white"></div>
                    <button onclick="app.submitSX()" class="btn-primary mt-2">L∆ØU D·ªÆ LI·ªÜU</button>
                </div>
            </div>
            <div id="sx-log-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- VIEW: THU HO·∫†CH -->
        <div id="view-th" class="view-section hidden space-y-5">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-lg font-black text-slate-800">T·ªï Thu Ho·∫°ch</h2>
                <button onclick="app.actions.exportTH()" class="text-[10px] font-bold bg-white text-green-600 px-3 py-2 rounded-xl border border-green-100 shadow-sm"><i class="fas fa-download mr-1"></i> Excel</button>
            </div>

            <div class="card border-2 border-green-50">
                <h3 class="text-[10px] font-black text-green-600 uppercase mb-4 border-b pb-2 flex justify-between"><span>Nh·∫≠p s·∫£n l∆∞·ª£ng (KG)</span> <span>% T·ª∑ l·ªá</span></h3>
                <div class="space-y-4">
                    <div><p class="label">Khu v·ª±c / Nh√†</p><select id="th-area" class="input-box bg-white font-bold text-green-700"></select></div>
                    
                    <div class="bg-slate-50 p-3 rounded-2xl border border-slate-200">
                        <div class="grid grid-cols-4 gap-2 mb-2 items-end">
                            <div><label class="text-center text-[10px] font-bold block mb-1">B2</label><input type="number" id="th-b2" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                            <div><label class="text-center text-[10px] font-bold block mb-1">A1</label><input type="number" id="th-a1" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                            <div><label class="text-center text-[10px] font-bold block mb-1">A2</label><input type="number" id="th-a2" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                            <div><label class="text-center text-[10px] font-bold block mb-1">B1</label><input type="number" id="th-b1" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                        </div>
                        <div class="grid grid-cols-5 gap-2 items-end">
                            <div><label class="text-center text-[10px] font-bold block mb-1">D1</label><input type="number" id="th-d1" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">H.Th·ªß</label><input type="number" id="th-ht" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">AB-F</label><input type="number" id="th-abf" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">B2-F</label><input type="number" id="th-b2f" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                            <div><label class="text-center text-[9px] font-bold block mb-1">B1-F</label><input type="number" id="th-b1f" class="input-box p-2 text-center h-10 text-sm" oninput="app.calcTH()"></div>
                        </div>
                        <div id="th-percent-display" class="grid grid-cols-4 gap-2 mt-3 pt-3 border-t border-slate-200"></div>
                    </div>
                    
                    <div class="flex justify-between items-center bg-green-50 p-4 rounded-2xl border border-green-100">
                        <span class="font-bold text-green-800 text-xs">T·ªîNG H√ÅI:</span>
                        <span id="th-total-display" class="font-black text-2xl text-green-600">0 kg</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                         <div><p class="label text-red-500">H√†ng l·ªói (kg)</p><input type="number" id="th-note-err" class="input-box bg-white text-center" placeholder="0"></div>
                         <div><p class="label text-orange-500">Xu·∫•t Snack</p><input type="number" id="th-note-snack" class="input-box bg-white text-center" placeholder="0"></div>
                    </div>
                    <div><p class="label">Ghi ch√∫ th√™m</p><input type="text" id="th-note" class="input-box bg-white" placeholder="..."></div>
                    
                    <button onclick="app.actions.submitTH()" class="btn-primary bg-green-600 mt-2">C·∫¨P NH·∫¨T KHO</button>
                </div>
            </div>
            <div id="th-log-list" class="space-y-3 pb-20"></div>
        </div>

        <!-- VIEW: TEAM -->
        <div id="view-team" class="view-section hidden space-y-4">
             <div class="card border border-blue-100">
                <p class="label mb-3">ƒêI·ªÇM DANH C√Å NH√ÇN</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.checkIn('S√°ng')" class="bg-yellow-50 text-yellow-700 py-4 rounded-xl font-bold text-xs border border-yellow-200 hover:bg-yellow-100">‚òÄÔ∏è CA S√ÅNG</button>
                    <button onclick="app.checkIn('Chi·ªÅu')" class="bg-indigo-50 text-indigo-700 py-4 rounded-xl font-bold text-xs border border-indigo-200 hover:bg-indigo-100">üåô CA CHI·ªÄU</button>
                </div>
             </div>
             <div id="team-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- VIEW: CHAT -->
        <div id="view-chat" class="view-section hidden flex flex-col h-full bg-[#e5ddd5] absolute top-0 left-0 w-full z-[100]">
            <!-- Custom Chat Header -->
            <div class="h-[100px] bg-white border-b flex items-end px-4 pb-4">
                 <button onclick="app.ui.tab('home')" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center mr-3"><i class="fas fa-arrow-left text-slate-600"></i></button>
                 <div><h2 class="font-bold text-slate-800">Th·∫£o lu·∫≠n chung</h2><p class="text-[10px] text-green-600 font-bold">‚óè Tr·ª±c tuy·∫øn</p></div>
            </div>
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 pb-24"></div>
            <div class="bg-white border-t p-3 flex gap-2 fixed bottom-0 w-full z-50 pb-8 safe-area-bot">
                <input id="chat-input" type="text" class="flex-1 bg-slate-100 rounded-full px-5 py-3 text-sm outline-none" placeholder="Nh·∫≠p tin nh·∫Øn...">
                <button onclick="app.sendChat()" class="w-12 h-12 bg-blue-600 rounded-full text-white flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

    <!-- 4. NAVIGATION -->
    <nav id="app-nav">
        <button onclick="app.ui.tab('home')" class="nav-btn nav-active"><i class="fas fa-home text-xl"></i><span>HOME</span></button>
        <button onclick="app.ui.tab('tasks')" class="nav-btn"><i class="fas fa-clipboard-list text-xl"></i><span>VI·ªÜC</span></button>
        <button onclick="app.ui.tab('sx')" class="nav-btn"><i class="fas fa-industry text-xl"></i><span>SX</span></button>
        <button onclick="app.ui.tab('th')" class="nav-btn"><i class="fas fa-box-open text-xl"></i><span>TH</span></button>
        <button onclick="app.ui.tab('team')" class="nav-btn"><i class="fas fa-users text-xl"></i><span>TEAM</span></button>
        <button onclick="app.ui.tab('chat')" class="nav-btn"><i class="fas fa-comments text-xl"></i><span>CHAT</span></button>
    </nav>

    <!-- 5. MODALS -->
    <div id="settings-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.hideModal('settings-modal')">
        <div class="modal-box">
            <h3 class="font-black text-xl mb-6">C√†i ƒë·∫∑t</h3>
            <div class="space-y-4">
                <button onclick="app.exportAll()" class="w-full bg-white text-blue-700 py-4 rounded-xl font-bold text-xs border border-blue-200 shadow-sm flex items-center justify-center gap-2"><i class="fas fa-file-export"></i> XU·∫§T NH·∫¨T K√ù NG√ÄY</button>
                
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <p class="label mb-2">H√†nh ch√≠nh</p>
                    <button onclick="app.showModal('modal-leave')" class="w-full text-left text-xs font-bold p-3 bg-white rounded-xl mb-2 flex justify-between"><span>Xin ngh·ªâ ph√©p</span> <i class="fas fa-chevron-right text-slate-300"></i></button>
                    <button onclick="app.showModal('modal-buy')" class="w-full text-left text-xs font-bold p-3 bg-white rounded-xl flex justify-between"><span>ƒê·ªÅ xu·∫•t mua h√†ng</span> <i class="fas fa-chevron-right text-slate-300"></i></button>
                </div>

                <div id="admin-tools" class="hidden space-y-4 border-t pt-4">
                    <p class="label">Qu·∫£n tr·ªã vi√™n</p>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3">
                         <div class="flex gap-2">
                             <input id="new-emp-name" placeholder="T√™n NV" class="input-box text-xs">
                             <input id="new-emp-pin" placeholder="PIN" class="input-box text-xs w-20 text-center">
                         </div>
                         <button onclick="app.addEmployee()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-xs">Th√™m Nh√¢n S·ª±</button>
                    </div>
                    <button onclick="app.showModal('modal-approve')" class="w-full bg-green-100 text-green-700 py-3 rounded-xl font-bold text-xs">Duy·ªát ƒê∆°n T·ª´ (HR)</button>
                </div>
                
                <button onclick="app.logout()" class="w-full text-red-500 py-4 font-bold text-xs mt-4">ƒêƒÉng xu·∫•t t√†i kho·∫£n</button>
            </div>
        </div>
    </div>
    
    <!-- Report Task -->
    <div id="report-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.hideModal('report-modal')">
        <div class="modal-box">
            <h3 class="font-black text-lg text-center mb-2">B√°o c√°o k·∫øt qu·∫£</h3>
            <p id="report-title" class="text-center text-xs text-blue-600 font-bold mb-6">...</p>
            <input type="hidden" id="report-task-id">
            <div class="space-y-4">
                <input type="number" id="report-val" placeholder="S·ªë l∆∞·ª£ng ƒë·∫°t" class="w-full bg-slate-50 border-2 border-blue-200 p-4 rounded-2xl text-center text-3xl font-black outline-none">
                <input type="text" id="report-note" placeholder="Ghi ch√∫ th√™m..." class="input-box bg-white">
                <div class="text-center border-t border-dashed pt-4">
                     <label class="block w-full bg-blue-50 py-6 rounded-2xl cursor-pointer text-blue-500 font-bold text-xs"><i class="fas fa-camera text-2xl mb-2 block"></i>Ch·ª•p ·∫£nh minh ch·ª©ng<input type="file" accept="image/*" class="hidden" onchange="app.handlePhoto(this)"></label>
                     <img id="report-preview" class="hidden mt-3 rounded-xl max-h-40 mx-auto shadow-md">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.submitReport('completed')" class="bg-green-600 text-white py-4 rounded-2xl font-bold text-xs shadow-lg shadow-green-200">Ho√†n th√†nh</button>
                    <button onclick="app.submitReport('unfinished')" class="bg-orange-500 text-white py-4 rounded-2xl font-bold text-xs shadow-lg shadow-orange-200">Ch∆∞a xong</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="modal-temp" class="modal-wrap hidden" onclick="if(event.target===this) app.hideModal('modal-temp')"><div class="modal-box text-center"><h3 class="font-bold mb-6 text-xl">Nhi·ªát ƒë·ªô <span id="temp-name" class="text-orange-500"></span></h3><input type="hidden" id="temp-id"><div class="grid grid-cols-2 gap-4 mb-6"><div><label class="label text-center">S√°ng</label><input id="temp-am" type="number" class="input-box text-center text-2xl"></div><div><label class="label text-center">Chi·ªÅu</label><input id="temp-pm" type="number" class="input-box text-center text-2xl"></div></div><button onclick="app.saveTemp()" class="btn-primary bg-orange-500">L∆∞u</button></div></div>
    
    <div id="modal-leave" class="modal-wrap hidden" onclick="if(event.target===this) app.hideModal('modal-leave')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg">Xin ngh·ªâ ph√©p</h3><div class="space-y-3"><input id="leave-date" type="date" class="input-box"><select id="leave-reason" class="input-box"><option>·ªêm ƒëau</option><option>Vi·ªác ri√™ng</option><option>Ph√©p nƒÉm</option></select><input type="text" id="leave-note" placeholder="L√Ω do c·ª• th·ªÉ..." class="input-box"><button onclick="app.submitHR('LEAVE')" class="btn-primary">G·ª≠i ƒë∆°n</button></div></div></div>
    
    <div id="modal-purchase" class="modal-wrap hidden" onclick="if(event.target===this) app.hideModal('modal-purchase')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg">ƒê·ªÅ xu·∫•t mua h√†ng</h3><div class="space-y-3"><input type="text" id="pur-item" placeholder="T√™n h√†ng..." class="input-box"><div class="grid grid-cols-2 gap-3"><input type="number" id="pur-qty" placeholder="S·ªë l∆∞·ª£ng" class="input-box"><input type="text" id="pur-unit" placeholder="ƒê∆°n v·ªã" class="input-box"></div><input type="text" id="pur-note" placeholder="M·ª•c ƒë√≠ch..." class="input-box"><button onclick="app.actions.submitHR('PURCHASE')" class="btn-primary bg-green-600">G·ª≠i ƒë·ªÅ xu·∫•t</button></div></div></div>
    
    <div id="modal-approve" class="modal-wrap hidden" onclick="if(event.target===this) app.hideModal('modal-approve')"><div class="modal-box"><h3 class="font-bold mb-4 text-lg text-red-600">Duy·ªát ƒë∆°n t·ª´</h3><div id="approval-list" class="space-y-3"></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fbConfig = { apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", authDomain: "ong5mushroom-vietnam.firebaseapp.com", projectId: "ong5mushroom-vietnam", storageBucket: "ong5mushroom-vietnam.firebasestorage.app", messagingSenderId: "931399604992", appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" };
        const appInstance = initializeApp(fbConfig);
        const db = getFirestore(appInstance);
        const ROOT = "artifacts/namong5_production/public/data";

        window.app = {
            data: { employees: [], houses: [], chat: [], tasks: [], production: [], harvest: [], hr_requests: [] },
            user: JSON.parse(localStorage.getItem('n5_v78_user')) || null,
            assignMode: 'ind',
            currentPhoto: null,

            ui: {
                show: id => document.getElementById(id).classList.remove('hidden'),
                hide: id => document.getElementById(id).classList.add('hidden'),
                tab: id => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    document.getElementById('view-'+id).classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));
                    event.currentTarget?.classList.add('nav-active');
                    
                    // Chat UI logic
                    const nav = document.getElementById('app-nav');
                    const header = document.getElementById('app-header');
                    if(id === 'chat') {
                        nav.classList.add('hidden');
                        header.classList.add('hidden');
                        document.getElementById('view-chat').classList.remove('hidden');
                        setTimeout(() => document.getElementById('chat-box').scrollTop = 99999, 100);
                    } else {
                        nav.classList.remove('hidden');
                        header.classList.remove('hidden');
                        document.getElementById('view-chat').classList.add('hidden');
                    }
                },
                showModal: (id) => document.getElementById(id).classList.remove('hidden'),
                hideModal: (id) => document.getElementById(id).classList.add('hidden')
            },

            init: () => {
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                
                setTimeout(() => {
                    if (app.data.employees.length === 0) {
                        statusText.innerText = "Ch·∫≠m k·∫øt n·ªëi... (Th·ª≠ t·∫°o Admin)";
                        statusDot.classList.replace('status-wait', 'bg-red-500');
                        document.getElementById('rescue-btn').classList.remove('hidden');
                    }
                }, 5000);

                signInAnonymously(getAuth(appInstance)).then(() => {
                    statusDot.classList.replace('status-wait', 'status-ok');
                    statusText.innerText = "ƒê√£ k·∫øt n·ªëi";
                    app.sync();
                }).catch(e => {
                     statusDot.classList.replace('status-wait', 'bg-red-500');
                     statusText.innerText = "L·ªói m·∫°ng!";
                });
                
                document.getElementById('sx-date').valueAsDate = new Date();
            },

            sync: () => {
                const sub = (c, k) => onSnapshot(collection(db, `${ROOT}/${c}`), s => { 
                    app.data[k] = s.docs.map(d => ({...d.data(), _id: d.id})); 
                    app.renderDynamic();
                    if(c==='employees') app.renderLoginSelect();
                    if(c==='hr_requests') app.renderHR();
                });
                ['employees', 'houses', 'tasks', 'production_logs', 'harvest_logs', 'hr_requests'].forEach(x => sub(x, x.includes('logs') ? x.split('_')[0] : x));
                
                onSnapshot(query(collection(db, `${ROOT}/chat`), orderBy("time", "asc"), limit(50)), s => {
                    app.data.chat = s.docs.map(d => d.data());
                    if(app.user) app.renderChat();
                });
            },

            renderLoginSelect: () => {
                const s = document.getElementById('login-user');
                const btn = document.getElementById('login-btn');
                const pin = document.getElementById('login-pin');
                
                if (app.data.employees.length > 0) {
                    s.innerHTML = '<option value="">-- Ch·ªçn t√™n --</option>' + 
                        app.data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                    s.disabled = false; pin.disabled = false; btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    document.getElementById('status-text').innerText = "S·∫µn s√†ng";
                    document.getElementById('rescue-btn').classList.add('hidden');
                }
                
                if(app.user) {
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('app-body').classList.remove('hidden');
                    app.renderApp();
                }
            },

            doLogin: () => {
                const id = document.getElementById('login-user').value;
                const pin = document.getElementById('login-pin').value.trim();
                const emp = app.data.employees.find(e => String(e.id) === String(id) && String(e.pin).trim() === String(pin));
                
                if(emp) {
                    app.user = emp;
                    localStorage.setItem('n5_v78_user', JSON.stringify(emp));
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('app-body').classList.remove('hidden');
                    app.renderApp();
                } else alert("M√£ PIN kh√¥ng ƒë√∫ng!");
            },

            renderApp: () => {
                document.getElementById('head-user').innerText = app.user.name;
                document.getElementById('head-role').innerText = app.user.role;
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role);
                if(isAdmin) {
                    document.getElementById('admin-cog').classList.remove('hidden');
                    document.getElementById('admin-task-form').classList.remove('hidden');
                    document.getElementById('admin-tools').classList.remove('hidden');
                    app.renderAdmin();
                }
                app.renderDynamic();
            },
            
            renderDynamic: () => {
                const hSelect = document.getElementById('th-area');
                if(hSelect.innerHTML === "") {
                    const opts = app.data.houses.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
                    hSelect.innerHTML = opts;
                }
                
                const houseMulti = document.getElementById('house-select-container');
                if(houseMulti && houseMulti.innerHTML === "") {
                     houseMulti.innerHTML = app.data.houses.length > 0 ? 
                     app.data.houses.map(h => `<label class="flex items-center gap-2 text-xs p-1"><input type="checkbox" value="${h.name}" name="h-check" class="w-4 h-4 accent-blue-600"> ${h.name}</label>`).join('') :
                     '<button onclick="app.actions.addHouse()" class="col-span-3 text-[10px] text-blue-500 font-bold border border-blue-200 border-dashed p-2 rounded text-center">+ Th√™m Nh√† N·∫•m</button>';
                }

                // 1. STATS
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('stat-online').innerText = app.data.employees.filter(e => e.lastLogin === today).length;
                const yieldKg = app.data.harvest.filter(h => new Date(h.time).toDateString() === new Date().toDateString()).reduce((a,b) => a + (b.total||0), 0);
                document.getElementById('stat-yield').innerText = yieldKg.toLocaleString();
                
                // 2. HOUSE LIST
                document.getElementById('house-list').innerHTML = app.data.houses.map(h => `
                    <div class="card flex justify-between items-center !mb-3">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-blue-50 flex items-center justify-center font-black text-blue-600 text-sm">${h.name.substring(0,2)}</div>
                            <div><p class="font-bold text-sm text-slate-800">${h.name}</p><p class="text-[10px] text-slate-400 font-bold mt-1">S: ${h.temp?.am||'--'}¬∞ | C: ${h.temp?.pm||'--'}¬∞</p></div>
                        </div>
                        <button onclick="app.openTemp('${h._id}', '${h.name}')" class="w-10 h-10 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center active:scale-90 transition"><i class="fas fa-temperature-high"></i></button>
                    </div>
                `).join('');

                // 3. TASK LIST
                const isAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(app.user.role);
                let tasks = app.data.tasks.filter(t => t.status !== 'completed');
                if(!isAdmin) tasks = tasks.filter(t => t.assignee == app.user.id);
                
                const groups = {};
                tasks.forEach(t => { if(!groups[t.assignee]) groups[t.assignee] = []; groups[t.assignee].push(t); });
                
                document.getElementById('task-list').innerHTML = Object.keys(groups).map(uid => {
                    const name = app.data.employees.find(e => String(e.id) === String(uid))?.name || uid;
                    const items = groups[uid].map(t => {
                        const isStarted = t.status === 'in_progress';
                        return `
                        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl mb-3 border border-slate-100 last:mb-0">
                            <div><p class="font-bold text-xs text-slate-700 mb-1">${t.title} <span class="text-slate-400 font-normal">(${t.houseId})</span></p><p class="text-[9px] text-slate-400 font-bold">Giao: ${new Date(t.time).toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})}</p></div>
                            <div class="flex gap-2">
                                ${isAdmin ? `<button onclick="app.delTask('${t._id}')" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-trash-alt text-xs"></i></button>` : ''}
                                ${isStarted 
                                    ? `<button onclick="app.openReport('${t._id}', '${t.title}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg shadow-blue-200 active:scale-95 transition">B√ÅO C√ÅO</button>`
                                    : `<button onclick="app.startTask('${t._id}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg shadow-green-200 active:scale-95 transition animate-pulse">NH·∫¨N VI·ªÜC</button>`
                                }
                            </div>
                        </div>`;
                    }).join('');
                    return `<div class="card !p-5 border-l-4 border-blue-600"><div class="flex items-center gap-2 mb-4 pb-2 border-b border-slate-50"><i class="fas fa-user-circle text-slate-300 text-xl"></i><p class="text-xs font-black text-slate-700 uppercase">${name}</p></div>${items}</div>`;
                }).join('');
                
                // 4. SX & TH LOGS
                const sxLogs = app.data.production.sort((a,b) => b.time - a.time).slice(0, 5);
                document.getElementById('sx-log-list').innerHTML = sxLogs.map(l => `<div class="bg-white p-3 rounded-xl border border-slate-100 text-xs flex justify-between"><div><span class="font-black ${l.action==='NH·∫¨P'?'text-blue-600':'text-orange-500'}">${l.action}</span> ${l.type}</div><div class="font-black">${l.qty}</div></div>`).join('');
                const thLogs = app.data.harvest.sort((a,b) => b.time - a.time).slice(0, 5);
                document.getElementById('th-log-list').innerHTML = thLogs.map(l => `<div class="bg-white p-3 rounded-xl border border-slate-100 text-xs flex justify-between"><div><span class="font-black text-green-600">${l.area}</span> ${new Date(l.time).toLocaleDateString()}</div><div class="font-black">${l.total} kg</div></div>`).join('');
                
                // 5. TEAM & LEADERBOARD
                document.getElementById('team-list').innerHTML = app.data.employees.map(e => `
                    <div class="card flex justify-between items-center !p-4 !mb-2 border-l-4 ${e.lastLogin===today?'border-green-500':'border-slate-200'}">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-xs">${e.name.charAt(0)}</div><div><p class="text-xs font-bold text-slate-700">${e.name}</p><p class="text-[9px] text-slate-400 font-bold uppercase">${e.role}</p></div></div>
                        ${e.lastLogin===today ? '<span class="text-[9px] font-black text-green-600 bg-green-50 px-2 py-1 rounded">ONLINE</span>' : ''}
                    </div>`).join('');
                
                const top = [...app.data.employees].sort((a,b) => (b.score||0) - (a.score||0)).slice(0, 3);
                document.getElementById('leaderboard').innerHTML = top.map((p, i) => `<div class="flex justify-between items-center bg-yellow-50 p-3 rounded-xl border border-yellow-100"><div class="flex items-center gap-3"><span class="font-black text-xs text-yellow-600">#${i+1}</span><span class="text-xs font-bold text-slate-700">${p.name}</span></div><span class="font-black text-yellow-600 text-xs">${p.score || 0}ƒë</span></div>`).join('');
                
                // 6. HR REQUESTS (Admin Only)
                if(isAdmin) {
                    const pendingHR = app.data.hr_requests.filter(r => r.status === 'pending');
                    document.getElementById('approval-list').innerHTML = pendingHR.length ? pendingHR.map(r => `
                        <div class="p-3 bg-slate-50 border rounded-xl mb-2 text-xs">
                            <div class="flex justify-between mb-1"><span class="font-bold text-blue-600">${r.type}</span><span class="text-slate-400">${r.requester}</span></div>
                            <p class="mb-3 font-medium text-slate-700">${r.content}</p>
                            <div class="flex gap-2"><button onclick="app.approve('${r._id}', 'approved')" class="flex-1 bg-green-100 text-green-700 py-2 rounded-lg font-bold">Duy·ªát</button><button onclick="app.approve('${r._id}', 'rejected')" class="flex-1 bg-red-50 text-red-600 py-2 rounded-lg font-bold">T·ª´ ch·ªëi</button></div>
                        </div>
                    `).join('') : '<p class="text-center text-xs text-slate-400 py-2">Kh√¥ng c√≥ y√™u c·∫ßu n√†o</p>';
                }
            },
            
            renderChat: () => {
                const box = document.getElementById('chat-box');
                box.innerHTML = app.data.chat.map(m => `
                    <div class="chat-bubble ${m.senderId === app.user.id ? 'chat-me' : 'chat-other'}">
                        <p class="text-[9px] font-bold opacity-40 mb-1 uppercase">${m.senderName}</p>${m.text}
                    </div>
                `).join('');
                box.scrollTop = 99999;
            },

            renderAdmin: () => {
                const sopList = document.getElementById('sop-list');
                const indZone = document.getElementById('assign-ind-zone');
                if(sopList.innerHTML === "") sopList.innerHTML = (app.data.sop||[]).map(s => `<option value="${s.title}">`).join('');
                if(indZone.innerHTML === "") indZone.innerHTML = app.data.employees.map(e => `<label class="flex items-center gap-3 p-2 bg-white rounded-xl border border-slate-100"><input type="checkbox" name="u-check" value="${e.id}" class="w-4 h-4 accent-blue-600"> <span class="text-xs font-bold text-slate-700">${e.name}</span></label>`).join('');
            },

            // ACTIONS
            seedAdmin: async () => {
                if(confirm("T·∫°o Admin kh·∫©n c·∫•p? (ID: 9999, PIN: 9999)")) {
                    await addDoc(collection(db, `${ROOT}/employees`), { id: 9999, name: "Admin C·ª©u H·ªô", pin: "9999", role: "Gi√°m ƒë·ªëc", score: 100 });
                    location.reload();
                }
            },
            
            logout: () => { localStorage.removeItem('n5_v78_user'); location.reload(); },
            
            createTask: async () => {
                const title = document.getElementById('task-title').value;
                const houses = Array.from(document.querySelectorAll('input[name="h-check"]:checked')).map(i => i.value);
                const uids = Array.from(document.querySelectorAll('input[name="u-check"]:checked')).map(i => i.value);
                
                if(!title || houses.length === 0 || uids.length === 0) return alert("Thi·∫øu th√¥ng tin!");
                
                for(let h of houses) {
                    for(let u of uids) {
                        await addDoc(collection(db, `${ROOT}/tasks`), { title, houseId: h, assignee: u, status: 'pending', time: Date.now() });
                    }
                }
                alert("ƒê√£ giao vi·ªác!");
            },
            
            startTask: async (id) => updateDoc(doc(db, `${ROOT}/tasks`, id), { status: 'in_progress', startTime: Date.now() }),
            delTask: async (id) => { if(confirm("X√≥a?")) deleteDoc(doc(db, `${ROOT}/tasks`, id)); },
            
            openReport: (id, title) => {
                document.getElementById('report-task-id').value = id;
                document.getElementById('report-title').innerText = title;
                app.ui.showModal('report-modal');
            },
            
            submitReport: async (status) => {
                const id = document.getElementById('report-task-id').value;
                const val = document.getElementById('report-val').value;
                const note = document.getElementById('report-note').value;
                const task = app.data.tasks.find(t => t._id === id);
                
                await updateDoc(doc(db, `${ROOT}/tasks`, id), { 
                    status: 'completed', actual: val, note: note, photo: app.photo, 
                    finishTime: Date.now(), 
                    duration: task.startTime ? ((Date.now() - task.startTime)/60000).toFixed(0) + " ph√∫t" : "N/A"
                });
                
                if(status === 'completed') {
                     const emp = app.data.employees.find(e => e.id == task.assignee);
                     if(emp) await updateDoc(doc(db, `${ROOT}/employees`, emp._id), { score: (emp.score || 0) + 10 });
                }
                app.ui.hideModal('report-modal');
            },

            handlePhoto: (input) => {
                const r = new FileReader();
                r.onload = e => { 
                    app.photo = e.target.result; 
                    document.getElementById('report-preview').src = e.target.result; 
                    document.getElementById('report-preview').classList.remove('hidden'); 
                };
                r.readAsDataURL(input.files[0]);
            },

            // SX & TH & HR Actions
            setSXMode: (m) => {
                document.getElementById('sx-action').value = m;
                document.getElementById('btn-sx-nhap').className = m==='NH·∫¨P' ? 'flex-1 py-3 rounded-lg text-xs font-black bg-blue-600 text-white shadow-md transition' : 'flex-1 py-3 rounded-lg text-xs font-black text-slate-400 hover:bg-white transition';
                document.getElementById('btn-sx-xuat').className = m==='XU·∫§T' ? 'flex-1 py-3 rounded-lg text-xs font-black bg-orange-500 text-white shadow-md transition' : 'flex-1 py-3 rounded-lg text-xs font-black text-slate-400 hover:bg-white transition';
            },
            
            submitSX: async () => {
                const d = {
                    action: document.getElementById('sx-action').value,
                    date: document.getElementById('sx-date').value,
                    type: document.getElementById('sx-type').value,
                    qty: Number(document.getElementById('sx-qty').value),
                    batch: document.getElementById('sx-batch').value,
                    dest: document.getElementById('sx-dest').value,
                    bad: Number(document.getElementById('sx-bad').value),
                    reuse: Number(document.getElementById('sx-reuse').value),
                    user: app.user.name, time: Date.now()
                };
                await addDoc(collection(db, `${ROOT}/production_logs`), d);
                alert("ƒê√£ l∆∞u!");
            },
            
            calcTH: () => {
                const fields = ['b2','a1','a2','b1','d1','ht','abf','b2f','b1f'];
                let sum = 0;
                let html = '';
                fields.forEach(f => sum += Number(document.getElementById('th-'+f).value) || 0);
                document.getElementById('th-total-display').innerText = sum + " kg";
                
                if(sum > 0) fields.forEach(f => {
                    const v = Number(document.getElementById('th-'+f).value) || 0;
                    if(v > 0) html += `<div class="stat-badge">${f.toUpperCase()}: ${((v/sum)*100).toFixed(0)}%</div>`;
                });
                document.getElementById('th-percent-display').innerHTML = html;
            },
            
            submitTH: async () => {
                const details = {};
                ['b2','a1','a2','b1','d1','ht','abf','b2f','b1f'].forEach(f => details[f] = Number(document.getElementById('th-'+f).value)||0);
                const total = Object.values(details).reduce((a,b)=>a+b,0);
                await addDoc(collection(db, `${ROOT}/harvest_logs`), {
                    area: document.getElementById('th-area').value,
                    details, total, note: document.getElementById('th-note').value,
                    note_err: document.getElementById('th-note-err').value,
                    note_snack: document.getElementById('th-note-snack').value,
                    user: app.user.name, time: Date.now()
                });
                alert("ƒê√£ l∆∞u!");
            },

            sendChat: async () => {
                const i = document.getElementById('chat-input');
                if(!i.value) return;
                await addDoc(collection(db, `${ROOT}/chat`), { text: i.value, senderId: app.user.id, senderName: app.user.name, time: Date.now() });
                i.value = '';
            },

            checkIn: async (shift) => {
                const today = new Date().toISOString().split('T')[0];
                await addDoc(collection(db, `${ROOT}/attendance_logs`), { uid: app.user.id, name: app.user.name, shift, date: today, time: Date.now() });
                await updateDoc(doc(db, `${ROOT}/employees`, app.user._id), { lastLogin: today });
                alert("ƒê√£ ƒëi·ªÉm danh " + shift);
            },
            
            submitHR: async (type) => {
                const content = type === 'LEAVE' 
                    ? `Ngh·ªâ: ${document.getElementById('leave-date').value} (${document.getElementById('leave-reason').value})`
                    : `Mua: ${document.getElementById('buy-qty').value} ${document.getElementById('buy-item').value}`;
                await addDoc(collection(db, `${ROOT}/hr_requests`), { type, content, requester: app.user.name, uid: app.user.id, status: 'pending', time: Date.now() });
                app.ui.hideModal(type === 'LEAVE' ? 'modal-leave' : 'modal-buy');
                alert("ƒê√£ g·ª≠i!");
            },
            
            approve: async (id, status) => {
                await updateDoc(doc(db, `${ROOT}/hr_requests`, id), { status });
                alert("ƒê√£ x·ª≠ l√Ω!");
            },
            
            openTemp: (id, name) => {
                 const h = app.data.houses.find(x => x._id == id);
                 document.getElementById('temp-id').value = id;
                 document.getElementById('temp-name').innerText = name;
                 document.getElementById('temp-am').value = h.temp?.am || "";
                 document.getElementById('temp-pm').value = h.temp?.pm || "";
                 app.ui.showModal('modal-temp');
            },
            
            saveTemp: async () => {
                const id = document.getElementById('temp-id').value;
                await updateDoc(doc(db, `${ROOT}/houses`, id), { 
                    'temp.am': document.getElementById('temp-am').value,
                    'temp.pm': document.getElementById('temp-pm').value
                });
                app.ui.hideModal('modal-temp');
            },
            
            exportAll: () => {
                const now = new Date();
                let csv = "NGAY;GIO;NHAN VIEN;VIEC;NHA;KET QUA;THOI GIAN\n";
                app.data.tasks.filter(t => t.status === 'completed').forEach(t => {
                     const time = new Date(t.finishTime).toLocaleTimeString();
                     const emp = app.data.employees.find(e => e.id == t.assignee)?.name || t.assignee;
                     csv += `${new Date(t.finishTime).toLocaleDateString()};${time};"${emp}";"${t.title}";"${t.houseId}";${t.actual};"${t.duration}"\n`;
                });
                app.actions.downloadCSV(csv, `Daily_Log_${now.toLocaleDateString().replace(/\//g,'-')}.csv`);
            },
            downloadCSV: (content, fileName) => {
                const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
            },
            addEmployee: async () => {
                const n = document.getElementById('new-emp-name').value;
                const id = document.getElementById('new-emp-id').value;
                const p = document.getElementById('new-emp-pin').value;
                await addDoc(collection(db, `${ROOT}/employees`), { id: Number(id), name: n, pin: p, role: 'Nh√¢n vi√™n', score: 100 });
                alert("ƒê√£ th√™m!");
            },
            addSOP: async () => {
                 const t = document.getElementById('new-sop-name').value;
                 const v = document.getElementById('new-sop-val').value;
                 await addDoc(collection(db, `${ROOT}/sop`), { title: t, sop: v });
                 alert("ƒê√£ th√™m!");
            },
            fillSop: () => {
                const val = document.getElementById('task-title').value;
                const item = (app.data.sop||[]).find(s => s.title === val);
                if(item) document.getElementById('task-target').value = item.sop;
            },
            toggleAssignMode: () => {
                const m = document.getElementById('assign-mode').value;
                document.getElementById('assign-ind-zone').classList.toggle('hidden', m !== 'ind');
                document.getElementById('assign-team-zone').classList.toggle('hidden', m !== 'team');
            },
            
            // Missing Add House Action Fix
            addHouse: async () => {
                const name = prompt("Nh·∫≠p t√™n nh√† n·∫•m m·ªõi (VD: Nh√† C):");
                if (name) {
                    await addDoc(collection(db, `${ROOT}/houses`), { name: name, temp: {am:0, pm:0} });
                    alert("ƒê√£ th√™m nh√† m·ªõi!");
                }
            }
        };
        
        window.onload = app.init;
    </script>
</body>
</html>
