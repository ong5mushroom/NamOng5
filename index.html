<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Nấm Ông 5 - V76 Fix Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; overflow: hidden; height: 100vh; }
        .hidden { display: none !important; }
        .glass-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .input-field { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; font-weight: 600; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #2563eb; ring: 2px solid #2563eb; }
        /* Animation */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-left-color: #2563eb; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    </style>
</head>
<body>

    <!-- 1. MÀN HÌNH ĐĂNG NHẬP & KHỞI TẠO -->
    <div id="login-screen" class="fixed inset-0 bg-slate-50 z-[3000] flex flex-col items-center justify-center p-6">
        <div class="w-24 h-24 bg-blue-600 rounded-3xl flex items-center justify-center text-white text-5xl font-black mb-6 shadow-xl shadow-blue-200">5</div>
        <h1 class="text-3xl font-black text-slate-800 mb-1">Nấm Ông 5</h1>
        <p class="text-sm font-bold text-slate-400 mb-8 uppercase tracking-widest">V76 - System Rescue</p>
        
        <!-- Khu vực báo trạng thái -->
        <div id="login-status-box" class="w-full max-w-xs bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-6 text-center">
            <div id="loading-ui">
                <div class="spinner mb-2"></div>
                <p class="text-xs font-bold text-slate-500">Đang kết nối dữ liệu...</p>
            </div>
            <div id="error-ui" class="hidden">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl mb-2"></i>
                <p id="error-msg" class="text-xs font-bold text-red-500 break-words">Lỗi không xác định</p>
                <button onclick="location.reload()" class="mt-3 text-xs bg-slate-100 px-3 py-1 rounded font-bold">Thử lại</button>
            </div>
            <div id="init-ui" class="hidden">
                <i class="fas fa-database text-orange-500 text-3xl mb-2"></i>
                <p class="text-sm font-bold text-slate-700 mb-1">Chưa có dữ liệu!</p>
                <p class="text-xs text-slate-400 mb-3">Hệ thống cần tạo tài khoản Admin đầu tiên.</p>
                <button onclick="app.sys.initDB()" class="w-full bg-orange-500 text-white py-2 rounded-xl font-bold text-sm shadow-lg active:scale-95">⚡ KHỞI TẠO NGAY</button>
            </div>
        </div>

        <!-- Form Đăng nhập -->
        <div id="login-form" class="w-full max-w-xs space-y-4 transition-opacity duration-300 opacity-50 pointer-events-none">
            <select id="user-select" class="input-field bg-white text-center font-bold text-slate-700">
                <option value="">-- Chọn nhân viên --</option>
            </select>
            <input type="tel" id="user-pin" placeholder="Nhập mã PIN (1234)" class="input-field text-center text-xl tracking-widest" maxlength="6">
            <button onclick="app.sys.login()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg shadow-blue-200 active:scale-95 transition">ĐĂNG NHẬP</button>
        </div>
        
        <p class="fixed bottom-6 text-[10px] text-slate-300 font-bold">ID: 931399604992 | Web App V76</p>
    </div>

    <!-- 2. GIAO DIỆN CHÍNH (Ẩn mặc định) -->
    <div id="app-body" class="hidden h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur border-b p-4 pt-safe flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-black">5</div>
                <div>
                    <h1 class="text-xs font-black uppercase text-slate-800">Trang chủ</h1>
                    <p id="ui-user-name" class="text-[10px] text-green-600 font-bold">...</p>
                </div>
            </div>
            <button onclick="app.sys.logout()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500"><i class="fas fa-power-off text-xs"></i></button>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
            <!-- Dashboard Stats -->
            <div class="grid grid-cols-2 gap-3">
                <div class="glass-card p-4 border-l-4 border-blue-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Nhân sự Online</p>
                    <p class="text-2xl font-black text-blue-600" id="stat-online">1</p>
                </div>
                <div class="glass-card p-4 border-l-4 border-green-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Sản lượng</p>
                    <p class="text-2xl font-black text-green-600">0 kg</p>
                </div>
            </div>

            <!-- Admin Tools -->
            <div id="admin-panel" class="hidden">
                 <div class="glass-card p-4 border border-orange-200 bg-orange-50">
                    <h3 class="text-xs font-black text-orange-600 uppercase mb-3"><i class="fas fa-tools"></i> Công cụ Admin</h3>
                    <div class="space-y-2">
                        <input type="text" id="new-emp-name" placeholder="Tên nhân viên mới..." class="input-field text-sm bg-white">
                        <div class="grid grid-cols-2 gap-2">
                             <input type="number" id="new-emp-id" placeholder="ID (vd: 2)" class="input-field text-sm bg-white">
                             <input type="text" id="new-emp-pin" placeholder="PIN" value="1234" class="input-field text-sm bg-white">
                        </div>
                        <button onclick="app.data.addEmp()" class="w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-bold">Thêm Nhân Viên</button>
                    </div>
                 </div>
            </div>

            <!-- List Houses -->
            <div id="house-list" class="space-y-3"></div>
        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CẤU HÌNH FIREBASE
        const fbConfig = { 
            apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", 
            authDomain: "ong5mushroom-vietnam.firebaseapp.com", 
            projectId: "ong5mushroom-vietnam", 
            storageBucket: "ong5mushroom-vietnam.firebasestorage.app", 
            messagingSenderId: "931399604992", 
            appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" 
        };

        // KHỞI TẠO
        let db, auth;
        const ROOT = "artifacts/namong5_production/public/data";

        try {
            const appInstance = initializeApp(fbConfig);
            db = getFirestore(appInstance);
            auth = getAuth(appInstance);
        } catch (e) {
            showError("Lỗi khởi tạo Firebase: " + e.message);
        }

        // BIẾN TOÀN CỤC
        window.app = {
            state: { employees: [], houses: [] },
            user: null,
            sys: {
                // 1. Kết nối & Tải dữ liệu
                init: async () => {
                    try {
                        await signInAnonymously(auth);
                        console.log("Auth OK");
                        
                        // Lắng nghe dữ liệu nhân viên
                        onSnapshot(collection(db, `${ROOT}/employees`), (snapshot) => {
                            const employees = snapshot.docs.map(d => ({...d.data(), _id: d.id}));
                            app.state.employees = employees;
                            
                            document.getElementById('loading-ui').classList.add('hidden');
                            
                            if (employees.length === 0) {
                                // Nếu chưa có ai -> Hiển thị nút Khởi tạo
                                document.getElementById('init-ui').classList.remove('hidden');
                                document.getElementById('login-form').classList.add('opacity-50', 'pointer-events-none');
                            } else {
                                // Nếu có người -> Điền vào select
                                document.getElementById('init-ui').classList.add('hidden');
                                app.sys.renderSelect(employees);
                            }
                        }, (error) => {
                            showError("Lỗi tải nhân viên: " + error.message);
                        });

                        // Lắng nghe dữ liệu nhà nấm
                        onSnapshot(collection(db, `${ROOT}/houses`), (s) => {
                            app.state.houses = s.docs.map(d => d.data());
                            app.ui.renderHouses();
                        });

                    } catch (e) {
                        showError("Lỗi đăng nhập ẩn danh: " + e.message);
                    }
                },

                // 2. Hiển thị danh sách chọn
                renderSelect: (list) => {
                    const select = document.getElementById('user-select');
                    select.innerHTML = '<option value="">-- Chọn nhân viên --</option>' + 
                        list.map(e => `<option value="${e.id}">${e.name} (${e.role})</option>`).join('');
                    
                    // Bật form đăng nhập
                    const form = document.getElementById('login-form');
                    form.classList.remove('opacity-50', 'pointer-events-none');
                    form.classList.add('opacity-100');
                },

                // 3. Xử lý đăng nhập
                login: () => {
                    const id = document.getElementById('user-select').value;
                    const pin = document.getElementById('user-pin').value.trim();

                    if (!id) return alert("Vui lòng chọn nhân viên!");
                    
                    // Tìm user (ép kiểu String để so sánh an toàn)
                    const user = app.state.employees.find(e => String(e.id) === String(id));
                    
                    if (user && String(user.pin) === String(pin)) {
                        // Đăng nhập thành công
                        app.user = user;
                        localStorage.setItem('n5_user', JSON.stringify(user));
                        app.ui.enterApp();
                    } else {
                        alert("Sai mã PIN! (Mặc định là 1234)");
                    }
                },

                logout: () => {
                    localStorage.removeItem('n5_user');
                    location.reload();
                },

                // 4. Khởi tạo dữ liệu mẫu (Cứu hộ)
                initDB: async () => {
                    if(!confirm("Tạo tài khoản Admin mặc định?")) return;
                    try {
                        // Tạo Admin
                        await addDoc(collection(db, `${ROOT}/employees`), {
                            id: 1, name: "Admin Quản Trị", pin: "1234", role: "Giám đốc", score: 100, lastLogin: new Date().toISOString()
                        });
                        // Tạo Nhà mẫu
                        ['Nhà A', 'Nhà B', 'Nhà C'].forEach(async name => {
                            await addDoc(collection(db, `${ROOT}/houses`), { name, temp: {am: 25, pm: 26} });
                        });
                        alert("Đã tạo xong! Vui lòng chọn Admin và nhập PIN 1234");
                    } catch(e) {
                        showError("Không thể ghi dữ liệu: " + e.message);
                    }
                }
            },

            ui: {
                enterApp: () => {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-body').classList.remove('hidden');
                    document.getElementById('ui-user-name').innerText = `${app.user.name} | ${app.user.role}`;
                    
                    // Nếu là admin thì hiện công cụ
                    if(['Giám đốc', 'Quản lý'].includes(app.user.role)) {
                        document.getElementById('admin-panel').classList.remove('hidden');
                    }
                },
                renderHouses: () => {
                    document.getElementById('house-list').innerHTML = app.state.houses.map(h => `
                        <div class="glass-card p-4 flex justify-between items-center">
                            <span class="font-bold text-slate-700">${h.name}</span>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">25°C</span>
                        </div>
                    `).join('');
                }
            },
            
            data: {
                addEmp: async () => {
                    const name = document.getElementById('new-emp-name').value;
                    const id = document.getElementById('new-emp-id').value;
                    const pin = document.getElementById('new-emp-pin').value;
                    if(!name || !id) return alert("Thiếu thông tin!");
                    
                    await addDoc(collection(db, `${ROOT}/employees`), {
                        id: Number(id), name, pin: pin || "1234", role: "Nhân viên", score: 50
                    });
                    alert("Đã thêm nhân viên: " + name);
                    document.getElementById('new-emp-name').value = "";
                }
            }
        };

        // Helper hiển thị lỗi
        function showError(msg) {
            document.getElementById('loading-ui').classList.add('hidden');
            document.getElementById('error-ui').classList.remove('hidden');
            document.getElementById('error-msg').innerText = msg;
            console.error(msg);
        }

        // Chạy ngay khi tải trang
        window.onload = app.sys.init;
    </script>
</body>
</html>
