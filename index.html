<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="N·∫•m √îng 5">
    <meta name="theme-color" content="#2563eb">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3252/3252932.png">
    <title>N·∫•m √îng 5 V162 - Excel Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --blue: #2563eb; --header-h: 125px; --nav-h: 80px; --bg: #f8fafc; --shiitake: #5d2b0c; }
        * { font-family: "Times New Roman", Times, serif; }
        .fas, .far, .fab, .fa-solid, .fa-regular, .fa-brands, [class^="fa-"] { font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important; }
        body { background: var(--bg); color: #1e293b; margin: 0; height: 100vh; overflow: hidden; user-select: none; }
        #app-header { height: var(--header-h); background: white; border-bottom: 1px solid #e2e8f0; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding-top: env(safe-area-inset-top); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
        #app-view-container { position: fixed; top: var(--header-h); bottom: var(--nav-h); left: 0; right: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 16px; padding-bottom: 40px; z-index: 10; }
        #app-nav { height: var(--nav-h); background: white; border-top: 1px solid #e2e8f0; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); display: flex; justify-content: space-around; align-items: center; }
        .hidden { display: none !important; }
        .card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .input-box { width: 100%; background: #f1f5f9; border: 1.5px solid #cbd5e1; padding: 12px; border-radius: 12px; font-weight: 600; outline: none; font-size: 15px; transition: all 0.2s; }
        .input-box:focus { border-color: var(--blue); background: white; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .btn-primary { background: var(--blue); color: white; font-weight: 800; padding: 14px; border-radius: 14px; width: 100%; text-transform: uppercase; font-size: 12px; box-shadow: 0 4px 6px rgba(37,99,235,0.2); transition: all 0.2s; border: none; cursor: pointer; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
        .label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.02em; }
        .nav-btn { color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; transition: color 0.2s; background: none; border: none; outline: none; }
        .nav-btn.active { color: var(--blue); transform: translateY(-2px); }
        .sub-tab-btn { flex: 1; padding: 10px; font-size: 11px; font-weight: 800; text-align: center; border-radius: 10px; color: #64748b; transition: all 0.2s; background: none; border: none; }
        .sub-tab-btn.active { background: white; color: var(--blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #login-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        #chat-layer { position: fixed; inset: 0; background: #efeae2; z-index: 2000; display: none; flex-direction: column; }
        .chat-bg { background-image: url('data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M20 5c-5 0-9 4-9 9 0 3 2 5 5 6v10h8V20c3-1 5-3 5-6 0-5-4-9-9-9z" fill="%2378350f" fill-opacity="0.05"/></svg>'); }
        #chat-box { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .chat-bubble { max-width: 82%; padding: 10px 14px; border-radius: 16px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .chat-me { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-other { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-system { background: #fee2e2; color: #991b1b; align-self: center; border-radius: 8px; font-size: 11px; font-weight: 700; text-align: center; border: 1px dashed #f87171; padding: 10px 16px; margin: 5px 0; width: 95%; }
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 16px; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; max-height: 85vh; overflow-y: auto; position: relative; }
        .modal-close-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; cursor: pointer; z-index: 10; }
        .shiitake-logo { width: 220px; height: 220px; margin-bottom: 25px; filter: drop-shadow(0 15px 35px rgba(93,43,12,0.35)); }
        .staff-online { border: 2px solid #22c55e !important; background: #f0fdf4 !important; }
        .staff-offline { opacity: 0.6; filter: grayscale(0.8); background: #f1f5f9 !important; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 8px; background: white; }
        .log-table th { background: var(--shiitake); text-align: left; padding: 8px; color: white; border: 1px solid #4a220a; font-weight: 800; text-transform: uppercase; white-space: nowrap; }
        .log-table td { padding: 8px; border: 1px solid #e2e8f0; font-weight: 600; color: #475569; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .slogan { font-size: 13px; font-weight: 900; color: var(--shiitake); letter-spacing: 0.08em; text-transform: uppercase; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="msg-box" style="display:none; position: fixed; top: 20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; z-index:5000; border-radius:30px; font-weight:bold; font-size:12px;"></div>

    <div id="login-overlay">
        <svg class="shiitake-logo" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M216 350c0 40 10 98 40 98s40-58 40-98z" fill="#D2B48C" />
            <path d="M256 90c-140 0-230 80-230 180 0 40 40 70 80 80 40 10 110 20 150 20s110-10 150-20c40-10 80-40 80-80 0-100-90-180-230-180z" fill="#5D2B0C"/>
        </svg>
        <h1 class="text-4xl font-black text-slate-800 mb-0.5 tracking-tight text-center italic leading-none">N·∫•m √îng 5</h1>
        <p class="slogan mb-12 text-center font-black">PLATINUM V162 - EXCEL FIX</p>
        <div class="w-full max-w-sm space-y-4">
            <div id="login-status" class="text-center text-xs font-bold text-slate-400 mb-2 flex items-center justify-center font-black italic">
                <span class="status-dot status-wait" id="auth-dot">‚óè</span> <span id="status-text" class="ml-2">ƒêang k·∫øt n·ªëi...</span>
            </div>
            <select id="login-user" class="input-box text-center appearance-none shadow-sm font-black" disabled><option value="">ƒêang t·∫£i nh√¢n s·ª±...</option></select>
            <input id="login-pin" type="password" placeholder="M√£ PIN" class="input-box text-center text-2xl tracking-[0.4em] shadow-inner font-black" disabled maxlength="6" inputmode="numeric">
            <button id="login-btn" onclick="app.doLogin()" class="btn-primary opacity-50 cursor-not-allowed bg-amber-900 shadow-amber-900/20 italic font-black" disabled>V√ÄO H·ªÜ TH·ªêNG</button>
        </div>
    </div>

    <header id="app-header">
        <div class="flex items-center gap-3">
            <div class="bg-amber-900 p-1.5 rounded-xl shadow-lg border border-amber-800">
                <i class="fas fa-seedling text-white text-lg"></i>
            </div>
            <div class="leading-none">
                <h1 class="text-base font-black uppercase text-slate-800 tracking-wide leading-none">N·∫•m √îng 5</h1>
                <p class="text-[7px] font-black text-amber-800 uppercase mt-1 tracking-tighter italic">TRAO S·ª®C KH·ªéE, TR·ªåN Y√äU TH∆Ø∆†NG</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="text-right leading-none"><p id="head-user" class="font-bold text-xs text-slate-700 font-black">...</p><p id="head-role" class="text-[9px] text-amber-700 font-bold uppercase mt-1 italic tracking-tighter font-black">...</p></div>
            <button onclick="app.ui.showModal('settings-modal')" class="w-9 h-9 bg-slate-50 rounded-full border flex items-center justify-center text-slate-500 active:scale-90 shadow-sm"><i class="fas fa-cog text-xs"></i></button>
        </div>
    </header>

    <div id="app-view-container">
        <div id="view-home" class="view-section hidden animate-in fade-in">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="card border-l-4 border-blue-500 text-center shadow-sm"><p class="label mb-1">Tr·ª±c tuy·∫øn</p><p class="text-2xl font-black text-blue-600 leading-none" id="stat-online">0</p></div>
                <div class="card border-l-4 border-green-500 text-center shadow-sm"><p class="label uppercase mb-1 font-black">T·ªïng h√°i ng√†y (Kg)</p><p class="text-2xl font-black text-green-600 leading-none" id="stat-yield">0.00</p></div>
            </div>
            
            <div class="card border border-yellow-100 shadow-sm mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-black text-yellow-600 uppercase tracking-widest leading-none italic"><i class="fas fa-trophy mr-1"></i> B·∫£ng V√†ng</h3>
                    <button onclick="app.actions.exportTH()" class="text-[10px] font-black text-blue-500 bg-blue-50 px-2.5 py-1 rounded shadow-sm uppercase italic border border-blue-100">B√°o C√°o T·ªïng</button>
                </div>
                <div id="leaderboard" class="space-y-2 text-xs"><p class="text-center text-slate-400 italic">ƒêang t·∫£i...</p></div>
            </div>
            
            <p class="label px-2 mb-2 tracking-widest font-black text-slate-400 italic uppercase text-[9px]">Hi·ªán tr·∫°ng nh√† tr·ªìng</p>
            <div id="house-list" class="space-y-3"></div>
        </div>

        <div id="view-tasks" class="view-section hidden animate-in fade-in">
             <div id="admin-task-form" class="hidden card border-2 border-blue-50 shadow-md">
                <div class="flex justify-between items-center mb-3"><span class="text-xs font-black text-blue-600 uppercase italic leading-none">Giao vi·ªác m·ªõi</span><select id="assign-mode" onchange="app.ui.toggleAssign()" class="text-[10px] font-bold bg-slate-100 p-1 rounded shadow-inner"><option value="ind">C√° nh√¢n</option><option value="team">C·∫£ T·ªï</option></select></div>
                <div class="space-y-3">
                    <input id="task-title" placeholder="N·ªôi dung c√¥ng vi·ªác..." class="input-box bg-white text-sm shadow-inner font-bold italic">
                    <div><p class="label">Ch·ªçn Nh√† n·∫•m (Tick nhi·ªÅu)</p><div id="house-multi-select" class="grid grid-cols-3 gap-1 bg-slate-50 p-2 rounded border max-h-32 overflow-y-auto shadow-inner"></div></div>
                    <div id="assign-ind-zone" class="max-h-32 overflow-y-auto border p-2 rounded bg-slate-50 grid grid-cols-2 gap-1 shadow-inner font-black"></div>
                    <div id="assign-team-zone" class="hidden bg-slate-50 p-2 rounded-xl border space-y-2 text-xs font-bold shadow-inner font-black"><label class="flex items-center gap-2 font-black"><input type="radio" name="team-radio" value="T·ªï S·∫£n Xu·∫•t" checked> T·ªï S·∫£n Xu·∫•t</label><label class="flex items-center gap-2 font-black"><input type="radio" name="team-radio" value="T·ªï Thu Ho·∫°ch"> T·ªï Thu Ho·∫°ch</label></div>
                    <button onclick="app.actions.createTask()" class="btn-primary bg-slate-800 mt-2 shadow-lg uppercase font-black italic">Ban l·ªánh ngay</button>
                </div>
            </div>
            
            <div class="flex gap-2 mb-3 mt-2">
                <input type="date" id="task-filter-start" class="input-box text-[10px] p-2" onchange="app.renderDynamic()">
                <input type="date" id="task-filter-end" class="input-box text-[10px] p-2" onchange="app.renderDynamic()">
                <select id="task-filter-status" class="input-box text-[10px] p-2" onchange="app.renderDynamic()"><option value="all">T·∫•t c·∫£</option><option value="pending">Ch∆∞a xong</option><option value="completed">ƒê√£ xong</option></select>
            </div>

            <p class="label px-2 tracking-widest font-black italic uppercase text-[9px] leading-none">Danh s√°ch c√¥ng vi·ªác</p>
            <div id="task-list-grouped" class="space-y-4 pb-20 mt-2"></div>
        </div>

        <div id="view-sx" class="view-section hidden animate-in fade-in">
            <h2 class="font-black text-slate-800 uppercase text-xs tracking-tight mb-2 px-1 italic">Qu·∫£n l√Ω Ph√¥i N·∫•m</h2>
            <div class="card border-2 border-indigo-50 shadow-md">
                <div class="space-y-4">
                    <div>
                        <p class="label font-black text-blue-600 uppercase mb-1 leading-none text-[10px]">Nh√† N·∫•m</p>
                        <select id="sx-house-id" class="input-box bg-white font-bold text-indigo-700 shadow-sm border-indigo-100 font-black italic leading-none"></select>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        <div><p class="label font-black text-slate-600 uppercase mb-1 leading-none text-[9px]">Lo·∫°i Ph√¥i</p><input id="sx-type" list="phoi-list-v6" class="input-box bg-white p-2 text-xs shadow-inner font-black italic" placeholder="VD: 049..."><datalist id="phoi-list-v6"><option value="049 ƒê·∫°t"><option value="049 TD"></datalist></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><p class="label font-black text-slate-600 uppercase mb-1 leading-none text-[9px]">S·ªë l∆∞·ª£ng (t√∫i)</p><input type="number" id="sx-qty" class="input-box bg-white text-center font-black text-lg p-2 shadow-inner" placeholder="0"></div>
                            <div><p class="label font-black text-slate-600 uppercase mb-1 leading-none text-[9px]">L√¥ c·∫•y</p><input id="sx-batch" class="input-box bg-white text-center p-2 text-xs shadow-inner font-black" placeholder="..."></div>
                        </div>
                        <div><p class="label font-black text-slate-600 uppercase mb-1 leading-none text-[9px]">Ng√†y th·ª±c hi·ªán</p><input type="date" id="sx-date" class="input-box bg-white text-center p-2 text-xs shadow-inner font-black italic"></div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="app.actions.submitSX('NH·∫¨P')" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-md active:scale-95 transition-all italic leading-none">Nh·∫≠p kho</button>
                        <button onclick="app.actions.submitSX('XU·∫§T')" class="flex-1 bg-amber-700 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-md active:scale-95 transition-all italic leading-none">Xu·∫•t kho</button>
                    </div>
                </div>
            </div>
            <p class="label px-2 mt-4 italic font-black text-slate-400 uppercase text-[9px]">10 L·ªánh s·∫£n xu·∫•t g·∫ßn nh·∫•t</p>
            <div id="sx-log-list" class="space-y-2 pb-24 mt-2"></div>
        </div>

        <div id="view-th" class="view-section hidden animate-in fade-in">
             <div class="flex bg-slate-200 p-1 rounded-xl mb-4 shadow-inner border border-slate-300">
                 <button onclick="app.ui.setTHSubTab('harvest')" id="sub-btn-harvest" class="sub-tab-btn active uppercase font-black italic leading-none">H√°i n·∫•m s·∫°ch</button>
                 <button onclick="app.ui.setTHSubTab('export')" id="sub-btn-export" class="sub-tab-btn uppercase font-black italic leading-none">Xu·∫•t ƒë∆°n b√°n</button>
             </div>
             
             <div id="th-sub-harvest" class="space-y-3">
                 <div class="card border-2 border-green-50 shadow-md">
                     <div class="space-y-3">
                         <div><p class="label font-black text-blue-600 italic uppercase leading-none mb-1 text-[10px]">Nh√† h√°i</p><select id="th-area" onchange="app.ui.resetTHInputs()" class="input-box bg-white font-bold text-green-700 shadow-sm border-green-100 font-black italic leading-none"></select></div>
                         <div class="bg-slate-50 p-3 rounded-2xl border shadow-inner">
                             <div class="grid grid-cols-5 gap-2 mb-2 font-black">
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">B2</label><input type="number" id="th-b2" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">A1</label><input type="number" id="th-a1" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">A2</label><input type="number" id="th-a2" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">B1</label><input type="number" id="th-b1" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 text-blue-600 font-black italic uppercase leading-none">Ch√¢n</label><input type="number" id="th-chan" step="0.01" class="input-box !p-2 text-center border-blue-100 font-black shadow-inner" oninput="app.ui.calcTH()"></div>
                            </div>
                             <div class="grid grid-cols-5 gap-2">
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">D1</label><input type="number" id="th-d1" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">A1F</label><input type="number" id="th-a1f" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">A2F</label><input type="number" id="th-a2f" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">B2F</label><input type="number" id="th-b2f" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                                <div><label class="text-center text-[9px] font-black block mb-1 uppercase text-slate-400">HT</label><input type="number" id="th-ht" step="0.01" class="input-box !p-2 text-center shadow-inner font-black" oninput="app.ui.calcTH()"></div>
                            </div>
                         </div>
                         <div class="bg-green-50 p-4 rounded-xl border border-green-200 flex justify-between items-center shadow-sm"><span class="text-xs font-bold uppercase text-green-800 italic font-black leading-none">T·ªïng l∆∞·ª£ng:</span><span id="th-total-display" class="font-black text-2xl text-green-600 leading-none">0.00 kg</span></div>
                         <button onclick="app.actions.submitTH()" class="btn-primary bg-green-600 shadow-lg uppercase font-black italic">L∆∞u phi·∫øu h√°i</button>
                     </div>
                 </div>
             </div>
             
             <div id="th-sub-export" class="space-y-3 hidden">
                <div class="card border-2 border-blue-50 shadow-lg">
                    <div class="mb-4"><p class="label font-black text-blue-600 uppercase tracking-tighter italic leading-none mb-2">Kh√°ch h√†ng</p><input id="export-customer-name" placeholder="T√™n kh√°ch..." class="input-box bg-white shadow-inner font-bold italic leading-none" onchange="app.ui.resetTHInputs()"></div>
                    <div id="export-matrix" class="grid grid-cols-1 gap-1.5 mb-4"></div>
                    <button onclick="app.actions.submitExport()" class="btn-primary bg-blue-600 shadow-md uppercase font-black italic leading-none">Ch·ªët xu·∫•t b√°n</button>
                </div>
             </div>
             
             <p class="label px-1 mt-4 tracking-widest font-black text-slate-400 italic leading-none uppercase text-[9px]">Nh·∫≠t k√Ω h√°i & Xu·∫•t kho</p>
             <div id="harvest-recent-table" class="overflow-x-auto no-scrollbar mt-2 pb-20 shadow-sm rounded-xl border"></div>
        </div>

        <div id="view-team" class="view-section hidden px-1 animate-in fade-in">
             <div class="card p-4 text-center shadow-sm mb-4 border-2 border-blue-100 shadow-inner leading-none"><p class="label mb-3 uppercase tracking-widest font-black italic text-blue-600 leading-none">ƒêi·ªÉm danh</p><div class="grid grid-cols-2 gap-3 font-black"><button onclick="app.actions.checkIn('S√°ng')" class="btn-primary bg-yellow-500 shadow-yellow-100 uppercase font-black italic leading-none">‚òÄÔ∏è S√°ng</button><button onclick="app.actions.checkIn('Chi·ªÅu')" class="btn-primary bg-indigo-500 shadow-indigo-100 uppercase font-black italic leading-none">üåô Chi·ªÅu</button></div></div>
             
             <div class="card bg-slate-50 border-slate-200 shadow-sm mb-4">
                <p class="label mb-3 uppercase font-black text-[9px] italic leading-none">H√†nh ch√≠nh</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.ui.showModal('modal-leave')" class="btn-primary bg-white text-slate-600 border shadow-none text-[10px] italic font-black shadow-sm border-slate-300 leading-none"><i class="fas fa-calendar-times text-red-500 mr-1"></i> Xin ngh·ªâ</button>
                    <button onclick="app.ui.showModal('modal-buy')" class="btn-primary bg-white text-slate-600 border shadow-none text-[10px] italic font-black shadow-sm border-slate-300 leading-none"><i class="fas fa-shopping-cart text-green-500 mr-1"></i> Mua h√†ng</button>
                </div>
                <div class="mt-5 pt-4 border-t border-slate-200 flex flex-col gap-2">
                    <button onclick="app.actions.exportAttendance()" class="w-full bg-slate-200 text-slate-700 py-3 rounded-xl font-black text-[11px] uppercase shadow-inner italic tracking-tight border border-slate-300 leading-none">Xu·∫•t B·∫£ng Ch·∫•m C√¥ng</button>
                </div>
             </div>
             
             <p class="label px-2 mb-2 tracking-widest font-black text-slate-400 uppercase text-[9px] leading-none italic">Nh√¢n s·ª±</p>
             <div id="team-list" class="space-y-2 pb-24 font-black"><p class="text-center text-slate-400 italic">ƒêang t·∫£i danh s√°ch...</p></div>
        </div>
    </div>

    <div id="chat-layer">
        <div class="h-[70px] bg-white border-b flex items-end px-4 pb-3 shadow-sm">
             <button onclick="app.ui.closeChat()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center mr-3 active:bg-slate-200 shadow-sm shadow-inner"><i class="fas fa-arrow-left text-slate-600"></i></button>
             <h2 class="font-black text-slate-800 text-lg uppercase tracking-tight leading-none italic">Th·∫£o lu·∫≠n</h2>
        </div>
        <div id="chat-box" class="no-scrollbar chat-bg shadow-inner"></div>
        <div class="chat-input-area bg-white p-3 flex gap-2 border-t shadow-lg pb-10">
            <button class="w-11 h-11 rounded-full bg-red-50 text-red-500 flex items-center justify-center active:scale-75 shadow-sm" onclick="app.actions.sendReaction('‚ù§Ô∏è')"><i class="fas fa-heart text-sm"></i></button>
            <input id="chat-input" type="text" class="flex-1 bg-slate-100 rounded-full px-5 py-2.5 text-sm outline-none border shadow-inner font-medium shadow-inner italic font-black" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeyup="if(event.key==='Enter') app.actions.sendChat()">
            <button onclick="app.actions.sendChat()" class="w-11 h-11 bg-blue-600 rounded-full text-white flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-paper-plane text-xs"></i></button>
        </div>
    </div>

    <nav id="app-nav">
        <button onclick="app.ui.tab('home')" class="nav-btn active" id="btn-home"><i class="fas fa-home text-xl"></i><span>HOME</span></button>
        <button onclick="app.ui.tab('tasks')" class="nav-btn" id="btn-tasks"><i class="fas fa-clipboard-list text-xl"></i><span>VI·ªÜC</span></button>
        <button onclick="app.ui.tab('sx')" class="nav-btn" id="btn-sx"><i class="fas fa-industry text-xl"></i><span>SX</span></button>
        <button onclick="app.ui.tab('th')" class="nav-btn" id="btn-th"><i class="fas fa-box-open text-xl"></i><span>THDG</span></button>
        <button onclick="app.ui.tab('team')" class="nav-btn" id="btn-team"><i class="fas fa-users text-xl"></i><span>TEAM</span></button>
        <button onclick="app.ui.openChat()" class="nav-btn"><i class="fas fa-comments text-xl"></i><span>CHAT</span></button>
    </nav>

    <div id="settings-modal" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('settings-modal')">
        <div class="modal-box shadow-2xl border-2 border-slate-50 font-black">
            <div class="modal-close-btn" onclick="app.ui.closeModal('settings-modal')"><i class="fas fa-times"></i></div>
            <h3 class="font-black text-xl mb-6 text-slate-800 uppercase border-b pb-3 text-center italic text-blue-600 leading-none">Trung t√¢m Qu·∫£n tr·ªã</h3>
            <div class="space-y-4">
                <div id="admin-tools" class="hidden space-y-3 font-black">
                    <button id="btn-reset-score" onclick="app.actions.resetLeaderboard()" class="btn-primary bg-orange-600 uppercase font-black shadow-lg flex items-center justify-center gap-3 italic leading-none"><i class="fas fa-history text-xs mr-1"></i> Reset BXH Thi ƒêua</button>
                    <button id="btn-approve" onclick="app.ui.showModal('modal-approve')" class="btn-primary bg-indigo-600 uppercase font-black shadow-lg flex items-center justify-center gap-3 italic leading-none"><i class="fas fa-check-double text-xs mr-1"></i> Duy·ªát ƒê∆°n T·ª´</button>
                    <button onclick="app.ui.showModal('modal-sop')" class="btn-primary bg-slate-600 uppercase font-black shadow-lg flex items-center justify-center gap-3 italic leading-none"><i class="fas fa-book text-xs mr-1"></i> Xem Quy Tr√¨nh (SOP)</button>
                    <div class="border-t pt-5 space-y-2">
                        <button onclick="app.ui.showModal('modal-add-staff')" class="btn-primary bg-slate-700 uppercase shadow-none text-[10px] italic leading-none">Th√™m nh√¢n s·ª± m·ªõi</button>
                        <button onclick="app.actions.exportTH()" class="btn-primary bg-slate-500 uppercase shadow-none text-[10px] italic leading-none">Xu·∫•t B√°o C√°o T·ªïng</button>
                    </div>
                </div>
                <button onclick="app.actions.logout()" class="btn-primary bg-red-500 mt-6 shadow-md font-black italic uppercase tracking-widest leading-none">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>

    <div id="modal-sop" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-sop')"><div class="modal-box shadow-2xl p-6 font-black"><div class="modal-close-btn" onclick="app.ui.closeModal('modal-sop')"><i class="fas fa-times"></i></div><h3 class="font-bold mb-4 text-center">QUY TR√åNH CHU·∫®N (SOP)</h3><textarea id="sop-content" class="w-full h-64 p-2 text-xs border bg-slate-50 rounded" placeholder="Nh·∫≠p quy tr√¨nh t·∫°i ƒë√¢y... (L∆∞u v√†o DB trong b·∫£n sau)"></textarea><button class="btn-primary mt-2">L∆∞u (Demo)</button></div></div>

    <div id="modal-approve" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-approve')"><div class="modal-box shadow-2xl p-4 font-black"><div class="modal-close-btn" onclick="app.ui.closeModal('modal-approve')"><i class="fas fa-times"></i></div><h3 class="font-bold mb-4 text-center">DUY·ªÜT ƒê∆†N</h3><div id="approval-list" class="space-y-2"></div></div></div>

    <div id="modal-leave" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-leave')"><div class="modal-box shadow-2xl p-8 border-2 border-blue-50 font-black"><div class="modal-close-btn" onclick="app.ui.closeModal('modal-leave')"><i class="fas fa-times"></i></div><h3 class="font-bold mb-6 uppercase text-blue-600 text-center italic leading-none">ƒê∆°n xin ngh·ªâ ph√©p</h3><div class="space-y-4 pt-2 font-black"><p class="label font-black italic text-[11px] mb-0 leading-none">Ng√†y ngh·ªâ</p><input id="leave-date" type="date" class="input-box shadow-inner font-black"><p class="label font-black italic text-[11px] mb-0 leading-none">L√Ω do</p><select id="leave-reason" class="input-box shadow-inner font-black"><option>S·ª©c kh·ªèe / ·ªêm</option><option>Vi·ªác gia ƒë√¨nh</option><option>Kh√°c</option></select><button onclick="app.actions.submitHR('LEAVE')" class="btn-primary shadow-md italic uppercase font-black mt-2 leading-none">G·ª≠i ƒë∆°n</button></div></div></div>
    
    <div id="modal-buy" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-buy')"><div class="modal-box shadow-2xl p-8 border-2 border-green-50 font-black"><div class="modal-close-btn" onclick="app.ui.closeModal('modal-buy')"><i class="fas fa-times"></i></div><h3 class="font-bold mb-6 uppercase text-green-600 text-center italic leading-none">ƒê·ªÅ xu·∫•t mua v·∫≠t t∆∞</h3><div class="space-y-4 pt-2 font-black"><p class="label font-black italic leading-none text-[11px] uppercase">T√™n v·∫≠t t∆∞</p><input type="text" id="pur-item" placeholder="Nh·∫≠p t√™n..." class="input-box shadow-inner font-bold italic leading-none"><button onclick="app.actions.submitHR('PURCHASE')" class="btn-primary bg-green-600 shadow-md italic uppercase font-black mt-2 leading-none">G·ª≠i ƒë·ªÅ xu·∫•t</button></div></div></div>

    <div id="modal-add-staff" class="modal-wrap hidden" onclick="if(event.target===this) app.ui.closeModal('modal-add-staff')">
        <div class="modal-box shadow-2xl p-8 font-black"><div class="modal-close-btn" onclick="app.ui.closeModal('modal-add-staff')"><i class="fas fa-times"></i></div><h3 class="font-bold mb-6 uppercase text-center italic leading-tight text-blue-600 leading-none">Th√™m Nh√¢n S·ª±</h3><div class="space-y-4 font-black"><input id="new-emp-name" placeholder="H·ªç t√™n..." class="input-box shadow-inner italic font-black"><div class="grid grid-cols-2 gap-3 font-black"><input id="new-emp-id" placeholder="M√£ ID" class="input-box shadow-inner font-black" inputmode="numeric"><input id="new-emp-pin" placeholder="PIN" class="input-box shadow-inner font-black" inputmode="numeric" maxlength="6"></div><select id="new-emp-role" class="input-box shadow-inner italic font-black"><option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option><option value="T·ªï tr∆∞·ªüng">T·ªï tr∆∞·ªüng</option><option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option><option value="K·∫ø to√°n">K·∫ø to√°n</option></select><select id="new-emp-team" class="input-box shadow-inner italic font-black"><option value="T·ªï Thu Ho·∫°ch">T·ªï Thu Ho·∫°ch</option><option value="T·ªï S·∫£n Xu·∫•t">T·ªï S·∫£n Xu·∫•t</option></select><button onclick="app.actions.addEmployee()" class="btn-primary shadow-md font-black uppercase italic leading-none">L∆∞u nh√¢n s·ª±</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fbConfig = { apiKey: "AIzaSyBQDQfYuhf0AWOtmcdufVGeXlzwnSJ33Vw", authDomain: "ong5mushroom-vietnam.firebaseapp.com", projectId: "ong5mushroom-vietnam", storageBucket: "ong5mushroom-vietnam.firebasestorage.app", messagingSenderId: "931399604992", appId: "1:931399604992:web:134c9bfbddbfef97cd31e5" };
        const appInstance = initializeApp(fbConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);
        const ROOT = "artifacts/namong5_production/public/data";

        window.app = {
            data: { employees: [], houses: [], harvest: [], exports: [], chat: [], production: [], attendance: [], tasks: [], hr_requests: [] },
            user: JSON.parse(localStorage.getItem('n5_v162_user')) || null,

            getEmpName: (id) => { const e = window.app.data.employees.find(x => String(x.id) === String(id)); return e ? e.name : id; },

            helpers: {
                getHouseStats: (houseName) => {
                    const hLogs = window.app.data.harvest.filter(l => l.area === houseName);
                    const totalHarvest = hLogs.reduce((acc, curr) => acc + (Number(curr.total) || 0), 0);
                    
                    const pLogs = window.app.data.production
                        .filter(p => p.house === houseName && p.action === 'NH·∫¨P')
                        .sort((a,b) => b.time - a.time); 
                    
                    const latestProd = pLogs[0] || { qty: 0, batch: '--' };
                    
                    return {
                        totalHarvest: totalHarvest.toFixed(1),
                        qty: latestProd.qty,
                        batch: latestProd.batch
                    };
                },
                // V162: FIX EXCEL
                downloadCSV: (csvContent, fileName) => {
                    const BOM = "\uFEFF"; 
                    const blob = new Blob([BOM + "sep=;\n" + csvContent], { type: 'text/csv;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = fileName;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                }
            },

            ui: {
                showMsg: (t) => { const b = document.getElementById('msg-box'); b.innerText = t; b.style.display = 'block'; setTimeout(() => b.style.display = 'none', 3000); },
                showModal: id => { 
                    document.getElementById(id)?.classList.remove('hidden'); 
                    if(id === 'modal-approve') window.app.renderApprovals();
                },
                closeModal: id => document.getElementById(id)?.classList.add('hidden'),
                openChat: () => { document.getElementById('chat-layer').style.display = 'flex'; window.app.renderChat(); },
                closeChat: () => { document.getElementById('chat-layer').style.display = 'none'; },
                
                tab: (id) => {
                    if (!window.app.user) return;
                    const u = window.app.user;
                    const isGenAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω', 'K·∫ø to√°n'].includes(u.role);
                    
                    if (!isGenAdmin) {
                        if (id === 'th' && u.team !== 'T·ªï Thu Ho·∫°ch') return window.app.ui.showMsg("Ch·ªâ d√†nh cho T·ªï Thu Ho·∫°ch!");
                        if (id === 'sx' && u.team !== 'T·ªï S·∫£n Xu·∫•t') return window.app.ui.showMsg("Ch·ªâ d√†nh cho T·ªï S·∫£n Xu·∫•t!");
                    }
                    
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    document.getElementById('view-'+id)?.classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('btn-'+id)?.classList.add('active');
                    window.app.renderDynamic(); 
                },

                setTHSubTab: (tabId) => {
                    document.getElementById('th-sub-harvest').classList.toggle('hidden', tabId !== 'harvest');
                    document.getElementById('th-sub-export').classList.toggle('hidden', tabId !== 'export');
                    document.getElementById('sub-btn-harvest').classList.toggle('active', tabId === 'harvest');
                    document.getElementById('sub-btn-export').classList.toggle('active', tabId === 'export');
                    if(tabId === 'export') window.app.ui.renderExportMatrix();
                },

                renderExportMatrix: () => {
                    const el = document.getElementById('export-matrix'); if(!el) return;
                    const types = [{id:'b2',n:'N·∫•m B2'},{id:'a1',n:'N·∫•m A1'},{id:'a2',n:'N·∫•m A2'},{id:'b1',n:'N·∫•m B1'},{id:'chan',n:'Ch√¢n'},{id:'ht',n:'H·∫ßu Th·ªß'},{id:'d1',n:'N·∫•m D1'},{id:'a1f',n:'N·∫•m A1F'},{id:'a2f',n:'N·∫•m A2F'},{id:'b2f',n:'N·∫•m B2F'}];
                    el.innerHTML = types.map(t => `
                        <div class="bg-white p-3 rounded-2xl border flex items-center justify-between shadow-sm mb-1">
                            <span class="text-[10px] font-black text-blue-600 uppercase w-24">${t.n}</span>
                            <input type="number" id="exp-qty-${t.id}" step="0.01" class="input-box !p-2 !text-center flex-1 mx-3 shadow-inner" placeholder="0.00">
                        </div>`).join('');
                },

                calcTH: () => {
                    const ids = ['th-b2','th-a1','th-a2','th-b1','th-chan','th-d1','th-a1f','th-a2f','th-b2f','th-ht'];
                    let sum = 0; ids.forEach(id => sum += Number(document.getElementById(id)?.value)||0);
                    document.getElementById('th-total-display').innerText = sum.toFixed(2) + ' kg';
                },

                resetTHInputs: () => {
                    ['th-b2','th-a1','th-a2','th-b1','th-chan','th-d1','th-a1f','th-a2f','th-b2f','th-ht'].forEach(id => {
                        const el = document.getElementById(id); if(el) el.value = '';
                    });
                    document.getElementById('th-total-display').innerText = '0.00 kg';
                },
                
                toggleAssign: () => {
                    const m = document.getElementById('assign-mode').value;
                    document.getElementById('assign-ind-zone').classList.toggle('hidden', m !== 'ind');
                    document.getElementById('assign-team-zone').classList.toggle('hidden', m !== 'team');
                }
            },

            init: () => {
                signInAnonymously(auth).then(() => {
                    document.getElementById('status-text').innerText = 'ƒê√£ k·∫øt n·ªëi m√°y ch·ªß';
                    document.getElementById('auth-dot').className = 'status-dot status-ok text-green-500';
                    window.app.sync();
                });
            },

            sync: () => {
                const mapData = s => s.docs.map(d => ({...d.data(), _id: d.id}));
                
                onSnapshot(collection(db, `${ROOT}/employees`), s => {
                    window.app.data.employees = mapData(s);
                    window.app.renderLogin();
                    if(window.app.user) { window.app.renderTeam(); window.app.renderApp(); }
                });

                ['houses', 'harvest_logs', 'export_logs', 'attendance_logs', 'production_logs', 'tasks', 'hr_requests', 'chat'].forEach(col => {
                    onSnapshot(collection(db, `${ROOT}/${col}`), s => {
                        const d = mapData(s);
                        if (col === 'harvest_logs') window.app.data.harvest = d;
                        else if (col === 'export_logs') window.app.data.exports = d;
                        else if (col === 'attendance_logs') window.app.data.attendance = d;
                        else if (col === 'production_logs') window.app.data.production = d;
                        else if (col === 'chat') window.app.data.chat = d.sort((a,b)=>a.time-b.time);
                        else window.app.data[col] = d;
                        
                        if(window.app.user) {
                            if(col==='chat') window.app.renderChat();
                            else window.app.renderDynamic();
                        }
                    });
                });
            },

            renderLogin: () => {
                const s = document.getElementById('login-user');
                if (s && window.app.data.employees.length > 0) {
                    const savedId = s.value;
                    s.innerHTML = '<option value="">-- Ch·ªçn danh t√≠nh --</option>' + 
                        window.app.data.employees.map(e => `<option value="${e.id}" ${e.id==savedId?'selected':''}>${e.name}</option>`).join('');
                    s.disabled = false; document.getElementById('login-pin').disabled = false;
                    document.getElementById('login-btn').classList.remove('opacity-50', 'cursor-not-allowed');
                    document.getElementById('login-btn').disabled = false;
                }
                if(window.app.user) {
                    document.getElementById('login-overlay').classList.add('hidden'); 
                    window.app.renderApp();
                }
            },

            doLogin: () => {
                const id = document.getElementById('login-user').value;
                const pin = document.getElementById('login-pin').value.trim();
                const emp = window.app.data.employees.find(e => String(e.id) === String(id) && String(e.pin).trim() === String(pin));
                if(emp) {
                    window.app.user = emp; localStorage.setItem('n5_v162_user', JSON.stringify(emp));
                    document.getElementById('login-overlay').classList.add('hidden'); 
                    window.app.renderApp();
                    window.app.ui.tab('home');
                } else window.app.ui.showMsg("Sai m√£ PIN!");
            },

            renderApp: () => {
                if(!window.app.user) return;
                document.getElementById('head-user').innerText = window.app.user.name;
                document.getElementById('head-role').innerText = window.app.user.role;
                
                const role = window.app.user.role;
                const isGenAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω', 'K·∫ø to√°n'].includes(role); 
                const isFullAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(role); 
                
                if(isGenAdmin) {
                    document.getElementById('admin-tools').classList.remove('hidden');
                    document.getElementById('btn-approve').classList.toggle('hidden', !isFullAdmin);
                    document.getElementById('btn-reset-score').classList.toggle('hidden', !isFullAdmin);
                }
                window.app.renderDynamic();
                window.app.renderTeam();
            },

            renderDynamic: () => {
                try {
                    const u = window.app.user;
                    if(!u) return;
                    const todayStr = new Date().toISOString().split('T')[0];
                    const role = u.role;
                    const isFullAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(role);

                    if(isFullAdmin) {
                        document.getElementById('admin-task-form').classList.remove('hidden');
                        const houseMulti = document.getElementById('house-multi-select');
                        if (houseMulti && window.app.data.houses.length > 0) {
                            houseMulti.innerHTML = window.app.data.houses.map(h => `<label class="flex items-center gap-1 text-[10px] font-bold bg-white p-2 rounded border shadow-sm"><input type="checkbox" name="h-chk" value="${h.name}"> ${h.name}</label>`).join('');
                        }
                        const assignInd = document.getElementById('assign-ind-zone');
                        if (assignInd && window.app.data.employees && window.app.data.employees.length > 0) {
                            assignInd.innerHTML = window.app.data.employees.map(e => `<label class="flex items-center gap-1 text-[10px] font-bold bg-white p-2 rounded border shadow-sm"><input type="checkbox" name="u-chk" value="${e.id}"> ${e.name}</label>`).join('');
                        }
                    } else {
                        document.getElementById('admin-task-form').classList.add('hidden');
                    }

                    // Fix dropdown
                    const thArea = document.getElementById('th-area');
                    if (thArea && window.app.data.houses.length > 0 && thArea.options.length <= 1) {
                        const saved = thArea.value;
                        thArea.innerHTML = '<option value="">-- Ch·ªçn Nh√† --</option>' + window.app.data.houses.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
                        thArea.value = saved;
                    }
                    const sxHouse = document.getElementById('sx-house-id');
                    if (sxHouse && window.app.data.houses.length > 0 && sxHouse.options.length <= 1) {
                        const saved = sxHouse.value;
                        sxHouse.innerHTML = '<option value="">-- Ch·ªçn Nh√† --</option>' + window.app.data.houses.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
                        sxHouse.value = saved;
                    }

                    // STATS HOME
                    const todayLogs = window.app.data.harvest.filter(h => new Date(h.time).toDateString() === new Date().toDateString());
                    const totalYield = todayLogs.reduce((a,b) => a + (Number(b.total)||0), 0);
                    document.getElementById('stat-yield').innerText = totalYield.toFixed(2);
                    document.getElementById('stat-online').innerText = window.app.data.employees.filter(e=>e.lastLogin === todayStr).length;

                    document.getElementById('house-list').innerHTML = window.app.data.houses.map(h => {
                        const stats = window.app.helpers.getHouseStats(h.name);
                        return `
                        <div class="card border-l-4 border-amber-800 shadow-sm transition active:scale-95">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-black text-sm uppercase text-slate-800">${h.name}</span>
                                <button onclick="app.actions.exportCSVByHouse('${h.name}')" class="text-[9px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded shadow-inner uppercase font-black border">Nh·∫≠t K√Ω</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px] bg-slate-50 p-2 rounded border">
                                <div class="font-bold text-slate-500">PH√îI ƒêANG NU√îI: <br><span class="text-blue-600 text-xs">${stats.qty} t√∫i</span></div>
                                <div class="font-bold text-slate-500">L√î C·∫§Y: <br><span class="text-indigo-600 text-xs">${stats.batch}</span></div>
                                <div class="font-bold text-slate-500 col-span-2 border-t pt-1 mt-1">T·ªîNG THU HO·∫†CH: <span class="text-green-600 text-sm font-black">${stats.totalHarvest} Kg</span></div>
                            </div>
                        </div>`
                    }).join('');

                    // TASKS
                    const filterStart = document.getElementById('task-filter-start').value;
                    const filterEnd = document.getElementById('task-filter-end').value;
                    const filterStatus = document.getElementById('task-filter-status').value;
                    const isGenAdmin = ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω', 'K·∫ø to√°n'].includes(role); 

                    let filteredTasks = window.app.data.tasks.filter(t => {
                        if(!isGenAdmin && String(t.assignee) !== String(u.id)) return false; 
                        if(filterStatus !== 'all' && t.status !== filterStatus) return false;
                        const d = new Date(t.time).toISOString().split('T')[0];
                        if(filterStart && d < filterStart) return false;
                        if(filterEnd && d > filterEnd) return false;
                        return true;
                    });

                    const taskGroup = {};
                    filteredTasks.forEach(t => {
                        const name = window.app.getEmpName(t.assignee);
                        if(!taskGroup[name]) taskGroup[name] = [];
                        taskGroup[name].push(t);
                    });

                    document.getElementById('task-list-grouped').innerHTML = Object.keys(taskGroup).map(name => `
                        <div class="card !p-0 overflow-hidden border-2 border-slate-100">
                            <div class="bg-slate-100 p-2 border-b font-bold text-xs uppercase text-slate-700">${name}</div>
                            <div class="p-2 space-y-2">
                                ${taskGroup[name].map(t => `
                                    <div class="flex justify-between items-center border-b border-dashed pb-2 last:border-0">
                                        <div class="flex-1"><p class="text-[11px] font-bold">${t.title}</p><p class="text-[9px] text-indigo-500 italic">Nh√†: ${t.houseId} | ${new Date(t.time).toLocaleDateString()}</p></div>
                                        <div class="flex gap-1">
                                            ${isFullAdmin ? `<button onclick="app.actions.delTask('${t._id}')" class="w-6 h-6 bg-red-50 text-red-500 rounded"><i class="fas fa-trash text-[10px]"></i></button>` : ''}
                                            ${t.status==='completed' ? '<span class="text-green-600 font-black text-[9px] uppercase border border-green-200 px-1 rounded bg-green-50">Xong</span>' : (String(t.assignee)===String(u.id)?`<button onclick="app.actions.completeTask('${t._id}')" class="bg-blue-600 text-white px-2 py-1 rounded text-[9px] font-bold">XONG</button>`:'<span class="text-slate-400 text-[9px]">ƒê·ª£i</span>')}
                                        </div>
                                    </div>`).join('')}
                            </div>
                        </div>`).join('');

                    // SX LOG
                    document.getElementById('sx-log-list').innerHTML = (window.app.data.production || []).slice().sort((a,b)=>b.time-a.time).slice(0,10).map(l => `
                        <div class="text-[10px] p-2 bg-white mb-1 border rounded-xl flex justify-between shadow-sm border-l-4 ${l.action==='NH·∫¨P'?'border-l-blue-500':'border-l-amber-700'}">
                            <div><span class="font-black ${l.action==='NH·∫¨P'?'text-blue-600':'text-amber-800'}">${l.action} ${l.qty} T√öI - ${l.house}</span><br><span class="text-[9px] text-slate-400">${l.type} | L√¥: ${l.batch}</span></div>
                            <span class="text-[9px] text-slate-400 italic">${l.date}</span>
                        </div>`).join('');

                    window.app.renderLeaderboard();
                    window.app.renderTHTable();
                } catch(e) { console.error("Dynamic Render Error:", e); }
            },

            renderTHTable: () => {
                try {
                    const logs = [...window.app.data.harvest].sort((a,b) => b.time - a.time).slice(0, 15);
                    const el = document.getElementById('harvest-recent-table'); if(!el) return;
                    
                    el.innerHTML = `
                    <table class="log-table shadow-sm mb-6">
                        <thead><tr><th>Ng√†y</th><th>Nh√†</th><th>DABF</th><th>AB</th><th>HT</th><th>T·ªïng</th><th>NV</th></tr></thead>
                        <tbody>${logs.map(l => {
                            const d = l.details || {};
                            const DABF = (Number(d.d1)||0) + (Number(d.a1f)||0) + (Number(d.a2f)||0) + (Number(d.b1f)||0) + (Number(d.b2f)||0);
                            const AB = (Number(d.a1)||0) + (Number(d.a2)||0) + (Number(d.b1)||0) + (Number(d.b2)||0);
                            return `<tr>
                                <td class="text-[8px]">${new Date(l.time).toLocaleDateString()}</td>
                                <td class="font-black text-blue-600">${l.area}</td>
                                <td>${DABF.toFixed(2)}</td>
                                <td>${AB.toFixed(2)}</td>
                                <td class="text-orange-600">${(Number(d.ht)||0).toFixed(2)}</td>
                                <td class="font-black bg-slate-50">${(Number(l.total)||0).toFixed(2)}</td>
                                <td class="text-[8px] uppercase">${l.user}</td>
                            </tr>`}).join('')}
                        </tbody>
                    </table>
                    <p class="label px-1 mt-4 text-blue-600 font-black italic uppercase text-[9px] leading-none mb-1">Xu·∫•t kho t∆∞∆°i (10 ƒë∆°n g·∫ßn nh·∫•t)</p>
                    <table class="log-table shadow-sm mt-2">
                        <thead><tr><th>Kh√°ch</th><th>Chi ti·∫øt</th><th>T·ªïng</th><th>NV</th></tr></thead>
                        <tbody>${[...window.app.data.exports].sort((a,b)=>b.time-a.time).slice(0,10).map(e => {
                            const detStr = Object.entries(e.details||{}).map(([k,v]) => `${k.toUpperCase()}:${v}`).join(', ');
                            return `<tr><td class="font-black">${e.customer}</td><td class="text-[8px] italic max-w-[100px] truncate">${detStr}</td><td class="text-green-600 font-black">${(Number(e.total_qty)||0).toFixed(2)}</td><td class="text-[8px]">${e.user}</td></tr>`
                        }).join('')}</tbody>
                    </table>`;
                } catch(e) { console.error("Render TH Error:", e); }
            },

            // V162: FIX LEADERBOARD EMPTY
            renderLeaderboard: () => {
                try {
                    const el = document.getElementById('leaderboard');
                    if(!window.app.data.employees || window.app.data.employees.length === 0) {
                        el.innerHTML = '<p class="text-center text-slate-400 italic">ƒêang t·∫£i...</p>';
                        return;
                    }
                    el.innerHTML = [...window.app.data.employees].sort((a,b) => (Number(b.score)||0) - (Number(a.score)||0)).slice(0, 5).map((e, i) => `
                        <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg border">
                            <div class="flex items-center gap-2"><span class="w-5 h-5 flex items-center justify-center ${i===0?'bg-yellow-500':'bg-blue-600'} text-white rounded-full text-[9px] font-bold">${i+1}</span><span class="font-bold text-[11px]">${e.name}</span></div>
                            <span class="font-black text-blue-600 text-[11px]">${(Number(e.score)||0)}ƒë</span>
                        </div>`).join('');
                } catch(e) { console.error("Leaderboard Error:", e); }
            },

            renderTeam: () => {
                const list = document.getElementById('team-list');
                if(!list) return;

                if (!window.app.data.employees || window.app.data.employees.length === 0) {
                    list.innerHTML = '<p class="text-center text-slate-400 italic text-[10px] mt-4">ƒêang t·∫£i danh s√°ch nh√¢n s·ª±...</p>';
                    return;
                }

                const isFullAdmin = window.app.user ? ['Gi√°m ƒë·ªëc', 'Qu·∫£n l√Ω'].includes(window.app.user.role) : false;
                
                try {
                    list.innerHTML = window.app.data.employees.map(e => {
                        const avatar = (e.name && e.name.length > 0) ? e.name.charAt(0) : 'U';
                        return `
                        <div class="card flex justify-between items-center !p-3 border-l-4 ${e.lastLogin===new Date().toISOString().split('T')[0]?'border-l-green-500':'border-l-slate-300'}">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-600 border border-white shadow uppercase">${avatar}</div>
                                <div><p class="text-xs font-black uppercase text-slate-700">${e.name} ${isFullAdmin?`<span class="text-[9px] text-red-500">(${e.score||0}ƒë)</span>`:''}</p><p class="text-[8px] text-slate-400 font-bold uppercase">${e.team||'--'}</p></div>
                            </div>
                            ${isFullAdmin ? `<div class="flex gap-1">
                                <button onclick="app.actions.modScore('${e._id}', 5)" class="w-6 h-6 bg-green-100 text-green-600 rounded flex items-center justify-center font-bold text-[10px]">+</button>
                                <button onclick="app.actions.modScore('${e._id}', -5)" class="w-6 h-6 bg-red-100 text-red-600 rounded flex items-center justify-center font-bold text-[10px]">-</button>
                                <button onclick="app.actions.delEmp('${e._id}', '${e.name}')" class="w-6 h-6 bg-slate-200 text-slate-500 rounded flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button>
                            </div>` : ''}
                        </div>`;
                    }).join('');
                } catch (e) { 
                    console.error("Render Team Error:", e); 
                    list.innerHTML = '<p class="text-center text-red-400 italic text-[10px]">L·ªói hi·ªÉn th·ªã danh s√°ch.</p>';
                }
            },

            renderChat: () => {
                const box = document.getElementById('chat-box');
                box.innerHTML = window.app.data.chat.map(m => {
                    const isMe = String(m.senderId) === String(window.app.user.id);
                    if(m.senderId === 'SYSTEM') return `<div class="chat-system">üì¢ ${m.text}</div>`;
                    let reacts = m.reactions ? `<div class="absolute -bottom-2 right-2 bg-white rounded-full px-1 shadow text-[9px] border">${Object.keys(m.reactions).map(k=>k).join('')}</div>` : '';
                    return `<div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}"><div class="text-[9px] text-slate-400 mb-1 px-1 uppercase">${isMe?'':m.senderName}</div><div class="chat-bubble ${isMe ? 'chat-me' : 'chat-other'}">${m.text}${reacts}</div></div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            },
            
            renderApprovals: () => {
                const reqs = window.app.data.hr_requests.filter(r => r.status === 'pending');
                document.getElementById('approval-list').innerHTML = reqs.length ? reqs.map(r => `
                    <div class="bg-slate-50 p-2 border rounded mb-2 text-xs">
                        <p class="font-bold text-blue-600">${r.requester}</p>
                        <p class="italic">${r.type==='LEAVE'?'Xin ngh·ªâ: '+r.content:'Mua: '+r.content}</p>
                        <div class="flex gap-2 mt-2">
                            <button onclick="app.actions.approveReq('${r._id}', 'approved')" class="bg-green-500 text-white px-2 py-1 rounded font-bold">Duy·ªát</button>
                            <button onclick="app.actions.approveReq('${r._id}', 'rejected')" class="bg-red-500 text-white px-2 py-1 rounded font-bold">T·ª´ ch·ªëi</button>
                        </div>
                    </div>`).join('') : '<p class="text-center text-slate-400 italic">Kh√¥ng c√≥ ƒë∆°n m·ªõi</p>';
            },

            actions: {
                logout: () => { localStorage.removeItem('n5_v162_user'); location.reload(); },
                
                pushChatNotify: async (msg) => { await addDoc(collection(db, `${ROOT}/chat`), { text: msg, senderId: 'SYSTEM', senderName: 'H·ªÜ TH·ªêNG', time: Date.now() }); },
                
                createTask: async () => {
                    const title = document.getElementById('task-title').value;
                    const h = Array.from(document.querySelectorAll('#house-multi-select input:checked')).map(i => i.value);
                    const mode = document.getElementById('assign-mode').value;
                    let u = [];
                    
                    if(mode === 'ind') u = Array.from(document.querySelectorAll('#assign-ind-zone input:checked')).map(i => i.value);
                    else {
                        const team = document.querySelector('input[name="team-radio"]:checked').value;
                        u = window.app.data.employees.filter(e => e.team === team).map(e => e.id);
                    }

                    if(!title || !h.length || !u.length) return window.app.ui.showMsg("Thi·∫øu th√¥ng tin!");
                    
                    for(let house of h) for(let uid of u) { 
                        await addDoc(collection(db, `${ROOT}/tasks`), { title, houseId: house, assignee: uid, status: 'pending', time: Date.now() }); 
                    }
                    await window.app.actions.pushChatNotify(`GIAO VI·ªÜC: ${title} (${h.length} nh√†, ${u.length} ng∆∞·ªùi)`);
                    window.app.ui.showMsg("ƒê√£ giao vi·ªác!");
                    document.getElementById('task-title').value = '';
                },

                completeTask: async (id) => {
                    await updateDoc(doc(db, `${ROOT}/tasks`, id), { status: 'completed', finishTime: Date.now() });
                    window.app.ui.showMsg("ƒê√£ xong!");
                },

                delTask: async (id) => { if(confirm("X√≥a vi·ªác n√†y?")) deleteDoc(doc(db, `${ROOT}/tasks`, id)); },

                submitTH: async () => {
                    const area = document.getElementById('th-area').value;
                    if(!area) return window.app.ui.showMsg("Ch·ªçn nh√†!");
                    const d = {}; let total = 0;
                    ['b2','a1','a2','b1','chan','d1','a1f','a2f','b2f','ht'].forEach(id => {
                        const v = Number(document.getElementById('th-'+id).value) || 0;
                        d[id] = v; total += v;
                    });
                    if(total <= 0) return window.app.ui.showMsg("Nh·∫≠p s·ªë l∆∞·ª£ng!");
                    
                    await addDoc(collection(db, `${ROOT}/harvest_logs`), { area, details: d, total, user: window.app.user.name, time: Date.now() });
                    await window.app.actions.modScore(window.app.user._id, 10);
                    await window.app.actions.pushChatNotify(`THU HO·∫†CH: ${window.app.user.name} h√°i ${total}kg t·∫°i ${area}`);
                    window.app.ui.resetTHInputs(); window.app.ui.showMsg("ƒê√£ l∆∞u!");
                },

                submitExport: async () => {
                    const customer = document.getElementById('export-customer-name').value;
                    if(!customer) return window.app.ui.showMsg("Nh·∫≠p t√™n kh√°ch!");
                    const d = {}; let total = 0;
                    ['b2','a1','a2','b1','chan','d1','a1f','a2f','b2f','ht'].forEach(id => {
                        const v = Number(document.getElementById('exp-qty-'+id).value) || 0;
                        if(v > 0) { d[id] = v; total += v; }
                    });
                    if(total <= 0) return window.app.ui.showMsg("Nh·∫≠p s·ªë l∆∞·ª£ng!");
                    
                    await addDoc(collection(db, `${ROOT}/export_logs`), { customer, details: d, total_qty: total, user: window.app.user.name, time: Date.now() });
                    await window.app.actions.pushChatNotify(`XU·∫§T KHO: ${window.app.user.name} b√°n ${total}kg cho ${customer}`);
                    window.app.ui.resetTHInputs(); window.app.ui.showMsg("ƒê√£ xu·∫•t!");
                },

                submitSX: async (action) => {
                    const house = document.getElementById('sx-house-id').value;
                    const type = document.getElementById('sx-type').value;
                    const qty = document.getElementById('sx-qty').value;
                    const batch = document.getElementById('sx-batch').value;
                    const date = document.getElementById('sx-date').value;
                    
                    if(!house || !type || !qty) return window.app.ui.showMsg("Thi·∫øu th√¥ng tin!");
                    await addDoc(collection(db, `${ROOT}/production_logs`), { action, house, type, qty, batch, date, user: window.app.user.name, time: Date.now() });
                    window.app.ui.showMsg("ƒê√£ l∆∞u SX!");
                },

                checkIn: async (shift) => {
                    const today = new Date().toISOString().split('T')[0];
                    await updateDoc(doc(db, `${ROOT}/employees`, window.app.user._id), { lastLogin: today });
                    await addDoc(collection(db, `${ROOT}/attendance_logs`), { date: today, time: Date.now(), user: window.app.user.name, uid: window.app.user.id, shift, team: window.app.user.team });
                    await window.app.actions.modScore(window.app.user._id, 2);
                    window.app.ui.showMsg("ƒê√£ ƒëi·ªÉm danh!");
                    await window.app.actions.pushChatNotify(`ƒêI·ªÇM DANH: ${window.app.user.name} (${shift})`);
                },

                sendChat: async (emoji) => {
                    const txt = emoji || document.getElementById('chat-input').value;
                    if(!txt) return;
                    await addDoc(collection(db, `${ROOT}/chat`), { text: txt, senderId: window.app.user.id, senderName: window.app.user.name, time: Date.now() });
                    document.getElementById('chat-input').value = '';
                },
                
                sendReaction: (icon) => {
                    const lastMsg = window.app.data.chat.filter(m=>m.senderId!=='SYSTEM').pop();
                    if(lastMsg) {
                        const r = lastMsg.reactions || {}; r[icon] = (r[icon]||0)+1;
                        updateDoc(doc(db, `${ROOT}/chat`, lastMsg._id), { reactions: r });
                    }
                },

                // ADMIN ACTIONS V162
                modScore: async (uid, val) => {
                    const e = window.app.data.employees.find(x => x._id === uid);
                    if(e) await updateDoc(doc(db, `${ROOT}/employees`, uid), { score: (Number(e.score)||0) + val });
                },
                
                delEmp: async (id, name) => {
                    if(confirm(`X√≥a nh√¢n s·ª± ${name}? D·ªØ li·ªáu c≈© v·∫´n c√≤n nh∆∞ng kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p.`)) await deleteDoc(doc(db, `${ROOT}/employees`, id));
                },

                resetLeaderboard: async () => {
                    if(confirm("X√≥a s·∫°ch ƒëi·ªÉm thi ƒëua?")) {
                        window.app.data.employees.forEach(e => updateDoc(doc(db, `${ROOT}/employees`, e._id), { score: 0 }));
                        window.app.ui.showMsg("ƒê√£ Reset!");
                    }
                },

                addEmployee: async () => {
                    const n = document.getElementById('new-emp-name').value;
                    const id = document.getElementById('new-emp-id').value;
                    const p = document.getElementById('new-emp-pin').value;
                    if(!n || !id || !p) return window.app.ui.showMsg("Thi·∫øu tin!");
                    await addDoc(collection(db, `${ROOT}/employees`), { 
                        id, name: n, pin: p, 
                        role: document.getElementById('new-emp-role').value, 
                        team: document.getElementById('new-emp-team').value, 
                        score: 0 
                    });
                    window.app.ui.closeModal('modal-add-staff');
                    window.app.ui.showMsg("ƒê√£ th√™m!");
                },

                submitHR: async (type) => {
                    const c = type==='LEAVE'?document.getElementById('leave-date').value:document.getElementById('pur-item').value;
                    await addDoc(collection(db, `${ROOT}/hr_requests`), { type, content: c, requester: window.app.user.name, status: 'pending', time: Date.now() });
                    window.app.ui.showMsg("ƒê√£ g·ª≠i ƒë∆°n!"); window.app.ui.closeModal('modal-leave'); window.app.ui.closeModal('modal-buy');
                    window.app.actions.pushChatNotify(`H√ÄNH CH√çNH: C√≥ ƒë∆°n ${type} m·ªõi t·ª´ ${window.app.user.name}`);
                },
                
                approveReq: async (id, status) => {
                    await updateDoc(doc(db, `${ROOT}/hr_requests`, id), { status });
                    window.app.renderApprovals();
                },

                exportTH: () => {
                    let csv = "NGAY;NHA;TONG_KG;USER\n";
                    window.app.data.harvest.forEach(l => csv += `${new Date(l.time).toLocaleDateString()};${l.area};${l.total};${l.user}\n`);
                    window.app.helpers.downloadCSV(csv, 'BaoCaoTong.csv');
                },
                
                exportAttendance: () => {
                    let csv = "NGAY;GIO;TEN;CA;TO\n";
                    window.app.data.attendance.forEach(l => csv += `${l.date};${new Date(l.time).toLocaleTimeString()};${l.user};${l.shift};${l.team}\n`);
                    window.app.helpers.downloadCSV(csv, 'ChamCong.csv');
                },
                
                exportCSVByHouse: (h) => {
                    let csv = "NGAY;NHA;DABF;AB;TONG;USER\n";
                    window.app.data.harvest.filter(x => x.area === h).forEach(l => {
                        const d = l.details || {};
                        const DABF = (Number(d.d1)||0) + (Number(d.a1f)||0) + (Number(d.a2f)||0) + (Number(d.b1f)||0) + (Number(d.b2f)||0);
                        const AB = (Number(d.a1)||0) + (Number(d.a2)||0) + (Number(d.b1)||0) + (Number(d.b2)||0);
                        csv += `${new Date(l.time).toLocaleDateString()};${l.area};${DABF};${AB};${l.total};${l.user}\n`;
                    });
                    window.app.helpers.downloadCSV(csv, `NhatKy_${h}.csv`);
                }
            }
        };
        window.onload = window.app.init;
    </script>
</body>
</html>
